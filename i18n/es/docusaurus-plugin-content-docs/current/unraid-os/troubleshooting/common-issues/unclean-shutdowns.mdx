---
sidebar_position: 2
sidebar_label: Apagados no limpios
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import UncleanShutdownsPower from "./partials/unclean-shutdowns/unexpected-power-loss.mdx";
import UncleanShutdownsFlash from "./partials/unclean-shutdowns/flash-drive-failure.mdx";
import UncleanShutdownsTerminal from "./partials/unclean-shutdowns/open-terminal-sessions.mdx";

# Apagados no limpios

Un cierre no limpio ocurre cuando Unraid detecta que el %%array|array%% no se detuvo correctamente antes de que el sistema se apagara. Esta situación puede desencadenar una %%parity check|parity-check%% automática durante el próximo arranque para garantizar la integridad de los datos.

:::important[Recommendations para prevenir apagados no limpios]

Tomar algunas medidas proactivas puede ayudarte a evitar o identificar apagados no limpios:

- **Usa un SAI:** Mantén tu servidor conectado a un Sistema de Alimentación Ininterrumpida (SAI) y configúralo para iniciar un apagado controlado cuando la energía de la batería sea baja.
- **Intentar un apagado ordenado:** Si su servidor no responde, presione brevemente el botón de encendido para activar un apagado seguro. No mantenga el botón presionado, ya que esto forzará un apagado duro y provocará un apagado no limpio.
- **Habilitar registro persistente:** Ve a ***Configuración → Servidor de Syslog*** para activar el registro que persiste después de un reinicio. Consulta [Registros persistentes (servidor Syslog)](../diagnostics/capture-diagnostics-and-logs.mdx#persistent-logs-syslog-server) para más detalles.
- **Adjuntar diagnósticos para soporte:** Si ocurre un apagado no limpio, Unraid intentará guardar los diagnósticos en `/log/diagnostics.zip` en su dispositivo de flash. Adjunte este archivo a las publicaciones en el foro cuando busque ayuda.

:::

:::tip[UPS mejores prácticas de configuración]

Un SAI bien configurado es tu mejor defensa contra apagados no limpios causados por pérdida de energía.

- **Conecta el SAI vía USB** a tu servidor Unraid.
- **Habilitar el soporte de SAI** en ***Configuración → Configuración de SAI***.
- **Configurar tiempos de espera de apagado:** Configure el SAI para que desencadene un apagado controlado antes de que la batería se agote. Ajuste los umbrales de "Tiempo restante de la batería" o "Nivel de carga de la batería" para proporcionar tiempo suficiente para que Unraid [detenga el %%array|array%%](../../using-unraid-to/manage-storage/array-configuration.mdx#startstop-the-array) y se apague de forma segura.
- **Prueba tu configuración:** Simula una pérdida de energía para asegurarte de que el SAI y Unraid respondan correctamente.

Consulte el [plugin NUT](https://unraid.net/community/apps/c/plugins/p4?srsltid=AfmBOop675PrJQW4iqb4JBN3GyPpwDDiSmnZReq78t27XyxkFdMX8inO#:~:text=NUT%20%2D%20Network%20UPS%20Tools) para obtener una mayor compatibilidad con modelos UPS más avanzados o hardware no compatible.

:::

## Configuración de tiempos de apagado

Configurar correctamente los tiempos de espera de apagado es esencial para asegurar que su servidor Unraid pueda detener efectivamente todos los servicios, previniendo apagados no limpios, especialmente durante pérdidas de energía o mantenimiento. Cada componente de su sistema - %%VM|vm%%s, contenedores de Docker, y el %%array|array%% general - tiene su propia configuración de tiempo de espera que puede ajustarse.

<Tabs>
  <TabItem value="energía" label="Pérdida de energía inesperada" default>
    <UncleanShutdownsPower />
  </TabItem>

  <TabItem value="flash" label="Fallo de unidad flash">
    <UncleanShutdownsFlash />
  </TabItem>

  <TabItem value="terminal" label="Abrir sesiones de terminal">
    <UncleanShutdownsTerminal />
  </TabItem>
</Tabs>

---

## Tiempo de espera para máquinas virtuales

Configurar correctamente los tiempos de espera de apagado es esencial para asegurar que su servidor Unraid pueda detener todos los servicios de manera efectiva. Esto evita apagados no limpios, especialmente durante cortes de energía o mantenimiento. El paso más importante es configurar sus %%VMs|vm%% para hibernar en lugar de apagarse. Este enfoque ayuda a eliminar muchos problemas relacionados con el tiempo de espera.

### Configuración de hibernación de VM

:::tip[Use Hibernación de VM

Para los apagados más confiables y rápidos, configure sus %%VMs|vm%% para hibernar en lugar de apagarse. Esto es especialmente importante para las %%VMs|vm%% de Windows, pero beneficia a todos los tipos de %%VM|vm%%.

Recomendamos usar la hibernación porque:

- **Guarda el estado de la VM al instante** - No hay que esperar a que el sistema operativo invitado se apague.
- **Previene la pérdida de datos** - Sin riesgo de interrumpir actualizaciones o trabajos no guardados.
- **Evita problemas de tiempo de espera** - La hibernación es casi instantánea.
- **Recuperación más rápida** - Las %%VMs|vm%% se reanudan exactamente donde se quedaron.

El apagado puede ser problemático porque:

- Windows puede mostrar cuadros de diálogo ("¿Guardar este documento?") que detienen el apagado indefinidamente.
- Las actualizaciones de Windows pueden tardar más de 10 minutos durante el apagado.
- Si el tiempo de espera expira, Unraid forzará el cierre de la %%VM|vm%%, lo que podría corromper actualizaciones de Windows en curso, documentos no guardados, datos de aplicaciones y sistemas de archivos en el sistema operativo invitado.

**Requisito crítico:** Asegúrese de que el %%QEMU|qemu%% %%Guest Agent|guest-agent%% esté instalado en la %%VM|vm%% para que la hibernación funcione correctamente.

:::

Para habilitar la hibernación de VM:

<Tabs>
  <TabItem value="windows" label="VMs de Windows" default>
    1. **Descargar %%QEMU|qemu%% %%Guest Agent|guest-agent%%:**
       - Vaya a la [página de descarga de controladores VirtIO](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/).
       - Descargue el archivo `virtio-win.iso` más reciente.

    2. **Instalar en Windows %%VM|vm%%:**
       - Monte la `virtio-win.iso` en su %%VM|vm%%.
       - Ejecute el instalador desde la ISO montada.
       - Instale tanto los controladores %%VirtIO|virtio%% como el %%QEMU|qemu%% %%Guest Agent|guest-agent%%.
       - Reinicie la %%VM|vm%%.

    3. **Configure en Unraid:**
       - Vaya a la configuración de su %%VM|vm%% en la pestaña ***VMs***.
       - Establezca **Acción de apagado** en **Hibernar**.
       - Haga clic en **Aplicar**.
  </TabItem>

  <TabItem value="linux" label="VMs de Linux">
    1. **Instale %%QEMU|qemu%% %%Guest Agent|guest-agent%%:**

    ```bash
    # Ubuntu/Debian
    sudo apt install qemu-guest-agent

    # CentOS/RHEL/Fedora
    sudo yum install qemu-guest-agent
    # or
    sudo dnf install qemu-guest-agent
    ```

    2. **Habilitar el servicio:**
       ```bash
       sudo systemctl enable qemu-guest-agent
       sudo systemctl start qemu-guest-agent
       ```

    3. **Configure en Unraid:**
       - Configure **Acción de apagado** en **Hibernar** en la configuración de su %%VM|vm%%.
  </TabItem>

  <TabItem value="aparato" label="VMs de electrodomésticos">
    Algunas %%VMs|vm%%, como Home Assistant, no permiten la instalación de software adicional. Para estas:

    - Mantenga **Acción de apagado** establecida en **Apagar**.
    - Use valores de tiempo de espera más largos (consulte las recomendaciones de tiempo de espera a continuación).
    - Considere los riesgos de forzar el cierre de estas %%VMs|vm%% durante las actualizaciones.

    :::note[Why appliance VMs are different]
    Appliance %%VMs|vm%% are designed to run specific software and often don't allow the installation of additional packages, such as %%QEMU|qemu%% %%Guest Agent|guest-agent%%. This means hibernation isn't available, so you'll need to rely on proper timeout configuration.
    :::
  </TabItem>
</Tabs>

Ahora, para verificar que tu hibernación funcione, inicia tu %%VM|vm%% y abre algunas aplicaciones. Luego, deténla desde Unraid. Cuando la reinicies, debería reanudarse con todas las aplicaciones aún abiertas.

:::warning[Guest Agente es crítico

Sin el %%QEMU|qemu%% %%Guest Agent|guest-agent%% instalado, la hibernación puede no funcionar correctamente. En ese caso, la %%VM|vm%% volverá al modo de apagado, consumiendo todo el periodo de tiempo de espera.

:::

### Configuración de tiempo de espera

En esta sección, cubriremos cómo configurar los tiempos de espera para varios sistemas y procesos. Esta información es importante para asegurar que sus %%VMs|vm%% y contenedores Docker se apaguen correctamente sin pérdida de datos.

| Configuración                                   | Defecto | Cuándo aumentar                                           | Dónde configurar                                                             |
| ----------------------------------------------- | ------- | --------------------------------------------------------- | ---------------------------------------------------------------------------- |
| Tiempo de espera para apagado de %%VM\|vm%%     | 60s     | 300s si no se usa hibernación y las VMs se bloquean       | ***Configuración → Gestor de VM → Apagado de VM (Avanzado)***                |
| Tiempo de espera para detener contenedor Docker | 10s     | 30s si alguno de los contenedores se bloquea al detenerse | ***Configuración → Docker (Avanzado)***                                      |
| Tiempo de espera general de apagado             | 90s     | 180s si obtienes apagados no limpios, 300s+ con VMs       | ***Configuración → Configuración de Disco → Tiempo de espera para apagado*** |

:::tip[When para aumentar tiempo de espera

Si experimentas apagados anómalos o contenedores que se bloquean durante el apagado, considera aumentar el tiempo de espera general de apagado a **180 segundos** (o **300+ segundos** si tienes múltiples %%VMs|vm%%). Esto da más tiempo a los servicios para apagarse correctamente.

:::

### Secuencia de apagado

Al apagar, el proceso ocurre en el siguiente orden:

1. **Apagado de %%VM|vm%%:** Esto implica tres etapas, y cada una puede tomar hasta el tiempo de espera de la VM:

   - Etapa 1: Reanudar cualquier %%VMs|vm%% pausada
   - Etapa 2: Hibernar %%VMs|vm%% que están configuradas para hibernación
   - Etapa 3: Apagar cualquier %%VMs|vm%% restantes

   Todas las %%VMs|vm%% en cada etapa se procesan al mismo tiempo, lo que significa que el tiempo total de apagado puede calcularse como: tiempo de espera de la VM × 3.

2. **Detener contenedores Docker:** Todos los contenedores se detendrán simultáneamente (tiempo total = tiempo de espera de Docker).

3. **Otros servicios:** Esto incluye tareas como contenedores LXC y complementos de terceros, que generalmente toman unos pocos segundos.

4. **Apagado del array:** Las unidades deben desmontarse y sincronizarse los datos; esto generalmente toma de 15 a 30 segundos.

:::tip[Calculate su tiempo de espera general de apagado

**Fórmula:** Su tiempo de espera general de apagado debe ser mayor que:

```
(VM timeout × 3) + (Docker timeout) + (Other services) + 15-30 seconds
```

**Ejemplo:** Si seguimos la fórmula, se vería así: `(300 × 3) + 30 + 10 + 30 = 970 segundos (más de 16 minutos)`.

**Recomendado:** Al menos **180 segundos (3 minutos)** como mínimo y **300+ segundos (5+ minutos)** si tiene múltiples %%VMs|vm%% o contenedores complejos.

:::

Si todas sus %%VMs|vm%% están configuradas para hibernar en lugar de apagarse, entonces el tiempo de espera de la VM es menos crítico ya que la hibernación es casi inmediata. Podría usar un tiempo de espera de VM más bajo (por ejemplo, 60-120 segundos) como respaldo para cualquier %%VMs|vm%% que no sea compatible con la hibernación.

### Guía detallada de configuración

Esta sección proporciona información detallada sobre cómo configurar los tiempos de espera para diferentes componentes del sistema. Cada configuración de tiempo de espera funciona junta para garantizar que su servidor se apague correctamente sin pérdida de datos.

<Tabs>
  <TabItem value="tiempos de espera de vm" label="Tiempos de espera de VM" default>
    Dónde establecer: ***Configuración → Gestor VM → Apagado VM*** (habilite la vista avanzada)

    **Cómo funciona:**

    - Las %%VMs|vm%% pasan por tres etapas de apagado, cada una consume el tiempo de espera completo de la VM.
    - Todas las %%VMs|vm%% en cada etapa se procesan simultáneamente
    - Tiempo total de apagado de VM = tiempo de espera de VM × 3

    **Problemas comunes:**

    - **Interrupciones de actualización de Windows:** Las actualizaciones durante el apagado pueden corromperse si expira el tiempo de espera.
    - **Trabajo no guardado:** Los cuadros de diálogo que preguntan si desea guardar documentos pueden detener el apagado indefinidamente.
    - **Fallos de hibernación:** %%VMs|vm%% sin el %%QEMU|qemu%% %%Guest Agent|guest-agent%% pueden fallar en hibernar y usar todo el tiempo de espera.

    :::consejo[Recomendaciones de tiempo de espera de VM]

    - **Recomendación principal:** Configure las %%VMs|vm%% para hibernar en lugar de apagar (requiere %%QEMU|qemu%% %%Guest Agent|guest-agent%%).
    - **Si las VMs se bloquean durante el apagado:** Aumente el tiempo de espera a **300 segundos (5 minutos)** para %%VMs|vm%% de Windows.
    - **Actualizaciones de Windows:** Configure Windows para instalar actualizaciones al inicio en lugar de durante el apagado.
    - **Pruebe su configuración:** Detenga manualmente sus %%VMs|vm%% para confirmar que se apagan o hibernan dentro del periodo de tiempo de espera.
      :::

    :::advertencia[No hay tiempo de espera seguro sin hibernación]
    Sin hibernación y %%QEMU|qemu%% %%Guest Agent|guest-agent%%, no existe un tiempo de espera verdaderamente seguro para %%VMs|vm%% de Windows. Los cuadros de diálogo o las instalaciones de actualizaciones en curso podrían hacer que cualquier tiempo de espera sea inadecuado, lo que llevaría a apagados forzosos y riesgo de corrupción de datos.
    :::
  </TabItem>

  <TabItem value="tiempos de espera de Docker" label="Tiempos de espera de Docker">
    Dónde establecer: ***Configuración → Docker*** (habilite la vista avanzada)

    **Cómo funciona:**

    - Los contenedores se detienen en paralelo, por lo que el tiempo total es igual al tiempo de espera de detención de Docker.
    - La mayoría de los contenedores se detienen en 10 segundos, pero algunos pueden necesitar más tiempo.
    - Contenedores complejos con grandes bases de datos u operaciones en curso podrían requerir tiempo adicional.
    - Si el temporizador expira, los contenedores se detienen forzosamente.

    :::consejo[Recomendaciones de tiempo de espera de Docker]

    - Los **10 segundos predeterminados** funcionan bien para la mayoría de los contenedores.
    - **Si los contenedores se bloquean al detenerse:** Aumente el tiempo de espera a **30 segundos**.
    - Monitoree sus contenedores durante el apagado para identificar aquellos que consistentemente necesitan más tiempo.
      :::
  </TabItem>

  <TabItem value="tiempos de espera generales" label="Tiempos de Espera Generales">
    Dónde establecer: ***Configuración → Configuraciones de Disco → Tiempo de espera de apagado***

    **Consideraciones de UPS (factor más crítico):**

    - Su UPS debe proporcionar suficiente tiempo de ejecución para completar toda la secuencia de apagado antes de que se agote la batería.
    - Para **apagado manual**, puede establecer tiempos de espera más largos ya que usted controla cuándo comienza el apagado.
    - Con el **apagado por corte de energía**, su tiempo de espera está limitado por la vida de la batería del UPS.
    - **Pruebe su UPS** simulando un corte de energía para asegurarse de que su servidor se apague limpiamente con tiempo de sobra.

    :::consejo[Recomendaciones de tiempo de espera generales]

    - **Si obtiene apagados no limpios:** Aumente a **180 segundos (3 minutos)** para sistemas sin %%VMs|vm%%.
    - **Para sistemas con %%VMs|vm%%:** Use **300+ segundos (5+ minutos)** si no usa hibernación.
    - **Si usa hibernación:** **180-300 segundos** generalmente son suficientes.
    - Asegúrese de que los tiempos de espera no sean más largos de lo que su UPS pueda soportar durante un corte de energía.
      :::
  </TabItem>

  <TabItem value="terceros" label="Servicios de Terceros">
    **Contenedores LXC:**
    El plugin LXC tiene su propia configuración de tiempo de espera para detener contenedores. Al igual que los contenedores Docker, los contenedores LXC generalmente se detienen en pocos segundos, pero algunos pueden requerir más tiempo. Revise la configuración del plugin LXC para el tiempo de espera de detención del contenedor e incluya este tiempo de espera en su cálculo de tiempo de espera general.

    **Otros servicios:**
    Algunos plugins o servicios personalizados pueden tener sus propios procedimientos de apagado. Consulte la documentación del plugin para configuraciones de tiempo de espera específicas e incorpórelas en sus cálculos.

    **Fórmula actualizada con servicios de terceros:**

    ```
    (VM timeout × 3) + (Docker timeout) + (LXC/other timeouts) + 15-30 seconds
    ```

    **Plugin Dynamix Stop Shell:**
    Si usa con frecuencia sesiones SSH o terminal, las sesiones abiertas pueden impedir apagados limpios porque Unraid espera que se cierren antes de continuar.

    El plugin [Dynamix Stop Shell](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository) ayuda cerrando automáticamente las sesiones bash o SSH persistentes cuando el array se detiene, asegurando un apagado oportuno.

    Puede instalarlo desde [Aplicaciones de la Comunidad (busque "Dynamix Stop Shell")](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository).

    :::consejo[Cuándo usar el plugin]

    - Si tiene regularmente sesiones de terminal abiertas.
    - Para prevenir que sesiones SSH olvidadas retrasen el apagado.
    - Para limpieza automatizada durante el apagado.
      :::

    :::precaución

    - Sea cauteloso si tiene scripts o procesos ejecutándose en sesiones de terminal.
    - Asegúrese de que no haya operaciones de escritura críticas en progreso antes del apagado.
    - El plugin cerrará forzadamente las sesiones, lo que podría interrumpir el trabajo.
      :::
  </TabItem>
</Tabs>
