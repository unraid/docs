---
sidebar_position: 2
sidebar_label: Arrêts imprévus
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# Arrêts imprévus

Un arrêt inopiné se produit lorsque Unraid détecte que le %%array|array%% n'a pas été correctement arrêté avant que le système ne s'éteigne. Cette situation peut déclencher un %%parity check|parity-check%% automatique lors du prochain démarrage pour garantir l'intégrité des données.

:::important[Recommendations pour prévenir les arrêts non propres]

Prendre des mesures proactives peut vous aider à éviter ou à identifier les arrêts imprévus :

- **Utilisez un onduleur** : Gardez votre serveur connecté à un appareil d'alimentation sans interruption (UPS) et configurez-le pour initier un arrêt contrôlé lorsque l'alimentation de la batterie est faible.
- **Tentez un arrêt en douceur :** Si votre serveur ne répond pas, appuyez brièvement sur le bouton d'alimentation pour initier un arrêt sécurisé. Ne maintenez pas le bouton enfoncé, car cela provoquerait une coupure d'alimentation brutale et entraînerait un arrêt inopiné.
- **Activer la journalisation persistante:** Allez dans ***Paramètres → Serveur Syslog*** pour activer la journalisation qui persiste après un redémarrage. Voir [Logs persistants (serveur Syslog)](../diagnostics/capture-diagnostics-and-logs.mdx#persistent-logs-syslog-server) pour plus de détails.
- **Joindre des diagnostics pour le support :** Si un arrêt non sécurisé se produit, Unraid tentera de sauvegarder les diagnostics dans `/log/diagnostics.zip` sur votre périphérique flash. Joignez ce fichier à vos publications dans le forum lorsque vous demandez de l'aide.

:::

:::tip[UPS meilleures pratiques de configuration]

Un onduleur bien configuré est votre meilleure défense contre les arrêts imprévus dus à une perte d'alimentation.

- **Connectez l'onduleur via USB** à votre serveur Unraid.
- **Activez le support de l'onduleur** dans ***Paramètres → Paramètres de l'onduleur***.
- **Configure shutdown timeouts:** Set the UPS to trigger a controlled shutdown before the battery runs low. Adjust the "Battery runtime left" or "Battery charge level" thresholds to provide enough time for Unraid to [stop the %%array|array%%](../../using-unraid-to/manage-storage/array/overview.mdx#startstop-the-array) and power down safely.
- **Testez votre configuration :** Simulez une perte de puissance pour garantir que l'onduleur et Unraid réagissent correctement.

Consultez le [plugin NUT](https://unraid.net/community/apps/c/plugins/p4?srsltid=AfmBOop675PrJQW4iqb4JBN3GyPpwDDiSmnZReq78t27XyxkFdMX8inO#:~:text=NUT%20%2D%20Network%20UPS%20Tools) pour une compatibilité étendue avec des modèles UPS avancés ou du matériel non pris en charge.

:::

## Events that cause unclean shutdowns

Understanding the main triggers for unclean shutdowns helps you prevent them. The following sections cover the most common scenarios and their solutions.

### Perte de puissance inattendue

Les interruptions de courant sont l'une des principales raisons des arrêts non propres. Protégez votre système avec un onduleur configuré correctement qui peut arrêter automatiquement Unraid avant que la batterie ne se décharge.

:::note

Unraid prend en charge la plupart des unités UPS utilisant le protocole %%apcupsd|apcupsd%% (APC et CyberPower sont généralement compatibles). Si votre UPS n'est pas pris en charge, envisagez d'utiliser le plugin Network UPS Tools (NUT) de Community Applications.

:::

### Défaillance du lecteur flash

Le statut de %%array|array%% est stocké sur votre dispositif USB. Si la clé USB devient indisponible ou passe en mode lecture seule, Unraid ne peut pas mettre à jour le statut d'arrêt, même si l'%%array|array%% s'arrête correctement. Cela entraîne la détection d'un arrêt incorrect au prochain démarrage.

### Ouvrir des sessions terminal

Unraid attend que toutes les sessions terminales ou SSH ouvertes se ferment lors de l'arrêt. Si ces sessions restent actives et que le minuteur d'arrêt expire, un arrêt forcé se produit.

:::tip

Le plugin [Dynamix Stop Shell](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository) peut automatiquement fermer les sessions bash ou SSH persistantes, aidant ainsi à garantir une fermeture en douceur. Cependant, soyez prudent si des opérations d'écriture sont en cours sur le %%array|array%%.

:::

---

## Délai des machines virtuelles

La configuration correcte des délais d'arrêt est essentielle pour garantir que votre serveur Unraid peut arrêter tous les services efficacement. Cela prévient les arrêts inappropriés, notamment lors des coupures de courant ou de la maintenance. L'étape la plus importante est de configurer vos %%VMs|vm%% pour hiberner au lieu de s'éteindre. Cette approche aide à éliminer de nombreux problèmes liés aux délais.

### Configuration de l'hibernation VM

:::tip[Use Hibernation VM]

Pour les arrêts les plus fiables et rapides, configurez vos %%VMs|vm%% pour hiberner au lieu de s'éteindre. Ceci est particulièrement important pour les %%VMs|vm%% Windows mais bénéfique pour tous les types de %%VM|vm%%.

Nous recommandons l'hibernation car elle :

- **Sauvegarde l'état de la VM instantanément** - Pas d'attente pour que l'OS invité s'arrête.
- **Préserve la perte de données** - Pas de risque d'interrompre les mises à jour ou le travail non sauvegardé.
- **Évite les problèmes de délai** - L'hibernation est presque instantanée.
- **Récupération plus rapide** - Les %%VMs|vm%% reprennent exactement là où elles se sont arrêtées.

L'arrêt peut poser problème car :

- Windows peut afficher des boîtes de dialogue (« Sauvegarder ce document ? ») qui arrêtent l'arrêt indéfiniment.
- Les mises à jour de Windows peuvent durer plus de 10 minutes pendant l'arrêt.
- Si le délai expire, Unraid tue de force la %%VM|vm%%, ce qui peut corrompre les mises à jour de Windows en cours, les documents non sauvegardés, les données des applications et les systèmes de fichiers dans l'OS invité.

**Critical requirement:** Ensure the %%QEMU|qemu%% %%Guest Agent|guest-agent%% is installed in the %%VM|vm%% for hibernation to function correctly.

:::

Pour activer l'hibernation VM :

<Tabs>
  <TabItem value="windows" label="VMs Windows" default>
    1. **Download %%QEMU|qemu%% %%Guest Agent|guest-agent%%:**
       - Allez sur la [page de téléchargement des pilotes VirtIO](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/).
       - Téléchargez le fichier `virtio-win.iso` le plus récent.

    2. **Installez dans Windows %%VM|vm%% :**
       - Montez le `virtio-win.iso` sur votre %%VM|vm%%.
       - Exécutez le programme d'installation depuis l'ISO monté.
       - Install both %%VirtIO|virtio%% drivers AND %%QEMU|qemu%% %%Guest Agent|guest-agent%%.
       - Redémarrez la %%VM|vm%%.

    3. **Configurez dans Unraid :**
       - Accédez aux paramètres de votre %%VM|vm%% dans l'onglet ***VMs***.
       - Choisissez **Action à l'arrêt** sur **Hiberner**.
       - Cliquez sur **Appliquer**.
  </TabItem>

  <TabItem value="linux" label="VMs Linux">
    1. **Install %%QEMU|qemu%% %%Guest Agent|guest-agent%%:**

    ```bash
    # Ubuntu/Debian
    sudo apt install qemu-guest-agent

    # CentOS/RHEL/Fedora
    sudo yum install qemu-guest-agent
    # or
    sudo dnf install qemu-guest-agent
    ```

    2. **Activez le service :**
       ```bash
       sudo systemctl enable qemu-guest-agent
       sudo systemctl start qemu-guest-agent
       ```

    3. **Configurez dans Unraid :**
       - Choisissez **Action à l'arrêt** sur **Hiberner** dans les paramètres de votre %%VM|vm%%.
  </TabItem>

  <TabItem value="appareil" label="VMs d'appareil">
    Certains %%VMs|vm%%, comme Home Assistant, ne permettent pas l'installation de logiciels supplémentaires. Pour ceux-ci :

    - Gardez **Action à l'arrêt** sur **Éteindre**.
    - Utilisez des valeurs de délai plus longues (voir recommandations de délai ci-dessous).
    - Considérez les risques de tuer ces %%VMs|vm%% de force pendant les mises à jour.

    :::note[Pourquoi les machines virtuelles d'appliance sont différentes]
    Les %%VMs d'appliance|vm%% sont conçues pour exécuter des logiciels spécifiques et n'autorisent souvent pas l'installation de paquets supplémentaires, tels que %%QEMU|qemu%% %%Guest Agent|guest-agent%%. Cela signifie que l'hibernation n'est pas disponible, vous devrez donc vous fier à une configuration correcte du délai d'attente.
    :::
  </TabItem>
</Tabs>

Maintenant pour vérifier que votre hibernation fonctionne, démarrez votre %%VM|vm%% et ouvrez quelques applications. Puis arrêtez-la depuis Unraid. Lorsque vous la redémarrez, elle devrait reprendre avec toutes les applications encore ouvertes.

:::warning[Guest L'agent est critique]

Without the %%QEMU|qemu%% %%Guest Agent|guest-agent%% installed, hibernation may not work properly. In that case, the %%VM|vm%% will revert to shutdown mode, consuming the full timeout period.

:::

---

### Configuration de délai

Dans cette section, nous couvrirons comment configurer les délais pour divers systèmes et processus. Ces informations sont importantes pour s'assurer que vos %%VMs|vm%% et conteneurs Docker s'arrêtent gracieusement sans perte de données.

| Paramètre                           | Par défaut | Quand augmenter                                                    | Où configurer                                             |
| ----------------------------------- | ---------- | ------------------------------------------------------------------ | --------------------------------------------------------- |
| Délai d'arrêt de %%VM\|vm%%         | 60s        | 300s si vous n'utilisez pas l'hibernation et que les VMs plantent. | ***Paramètres → Gestionnaire de VM → Arrêt VM (Avancé)*** |
| Délai d'arrêt des conteneurs Docker | 10s        | 30s si des conteneurs plantent lors de l'arrêt.                    | ***Paramètres → Docker (Avancé)***                        |
| Délai d'arrêt général               | 90s        | 180s si vous avez des arrêts non propres, 300s+ avec VMs.          | ***Paramètres → Paramètres disque → Délai d'arrêt***      |

:::tip[When augmenter les délais]

Si vous rencontrez des arrêts intempestifs ou des conteneurs qui plantent lors de l'arrêt, envisagez d'augmenter le délai d'arrêt général à **180 secondes** (ou **300+ secondes** si vous avez plusieurs %%VMs|vm%%). Cela donne plus de temps aux services pour s'arrêter correctement.

:::

### Séquence d'arrêt

Lorsque l'arrêt est en cours, le processus se déroule dans l'ordre suivant :

1. **Arrêt des %%VMs|vm%% :** Cela implique trois étapes, chacune pouvant prendre jusqu'au délai d'attente de la VM :

   - Étape 1 : Reprendre toutes les %%VMs|vm%% mises en pause
   - Étape 2 : Hiberner les %%VMs|vm%% qui sont configurées pour l'hibernation
   - Étape 3 : Arrêter les %%VMs|vm%% restantes

   Toutes les %%VMs|vm%% à chaque étape sont traitées en même temps, ce qui signifie que le temps total d'arrêt peut être calculé comme : Temps d'attente VM × 3.

2. Docker containers stop simultaneously (total time = Docker timeout).

3. Other services include tasks like LXC containers and third-party plugins, which usually take a few seconds.

4. Array shutdown: drives need to be unmounted and data synced; this typically takes 15-30 seconds.

:::tip[Calculate votre délai d'arrêt général]

**Formule :** Votre délai d'arrêt général doit être supérieur à :

```
(VM timeout × 3) + (Docker timeout) + (Other services) + 15-30 seconds
```

**Exemple :** Selon la formule, cela ressemblerait à ceci : `(300 × 3) + 30 + 10 + 30 = 970 secondes (plus de 16 minutes)`.

**Recommandation :** Au moins **180 secondes (3 minutes)** au minimum et **300+ secondes (5+ minutes)** si vous avez plusieurs %%VMs|vm%% ou des conteneurs complexes.

:::

If all your %%VMs|vm%% are set to hibernate rather than shutting down, then the VM timeout is less critical since hibernation is nearly immediate. You could use a lower VM timeout (for example, 60-120 seconds) as a backup for any %%VMs|vm%% that don't support hibernation.

---

### Guide de configuration détaillé

Cette section fournit des informations détaillées sur la configuration des délais pour différents composants système. Chaque réglage de délai fonctionne ensemble pour garantir que votre serveur s'arrête en douceur sans perte de données.

#### VM timeouts

Configure VM shutdown timeouts in ***Settings → VM Manager → VM Shutdown*** (enable Advanced view).

**Comment ça fonctionne:**

- Les %%VMs|vm%% passent par trois étapes d'arrêt, chacune consommant la totalité du délai de la VM.
- Toutes les %%VMs|vm%% à chaque étape sont traitées simultanément.
- Temps total d'arrêt de la VM = Temps d'attente de la VM × 3

**Problèmes courants :**

- **Interruptions de mise à jour Windows :** Les mises à jour pendant l'arrêt peuvent être corrompues si le délai expire.
- **Travail non sauvegardé :** Les boîtes de dialogue demandant de sauvegarder les documents peuvent arrêter l'arrêt indéfiniment.
- **Hibernation failures:** %%VMs|vm%% without %%QEMU|qemu%% %%Guest Agent|guest-agent%% may fail to hibernate and use full timeout.

:::tip[VM timeout recommendations]

- **Primary recommendation:** Configure %%VMs|vm%% to hibernate instead of shutting down (requires %%QEMU|qemu%% %%Guest Agent|guest-agent%%).
- **Si les VMs plantent lors de l'arrêt :** Augmentez le délai à **300 secondes (5 minutes)** pour les %%VMs|vm%% Windows.
- **Mises à jour Windows :** Configurez Windows pour installer les mises à jour au démarrage plutôt que lors de l'arrêt.
- **Test your setup:** Manually stop your %%VMs|vm%% to confirm they shut down or hibernate within the timeout period.

:::

:::warning[No safe timeout without hibernation]
Without hibernation and %%QEMU|qemu%% %%Guest Agent|guest-agent%%, there isn't a truly safe timeout for Windows %%VMs|vm%%. Dialog boxes or ongoing update installations could render any timeout inadequate, leading to forced shutdowns and data corruption risk.
:::

#### Docker timeouts

Configure Docker container stop timeouts in ***Settings → Docker*** (enable Advanced view).

**Comment ça fonctionne:**

- Les conteneurs sont arrêtés en parallèle, donc le temps total égale le délai d'arrêt de Docker.
- La plupart des conteneurs s'arrêtent en 10 secondes, mais certains peuvent avoir besoin de plus de temps.
- Les conteneurs complexes avec de grandes bases de données ou des opérations en cours pourraient nécessiter plus de temps.
- Si le temps imparti expire, les conteneurs sont arrêtés de force.

:::tip[Docker timeout recommendations]

- Les **10 secondes par défaut** fonctionnent bien pour la plupart des conteneurs.
- **Si les conteneurs plantent à l'arrêt :** Augmentez le délai à **30 secondes**.
- Monitor your containers during shutdown to identify any that consistently need more time.

:::

#### General timeouts

Configure the general shutdown timeout in ***Settings → Disk Settings → Shutdown time-out***.

**UPS considerations (most critical factor):**

- Your UPS must provide enough runtime to complete the full shutdown sequence before battery runs out.
- For **manual shutdown**, you can set longer timeouts since you control when shutdown starts.
- With **power outage shutdown**, your timeout is limited by UPS battery life.
- **Test your UPS** by simulating a power outage to ensure your server shuts down cleanly with time to spare.

:::tip[General timeout recommendations]

- **If you get unclean shutdowns:** Increase to **180 seconds (3 minutes)** for systems without %%VMs|vm%%.
- **For systems with %%VMs|vm%%:** Use **300+ seconds (5+ minutes)** if not using hibernation.
- **If using hibernation:** **180-300 seconds** is usually sufficient.
- Ensure timeouts are not longer than what your UPS can support during a power outage.

:::

#### Third-party services

**LXC containers:**
The LXC plugin has its own timeout setting for stopping containers. Like Docker containers, LXC containers typically stop within a few seconds, but some may require more time. Check the LXC plugin settings for the container stop timeout and include this timeout in your general shutdown timeout calculation.

**Other services:**
Some plugins or custom services may have their own shutdown procedures. Refer to the plugin documentation for specific timeout settings and incorporate them into your calculations.

**Formule mise à jour avec services tiers :**

```
(VM timeout × 3) + (Docker timeout) + (LXC/other timeouts) + 15-30 seconds
```

**Dynamix Stop Shell plugin:**
If you frequently use SSH or terminal sessions, open sessions can prevent clean shutdowns because Unraid waits for them to close before proceeding.

Le plugin [Dynamix Stop Shell](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository) aide en fermant automatiquement les sessions bash ou SSH persistantes lorsque l'array est arrêté, assurant un arrêt en temps opportun.

Vous pouvez l'installer depuis [Applications Communautaires (recherchez "Dynamix Stop Shell")](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository).

:::tip[When to use the plugin]

- Si vous avez régulièrement des sessions terminal ouvertes.
- Pour éviter que des sessions SSH oubliées retardent l'arrêt.
- For automated cleanup during shutdown.

:::

:::caution

- Faites attention si vous avez des scripts ou processus en cours dans les sessions terminal.
- Assurez-vous qu'aucune opération d'écriture critique n'est en cours avant l'arrêt.
- The plugin will forcefully close sessions, which could interrupt work.

:::
