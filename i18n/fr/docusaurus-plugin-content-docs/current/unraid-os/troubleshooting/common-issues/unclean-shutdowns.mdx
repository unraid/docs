---
sidebar_position: 2
sidebar_label: Arrêts imprévus
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# Arrêts imprévus

Un arrêt inopiné se produit lorsque Unraid détecte que le %%array|array%% n'a pas été correctement arrêté avant que le système ne s'éteigne. Cette situation peut déclencher un %%parity check|parity-check%% automatique lors du prochain démarrage pour garantir l'intégrité des données.

:::important[Recommendations pour prévenir les arrêts non propres]

Prendre des mesures proactives peut vous aider à éviter ou à identifier les arrêts imprévus :

- **Utilisez un onduleur** : Gardez votre serveur connecté à un appareil d'alimentation sans interruption (UPS) et configurez-le pour initier un arrêt contrôlé lorsque l'alimentation de la batterie est faible.
- **Tentez un arrêt en douceur :** Si votre serveur ne répond pas, appuyez brièvement sur le bouton d'alimentation pour initier un arrêt sécurisé. Ne maintenez pas le bouton enfoncé, car cela provoquerait une coupure d'alimentation brutale et entraînerait un arrêt inopiné.
- **Activer la journalisation persistante:** Allez dans ***Paramètres → Serveur Syslog*** pour activer la journalisation qui persiste après un redémarrage. Voir [Logs persistants (serveur Syslog)](../diagnostics/capture-diagnostics-and-logs.mdx#persistent-logs-syslog-server) pour plus de détails.
- **Joindre des diagnostics pour le support :** Si un arrêt non sécurisé se produit, Unraid tentera de sauvegarder les diagnostics dans `/log/diagnostics.zip` sur votre périphérique flash. Joignez ce fichier à vos publications dans le forum lorsque vous demandez de l'aide.

:::

:::tip[UPS meilleures pratiques de configuration]

Un onduleur bien configuré est votre meilleure défense contre les arrêts imprévus dus à une perte d'alimentation.

- **Connectez l'onduleur via USB** à votre serveur Unraid.
- **Activez le support de l'onduleur** dans ***Paramètres → Paramètres de l'onduleur***.
- **Configurer les délais d'arrêt :** Configurez l'onduleur pour déclencher un arrêt contrôlé avant que la batterie ne soit faible. Ajustez les seuils de "Durée de la batterie restante" ou de "Niveau de charge de la batterie" pour assurer suffisamment de temps à Unraid pour [arrêter le %%array|array%%](../../using-unraid-to/manage-storage/array/overview.mdx#startstop-the-array) et s'éteindre en toute sécurité.
- **Testez votre configuration :** Simulez une perte de puissance pour garantir que l'onduleur et Unraid réagissent correctement.

Consultez le [plugin NUT](https://unraid.net/community/apps/c/plugins/p4?srsltid=AfmBOop675PrJQW4iqb4JBN3GyPpwDDiSmnZReq78t27XyxkFdMX8inO#:~:text=NUT%20%2D%20Network%20UPS%20Tools) pour une compatibilité étendue avec des modèles UPS avancés ou du matériel non pris en charge.

:::

## Événements qui causent des arrêts incorrects

Comprendre les principaux déclencheurs des arrêts incorrects vous aide à les prévenir. Les sections suivantes couvrent les scénarios les plus courants et leurs solutions.

### Perte de puissance inattendue

Les interruptions de courant sont l'une des principales raisons des arrêts non propres. Protégez votre système avec un onduleur configuré correctement qui peut arrêter automatiquement Unraid avant que la batterie ne se décharge.

:::note

Unraid prend en charge la plupart des unités UPS utilisant le protocole %%apcupsd|apcupsd%% (APC et CyberPower sont généralement compatibles). Si votre UPS n'est pas pris en charge, envisagez d'utiliser le plugin Network UPS Tools (NUT) de Community Applications.

:::

### Défaillance du lecteur flash

Le statut de %%array|array%% est stocké sur votre dispositif USB. Si la clé USB devient indisponible ou passe en mode lecture seule, Unraid ne peut pas mettre à jour le statut d'arrêt, même si l'%%array|array%% s'arrête correctement. Cela entraîne la détection d'un arrêt incorrect au prochain démarrage.

### Ouvrir des sessions terminal

Unraid attend que toutes les sessions terminales ou SSH ouvertes se ferment lors de l'arrêt. Si ces sessions restent actives et que le minuteur d'arrêt expire, un arrêt forcé se produit.

:::tip

Le plugin [Dynamix Stop Shell](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository) peut automatiquement fermer les sessions bash ou SSH persistantes, aidant ainsi à garantir une fermeture en douceur. Cependant, soyez prudent si des opérations d'écriture sont en cours sur le %%array|array%%.

:::

---

## Délai des machines virtuelles

La configuration correcte des délais d'arrêt est essentielle pour garantir que votre serveur Unraid peut arrêter tous les services efficacement. Cela prévient les arrêts inappropriés, notamment lors des coupures de courant ou de la maintenance. L'étape la plus importante est de configurer vos %%VMs|vm%% pour hiberner au lieu de s'éteindre. Cette approche aide à éliminer de nombreux problèmes liés aux délais.

### Configuration de l'hibernation VM

:::tip[Use Hibernation VM]

Pour les arrêts les plus fiables et rapides, configurez vos %%VMs|vm%% pour hiberner au lieu de s'éteindre. Ceci est particulièrement important pour les %%VMs|vm%% Windows mais bénéfique pour tous les types de %%VM|vm%%.

Nous recommandons l'hibernation car elle :

- **Sauvegarde l'état de la VM instantanément** - Pas d'attente pour que l'OS invité s'arrête.
- **Préserve la perte de données** - Pas de risque d'interrompre les mises à jour ou le travail non sauvegardé.
- **Évite les problèmes de délai** - L'hibernation est presque instantanée.
- **Récupération plus rapide** - Les %%VMs|vm%% reprennent exactement là où elles se sont arrêtées.

L'arrêt peut poser problème car :

- Windows peut afficher des boîtes de dialogue (« Sauvegarder ce document ? ») qui arrêtent l'arrêt indéfiniment.
- Les mises à jour de Windows peuvent durer plus de 10 minutes pendant l'arrêt.
- Si le délai expire, Unraid tue de force la %%VM|vm%%, ce qui peut corrompre les mises à jour de Windows en cours, les documents non sauvegardés, les données des applications et les systèmes de fichiers dans l'OS invité.

**Critical requirement:** Ensure the %%QEMU|qemu%% %%Guest Agent|guest-agent%% is installed in the %%VM|vm%% for hibernation to function correctly.

:::

Pour activer l'hibernation VM :

<Tabs>
  <TabItem value="windows" label="VMs Windows" default>
    1. **Download %%QEMU|qemu%% %%Guest Agent|guest-agent%%:**
       - Allez sur la [page de téléchargement des pilotes VirtIO](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/).
       - Téléchargez le fichier `virtio-win.iso` le plus récent.

    2. **Installez dans Windows %%VM|vm%% :**
       - Montez le `virtio-win.iso` sur votre %%VM|vm%%.
       - Exécutez le programme d'installation depuis l'ISO monté.
       - Install both %%VirtIO|virtio%% drivers AND %%QEMU|qemu%% %%Guest Agent|guest-agent%%.
       - Redémarrez la %%VM|vm%%.

    3. **Configurez dans Unraid :**
       - Accédez aux paramètres de votre %%VM|vm%% dans l'onglet ***VMs***.
       - Choisissez **Action à l'arrêt** sur **Hiberner**.
       - Cliquez sur **Appliquer**.
  </TabItem>

  <TabItem value="linux" label="VMs Linux">
    1. **Install %%QEMU|qemu%% %%Guest Agent|guest-agent%%:**

    ```bash
    # Ubuntu/Debian
    sudo apt install qemu-guest-agent

    # CentOS/RHEL/Fedora
    sudo yum install qemu-guest-agent
    # or
    sudo dnf install qemu-guest-agent
    ```

    2. **Activez le service :**
       ```bash
       sudo systemctl enable qemu-guest-agent
       sudo systemctl start qemu-guest-agent
       ```

    3. **Configurez dans Unraid :**
       - Choisissez **Action à l'arrêt** sur **Hiberner** dans les paramètres de votre %%VM|vm%%.
  </TabItem>

  <TabItem value="appareil" label="VMs d'appareil">
    Certains %%VMs|vm%%, comme Home Assistant, ne permettent pas l'installation de logiciels supplémentaires. Pour ceux-ci :

    - Gardez **Action à l'arrêt** sur **Éteindre**.
    - Utilisez des valeurs de délai plus longues (voir recommandations de délai ci-dessous).
    - Considérez les risques de tuer ces %%VMs|vm%% de force pendant les mises à jour.

    :::note[Pourquoi les machines virtuelles d'appliance sont différentes]
    Les %%VMs d'appliance|vm%% sont conçues pour exécuter des logiciels spécifiques et n'autorisent souvent pas l'installation de paquets supplémentaires, tels que %%QEMU|qemu%% %%Guest Agent|guest-agent%%. Cela signifie que l'hibernation n'est pas disponible, vous devrez donc vous fier à une configuration correcte du délai d'attente.
    :::
  </TabItem>
</Tabs>

Maintenant pour vérifier que votre hibernation fonctionne, démarrez votre %%VM|vm%% et ouvrez quelques applications. Puis arrêtez-la depuis Unraid. Lorsque vous la redémarrez, elle devrait reprendre avec toutes les applications encore ouvertes.

:::warning[Guest L'agent est critique]

Without the %%QEMU|qemu%% %%Guest Agent|guest-agent%% installed, hibernation may not work properly. In that case, the %%VM|vm%% will revert to shutdown mode, consuming the full timeout period.

:::

---

### Configuration de délai

Dans cette section, nous couvrirons comment configurer les délais pour divers systèmes et processus. Ces informations sont importantes pour s'assurer que vos %%VMs|vm%% et conteneurs Docker s'arrêtent gracieusement sans perte de données.

| Paramètre                           | Par défaut | Quand augmenter                                                    | Où configurer                                             |
| ----------------------------------- | ---------- | ------------------------------------------------------------------ | --------------------------------------------------------- |
| Délai d'arrêt de %%VM\|vm%%         | 60s        | 300s si vous n'utilisez pas l'hibernation et que les VMs plantent. | ***Paramètres → Gestionnaire de VM → Arrêt VM (Avancé)*** |
| Délai d'arrêt des conteneurs Docker | 10s        | 30s si des conteneurs plantent lors de l'arrêt.                    | ***Paramètres → Docker (Avancé)***                        |
| Délai d'arrêt général               | 90s        | 180s si vous avez des arrêts non propres, 300s+ avec VMs.          | ***Paramètres → Paramètres disque → Délai d'arrêt***      |

:::tip[When augmenter les délais]

Si vous rencontrez des arrêts intempestifs ou des conteneurs qui plantent lors de l'arrêt, envisagez d'augmenter le délai d'arrêt général à **180 secondes** (ou **300+ secondes** si vous avez plusieurs %%VMs|vm%%). Cela donne plus de temps aux services pour s'arrêter correctement.

:::

### Séquence d'arrêt

Lorsque l'arrêt est en cours, le processus se déroule dans l'ordre suivant :

1. **Arrêt des %%VMs|vm%% :** Cela implique trois étapes, chacune pouvant prendre jusqu'au délai d'attente de la VM :

   - Étape 1 : Reprendre toutes les %%VMs|vm%% mises en pause
   - Étape 2 : Hiberner les %%VMs|vm%% qui sont configurées pour l'hibernation
   - Étape 3 : Arrêter les %%VMs|vm%% restantes

   Toutes les %%VMs|vm%% à chaque étape sont traitées en même temps, ce qui signifie que le temps total d'arrêt peut être calculé comme : Temps d'attente VM × 3.

2. Les conteneurs Docker s'arrêtent simultanément (temps total = délai d'attente Docker).

3. Les autres services incluent des tâches telles que les conteneurs LXC et les plugins tiers, qui prennent généralement quelques secondes.

4. Arrêt de l'array : les disques doivent être démontés et les données synchronisées ; cela prend généralement 15 à 30 secondes.

:::tip[Calculate votre délai d'arrêt général]

**Formule :** Votre délai d'arrêt général doit être supérieur à :

```
(VM timeout × 3) + (Docker timeout) + (Other services) + 15-30 seconds
```

**Exemple :** Selon la formule, cela ressemblerait à ceci : `(300 × 3) + 30 + 10 + 30 = 970 secondes (plus de 16 minutes)`.

**Recommandation :** Au moins **180 secondes (3 minutes)** au minimum et **300+ secondes (5+ minutes)** si vous avez plusieurs %%VMs|vm%% ou des conteneurs complexes.

:::

Si tous vos %%VMs|vm%% sont réglés pour hiberner plutôt que de s'éteindre, alors le délai d'attente de la VM est moins critique puisque l'hibernation est presque immédiate. Vous pouvez utiliser un délai d'attente plus court pour les VM (par exemple, 60-120 secondes) comme sauvegarde pour les %%VMs|vm%% qui ne prennent pas en charge l'hibernation.

---

### Guide de configuration détaillé

Cette section fournit des informations détaillées sur la configuration des délais pour différents composants système. Chaque réglage de délai fonctionne ensemble pour garantir que votre serveur s'arrête en douceur sans perte de données.

#### Delais d'attente pour les VM

Configurer les délais d'arrêt des VM dans ***Paramètres → Gestionnaire de VM → Arrêt de la VM*** (activer la vue avancée).

**Comment ça fonctionne:**

- Les %%VMs|vm%% passent par trois étapes d'arrêt, chacune consommant la totalité du délai de la VM.
- Toutes les %%VMs|vm%% à chaque étape sont traitées simultanément.
- Temps total d'arrêt de la VM = Temps d'attente de la VM × 3

**Problèmes courants :**

- **Interruptions de mise à jour Windows :** Les mises à jour pendant l'arrêt peuvent être corrompues si le délai expire.
- **Travail non sauvegardé :** Les boîtes de dialogue demandant de sauvegarder les documents peuvent arrêter l'arrêt indéfiniment.
- **Hibernation failures:** %%VMs|vm%% without %%QEMU|qemu%% %%Guest Agent|guest-agent%% may fail to hibernate and use full timeout.

:::tip[VM recommandations de délai d'attente]

- **Primary recommendation:** Configure %%VMs|vm%% to hibernate instead of shutting down (requires %%QEMU|qemu%% %%Guest Agent|guest-agent%%).
- **Si les VMs plantent lors de l'arrêt :** Augmentez le délai à **300 secondes (5 minutes)** pour les %%VMs|vm%% Windows.
- **Mises à jour Windows :** Configurez Windows pour installer les mises à jour au démarrage plutôt que lors de l'arrêt.
- **Testez votre configuration :** Arrêtez manuellement vos %%VMs|vm%% pour confirmer qu'elles s'arrêtent ou hibernent dans le délai imparti.

:::

:::warning[No délai d'attente sécuritaire sans hibernation]
Without hibernation and %%QEMU|qemu%% %%Guest Agent|guest-agent%%, there isn't a truly safe timeout for Windows %%VMs|vm%%. Dialog boxes or ongoing update installations could render any timeout inadequate, leading to forced shutdowns and data corruption risk.
:::

#### Délais d'attente Docker

Configurer les délais d'arrêt des conteneurs Docker dans ***Paramètres → Docker*** (activer la vue avancée).

**Comment ça fonctionne:**

- Les conteneurs sont arrêtés en parallèle, donc le temps total égale le délai d'arrêt de Docker.
- La plupart des conteneurs s'arrêtent en 10 secondes, mais certains peuvent avoir besoin de plus de temps.
- Les conteneurs complexes avec de grandes bases de données ou des opérations en cours pourraient nécessiter plus de temps.
- Si le temps imparti expire, les conteneurs sont arrêtés de force.

:::tip[Docker recommandations de délai d'attente]

- Les **10 secondes par défaut** fonctionnent bien pour la plupart des conteneurs.
- **Si les conteneurs plantent à l'arrêt :** Augmentez le délai à **30 secondes**.
- Surveillez vos conteneurs lors de l'arrêt pour identifier ceux qui nécessitent systématiquement plus de temps.

:::

#### Délais d'attente généraux

Configurer le délai d'arrêt général dans ***Paramètres → Paramètres du disque → Délai d'arrêt***.

**Considérations d'onduleur (facteur le plus critique) :**

- Votre onduleur doit fournir une autonomie suffisante pour compléter la séquence d'arrêt complète avant que la batterie ne soit épuisée.
- Pour un **arrêt manuel**, vous pouvez définir des délais plus longs puisque vous contrôlez quand l'arrêt commence.
- Avec un **arrêt en cas de panne de courant**, votre délai est limité par la durée de vie de la batterie de l'onduleur.
- **Testez votre onduleur** en simulant une panne de courant pour vous assurer que votre serveur s'éteint proprement avec du temps à revendre.

:::tip[General recommandations de délai d'attente]

- **Si vous rencontrez des arrêts non propres :** Augmentez à **180 secondes (3 minutes)** pour les systèmes sans %%VMs|vm%%.
- **Pour les systèmes avec %%VMs|vm%% :** Utilisez **300+ secondes (5+ minutes)** si l'hibernation n'est pas utilisée.
- **Si vous utilisez l'hibernation :** **180-300 secondes** est généralement suffisant.
- Assurez-vous que les délais d'attente ne sont pas plus longs que ce que votre onduleur peut supporter lors d'une panne de courant.

:::

#### Services tiers

**Conteneurs LXC :**
Le plugin LXC a son propre paramètre de délai d'attente pour l'arrêt des conteneurs. Comme les conteneurs Docker, les conteneurs LXC s'arrêtent généralement en quelques secondes, mais certains peuvent nécessiter plus de temps. Vérifiez les paramètres du plugin LXC pour le délai d'arrêt des conteneurs et incluez ce délai dans votre calcul de délai d'arrêt général.

**Autres services :**
Certains plugins ou services personnalisés peuvent avoir leurs propres procédures d'arrêt. Référez-vous à la documentation du plugin pour les paramètres spécifiques de délai d'attente et intégrez-les dans vos calculs.

**Formule mise à jour avec services tiers :**

```
(VM timeout × 3) + (Docker timeout) + (LXC/other timeouts) + 15-30 seconds
```

**Plugin Dynamix Stop Shell :**
Si vous utilisez fréquemment SSH ou des sessions terminal, les sessions ouvertes peuvent empêcher des arrêts propres car Unraid attend qu'elles se ferment avant de poursuivre.

Le plugin [Dynamix Stop Shell](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository) aide en fermant automatiquement les sessions bash ou SSH persistantes lorsque l'array est arrêté, assurant un arrêt en temps opportun.

Vous pouvez l'installer depuis [Applications Communautaires (recherchez "Dynamix Stop Shell")](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository).

:::tip[When pour utiliser le plugin]

- Si vous avez régulièrement des sessions terminal ouvertes.
- Pour éviter que des sessions SSH oubliées retardent l'arrêt.
- Pour un nettoyage automatisé lors de l'arrêt.

:::

:::caution

- Faites attention si vous avez des scripts ou processus en cours dans les sessions terminal.
- Assurez-vous qu'aucune opération d'écriture critique n'est en cours avant l'arrêt.
- Le plugin fermera les sessions de manière forcée, ce qui pourrait interrompre le travail.

:::
