# Version 6.12.4 2023-08-31

## Notes de mise à niveau

### Problèmes connus

Veuillez consulter les [notes de version 6.12.0](6.12.0.md#known-issues) pour les problèmes connus généraux.

### Rétrogradation

Avant de revenir à une version antérieure, il est important de s'assurer que le "Bridging" est activé :

- ***Paramètres > Paramètres réseau > eth0 > Activer le "Bridging"*** = Oui

Ensuite, démarrez l'ensemble (ainsi que les services Docker et VM) pour mettre à jour vos conteneurs Docker, vos VMs et
tunnels WireGuard à leurs réglages précédents qui devraient fonctionner dans les versions anciennes.

Une fois dans l'ancienne version, confirmez que ces paramètres sont corrects pour votre configuration :

- ***Paramètres > Docker > Accès de l'hôte aux réseaux personnalisés***
- ***Paramètres > Docker > Type de réseau personnalisé Docker***

Si vous revenez à une version antérieure à 6.12.0, consultez également les [notes de version 6.12.0](6.12.0.md#rolling-back).

## Correction pour les traces d'appel macvlan

La grande nouvelle dans cette version est que nous avons résolu les problèmes liés aux traces d'appel macvlan et aux plantages !

La source du problème est que macvlan utilisé pour les réseaux Docker personnalisés est peu fiable lorsque l'interface parente est un pont (comme br0), il fonctionne mieux sur une interface physique (comme eth0) ou un lien (comme bond0). Nous pensons que c'est un problème de noyau de longue date et avons publié un [rapport de bug](https://bugzilla.kernel.org/show_bug.cgi?id=217777).

Si vous recevez des traces d'appels liées à macvlan, en premier lieu, nous vous recommandons de naviguer vers ***Paramètres > Docker***, de passer en vue avancée et de changer le "Type de réseau Docker personnalisé" de macvlan à ipvlan. C'est la configuration par défaut qu'Unraid a livré depuis la version 6.11.5 et devrait fonctionner pour la plupart des systèmes. Si vous êtes satisfait de ce réglage, vous avez terminé ! Vous n'aurez plus de traces d'appels liées à macvlan et pouvez passer à [la section suivante](#system-drivers-page).

Cependant, certains utilisateurs ont signalé des problèmes avec le transfert de port depuis certains routeurs (Fritzbox) et une fonctionnalité réduite
avec les outils de gestion de réseau avancés (Ubiquity) en mode ipvlan.

Pour ces utilisateurs, nous avons une nouvelle méthode qui reconfigure le réseau pour éviter les problèmes avec macvlan. Ajustez quelques paramètres et vos conteneurs Docker, VMs, et tunnels WireGuard devraient s'ajuster automatiquement pour les utiliser :

- ***Paramètres > Paramètres réseau > eth0 > Activer l'Aggrégation de liens*** = Oui ou Non, les deux fonctionnent avec cette solution
- ***Paramètres > Paramètres réseau > eth0 > Activer le "Bridging"*** = Non (cela activera automatiquement le macvlan)
- ***Paramètres > Docker > Accès de l'hôte aux réseaux personnalisés*** = Activé

Remarque : si vous avez précédemment utilisé la [méthode de segmentation 2-nics pour Docker](https://forums.unraid.net/topic/137048-guide-how-to-solve-macvlan-and-ipvlan-issues-with-containers-on-a-custom-network/),
vous voudrez également revenir en arrière :

- ***Paramètres > Docker > Réseau personnalisé sur l'interface eth0 ou bond0*** (c'est-à-dire s'assurer que eth0/bond0 est configuré pour le réseau personnalisé, pas eth1/bond1)

Lorsque vous démarrez l'ensemble, l'hôte, les VMs et les conteneurs Docker pourront tous communiquer, et il ne devrait plus y avoir de traces d'appel !

### Dépannage

- Si vos conteneurs Docker avec des IP personnalisées ne démarrent pas, éditez-les et changez le "Type de réseau" pour "Personnalisé : eth0" ou "Personnalisé : bond0". Nous avons tenté de le faire automatiquement, mais selon la personnalisation, vous devrez peut-être le faire manuellement.
- Si vos VMs rencontrent des problèmes réseau, modifiez-les et réglez la Source Réseau sur "vhost0". Assurez-vous également qu'une adresse MAC est assignée.
- Si vos tunnels WireGuard ne démarrent pas, apportez une modification factice à chaque tunnel et enregistrez.
- Si vous rencontrez des problèmes de redirection de port vers des conteneurs Docker (en particulier avec un routeur Fritzbox), supprimez et recréez la redirection de port dans votre routeur.

### Pour approfondir un peu plus...

Après la mise à niveau vers cette version, si le pontage demeure activé sur eth0, tout fonctionne comme auparavant. Vous pouvez tenter de contourner les traces d'appels en désactivant le réseau Docker personnalisé, ou en utilisant ipvlan au lieu de macvlan, ou en utilisant la méthode de segmentation Docker à 2 cartes réseau avec des conteneurs sur eth1.

Avec cette version, lorsque vous désactivez le pontage sur eth0, nous créons un nouveau réseau macvtap que les conteneurs Docker et VMs peuvent utiliser. Il a un parent de eth0 au lieu de br0, ce qui nous permet d'éviter les traces d'appels.

Un avantage secondaire est que les réseaux macvtap sont réputés plus rapides que les réseaux pontés, vous pourriez donc observer des améliorations de vitesse lors de
la communication avec les conteneurs Docker et les VMs.

Pour information : avec le pontage désactivé pour l'interface principale (eth0), alors le type de réseau personnalisé Docker sera réglé sur macvlan et masqué, sauf s'il y a d'autres interfaces sur votre système où le pontage est activé, auquel cas l'option ipvlan légataire est disponible. Pour utiliser le nouveau correctif discuté ici, vous voudrez garder cela réglé sur macvlan.

## Page des pilotes système

Naviguez vers ***Outils > Pilotes Système*** pour avoir une vision des pilotes disponibles/en cours d'utilisation sur votre système. Les pilotes tiers installés par les plugins (comme NVIDIA et Realtek) possèdent une icône qui lie à la page de support pour ce pilote. Vous pouvez également maintenant ajouter/modifier/supprimer le fichier de configuration modeprobe.d pour n'importe quel pilote sans avoir à trouver ce fichier sur votre clé flash.

## Autres corrections de bogues et améliorations

- Cette version résout des cas particuliers dans la mise en réseau, Libvirt, Docker, WireGuard, NTP, NGINX, NFS et RPC. Et inclut une amélioration du gestionnaire de VM pour qu'il conserve le mot de passe VNC lors d'une mise à jour.

- Le processus d'arrêt a été modifié pour permettre au plugin NUT de bien éteindre le système.

- Le temps d'affichage des notifications avant fermeture automatique est maintenant configurable (voir ***Paramètres > Paramètres de notification***).

- Une petite modification est que les paquets dans /boot/extra sont désormais traités davantage comme des paquets installés par des plugins, et l'installation est consignée dans le syslog plutôt que sur la console.

- Le processus de mise à jour du système d'exploitation mettra automatiquement à jour le script Helper-Update-Plugin si nécessaire.

## Modifications par rapport à la [version 6.12.3](6.12.3.md)

### Distro de base

- create\_network\_ini :
  - correctif pour le hook DHCP
  - amélioration de la collecte d'adresses IP
- diagnostics :
  - Ajout de la version Unraid précédente au fichier txt des diagnostics.
  - Ajout de ntp.conf, sshd.config et servers.conf (avec des URLs anonymisées)
  - anonymisation des adresses IP
- docker :
  - ajout du routage lorsque le réseau shim ou macvtap est utilisé
  - correction du routage lorsque "accès de l'hôte" est activé
  - suppression de l'IPv6 de l'interface shim/vhost (certains routeurs sont incompatibles)
- libvirt, nginx, nfs, rpc : détection de processus en cours modifiée
- nfsclient : lancement de la négociation avec v4, désactivation de la modification atime
- rc.6 : laissez /usr et /lib montés pendant l'arrêt
- rc.docker :
  - création du même réseau IPv6 pour les conteneurs et les services
  - ajout de plus de journalisation lors de l'arrêt de dockerd
- rc.inet1 :
  - ne pas utiliser le mode promiscuité pour le "Bridging"
  - ajouter l'option persistante à dhcpcd
- rc.library : interfaces toujours listées dans le même ordre, corrige l'affichage ipv6
- rc.libvirt : retirer la surveillance 'itco' du XML si présent
- rc.local : annoter le fichier auto-généré /etc/modprobe.d/zfs.conf
- rc.services :
  - ajout de journalisation
  - exclure les tunnels WireGuard "VPN accès canalisé pour docker" des services
  - exclure les tunnels WireGuard pour ntp (optimisation du code)

#### Mises à jour des packages

- btrfs-progs : 6.3.3
- curl : version 8.2.0 (CVE-2023-32001)
- firefox : version 117.0.r20230824132758 (AppImage)
- kernel-firmware : version 20230724\_59fbffa
- krb5 : version 1.19.2 (CVE-2023-36054)
- openssh : version 9.3p2 (CVE-2023-38408)
- openssl : version 1.1.1v (CVE-2023-3817 CVE-2023-3446)
- samba : version 4.17.10 (CVE-2023-3496 CVE-2022-2127 CVE-2023-34968 CVE-2023-3496 CVE-2023-3347)

### Noyau Linux

- version 6.1.49 (CVE-2023-20593)
- CONFIG\_SCSI\_MPI3MR: Pilote de contrôleur de stockage MPI3 Broadcom

### WebGUI

- Tableau de bord : masquez la barre ZFS lorsqu’aucun ZFS n’est utilisé
- Paramètres Docker : corrigez les tailles de sous-réseau
- Commentaires : restructurez le script de commentaires
- Paramètres réseau : corrigez les paramètres DNS parfois disparus
- Notifications : nouvelle option de notification : temps de fermeture automatique, par défaut à 5 secondes
- Pools : espace libre minimum : uniquement activé lorsque l'ensemble est arrêté
- Partages et Pools : montrez "Espace libre minimum" comme nombre absolu au lieu de pourcentage
- Pilotes Système : nouvelle page
- Traductions : taillez la clé et la valeur dans les fichiers de langue
- Gestionnaire de VM : Conservez le mot de passe VNC pendant la mise à jour.
- Gestionnaire de VM : supprimez les fichiers ".vv" téléchargés.
- CSS : définissez overflow-x sur 'auto'
- mettre à jour le monitor\_nchan

## Correctifs

Avec le plugin Unraid Patch installé, visitez ***Outils → Unraid Patch*** pour obtenir les correctifs / corrections à chaud suivants :

- Un sous-ensemble de mises à jour de sécurité, voir [ce blog post](https://unraid.net/blog/cvd) pour les détails. Nous recommandons de mettre à niveau vers la dernière version stable pour des mises à jour de sécurité supplémentaires.
