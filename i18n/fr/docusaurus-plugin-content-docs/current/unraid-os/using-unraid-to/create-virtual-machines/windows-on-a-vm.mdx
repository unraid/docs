---
sidebar_position: 3
sidebar_label: Windows sur une VM
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import WindowsVirtioAutomatic from './partials/windows-virtio-automatic.mdx';
import WindowsVirtioManual from './partials/windows-virtio-manual.mdx';
import WindowsUpgradeInPlace from './partials/windows-upgrade-in-place.mdx';
import WindowsUpgradeCleanInstall from './partials/windows-upgrade-clean-install.mdx';

# Windows sur une VM

Windows est l'un des systèmes d'exploitation invités les plus populaires pour les utilisateurs d'Unraid, en particulier pour les jeux, la productivité et le support des applications héritées. Voici des considérations essentielles pour exécuter Windows %%VM|vm%%.

:::caution[Before vous commencez]
- Microsoft a mis fin au support de Windows 7 en janvier 2020, de Windows 8.1 en janvier 2023, et de Windows 10 en octobre 2025. Utilisez Windows 11 (ou plus récent) ou Server 2022 (ou plus récent) pour des mises à jour de sécurité continues.
- Testez toujours la stabilité de votre %%VM|vm%% avant d'activer votre licence Windows.
- Pour le passage du %%GPU|gpu-passthrough%%, utilisez le BIOS %%OVMF|ovmf%% (%%UEFI|uefi%%) avec Windows 11 ou plus récent.
:::

### Configurations prises en charge

| Édition Windows     | BIOS recommandé    | Type de machine                 | Notes                                           |
| ------------------- | ------------------ | ------------------------------- | ----------------------------------------------- |
| Windows 11          | TPM %%OVMF\|ovmf%% | %%Q35\|q35%%                    | Nécessite l'émulation TPM 2.0                   |
| Windows Server 2022 | %%OVMF\|ovmf%%     | %%Q35\|q35%%                    | Idéal pour les charges de travail en entreprise |
| Windows 10          | %%OVMF\|ovmf%%     | %%Q35\|q35%%                    | Obsolète (fin du support en oct. 2025)          |
| Windows Server 2019 | %%OVMF\|ovmf%%     | %%i440fx\|i440fx%%/%%Q35\|q35%% | Compatible mais non recommandé                  |

---

### Gestion des pilotes VirtIO

Windows nécessite des pilotes paravirtualisés pour des performances optimales avec la pile de virtualisation d'Unraid.

Pour installer ou mettre à jour les pilotes :

<Tabs>
  <TabItem value="Automatique" label="Installation automatique">
    <WindowsVirtioAutomatic />
  </TabItem>

  <TabItem value="Manuel" label="Mise à jour manuelle">
    <WindowsVirtioManual />
  </TabItem>
</Tabs>

:::tip
En utilisant Unraid 7 ou une version ultérieure, vous pouvez automatiquement injecter les pilotes %%VirtIO|virtio%% lors de l'installation de Windows. Activez cela dans ***Paramètres VM → Options avancées***.
:::

---

### Configurer l'hibernation

La mise en veille prolongée vous permet de sauvegarder l'état complet de votre Windows %%VM|vm%% - y compris les applications et documents ouverts - sur le disque. Cela vous permet d'éteindre le %%VM|vm%% sans perdre de travail. Lorsque vous reprenez, Windows restaure tout exactement comme vous l'avez laissé, sautant le processus de démarrage normal. Cette fonctionnalité est pratique lorsque vous devez redémarrer ou éteindre votre hôte Unraid ou que vous souhaitez économiser de l'énergie tout en gardant l'état de votre %%VM|vm%% intact.

:::note[Benefits de l'hibernation]
- Économisez de l'énergie en éteignant les %%VM|vm%% inactives sans perdre de progression
- Reprenez rapidement le travail après la maintenance ou les mises à jour de l'hôte
- Réduisez l'usure des SSD par rapport aux arrêts et redémarrages fréquents
:::

To use hibernation reliably, you must install the %%QEMU|qemu%% %%Guest Agent|guest-agent%% in your Windows %%VM|vm%%. This agent allows Unraid to communicate with the %%VM|vm%% for advanced operations like hibernation, shutdown, and live statistics reporting.

<details>
  <summary><strong>Comment installer le %%Agent invité QEMU|qemu%% %%Guest Agent|guest-agent%%</strong> - Cliquez pour développer/réduire</summary>

  1. Démarrez votre VM %%VM|vm%% Windows avec l'ISO des pilotes %%VirtIO|virtio%% monté.
  2. Ouvrez **l'Explorateur de Fichiers** et accédez aux médias des pilotes %%VirtIO|virtio%%.
  3. Ouvrez le dossier `guest-agent`.
  4. Exécutez `qemu-ga-x64.msi` pour installer l'agent. (Vous pourriez brièvement voir une boîte de commande ; aucune boîte de dialogue de confirmation n'apparaîtra.)
</details>

<details>
  <summary><strong>Comment activer l'hibernation dans Windows</strong> - Cliquez pour voir/fermer</summary>

  1. Ouvrez **Panneau de Configuration** et recherchez **Options d'alimentation**.
  2. Cliquez sur **Choisir ce que font les boutons d'alimentation**.
  3. Cliquez sur **Modifier les paramètres actuellement non disponibles** pour déverrouiller les paramètres d'arrêt.
  4. Cochez l'option **Hibernation**.
  5. Cliquez sur **Sauvegarder les modifications**.

  L'option **Hibernation** apparaîtra maintenant dans le menu d'alimentation Windows.
</details>

:::important[What si l'hibernation échoue?]
If your %%VM|vm%% fails to hibernate or resume properly, you may lose unsaved work or face a failed restore. Always save important data before hibernating. If issues persist, ensure the %%QEMU|qemu%% %%Guest Agent|guest-agent%% is installed and updated, and check the Windows event log for errors.
:::

---

### Optimisation des performances

L'optimisation de votre Windows %%VM|vm%% peut améliorer la réactivité, réduire l'utilisation du disque et éviter des problèmes courants avec le passage de périphériques ou l'arrêt. Ces ajustements sont facultatifs et peuvent être appliqués selon les besoins.

#### Désactiver le démarrage rapide

Désactiver le démarrage rapide peut aider à prévenir les problèmes avec le passage de périphériques. Il garantit que le matériel de votre %%VM|vm%% s'initialise correctement à chaque démarrage. Bien que ce paramètre soit conçu pour les PC physiques, dans un environnement virtuel, il peut souvent causer plus de problèmes que de bénéfices.

<details>
  <summary><strong>Comment désactiver le démarrage rapide</strong> - Cliquez pour voir/fermer</summary>

  1. Ouvrez **Panneau de Configuration** et recherchez **Alimentation**.
  2. Cliquez sur **Choisir ce que font les boutons d'alimentation**.
  3. Cliquez sur **Modifier les paramètres actuellement non disponibles**.
  4. Décochez **Activer le démarrage rapide** sous **Paramètres d'arrêt**.
  5. Cliquez sur **Sauvegarder les modifications**.
</details>

#### Désactiver hiberfil.sys

La mise en veille prolongée sous Windows crée un fichier caché appelé `hiberfil.sys`. Ce fichier peut consommer un espace disque important et augmenter l'activité du disque dans votre %%VM|vm%%. Si vous ne vous fiez pas à la mise en veille prolongée, la désactiver libérera de l'espace de stockage et réduira l'activité d'E/S inutile.

<details>
  <summary><strong>Comment désactiver l'hibernation et supprimer hiberfil.sys</strong> - Cliquez pour voir/fermer</summary>

  1. Cliquez droit sur le bouton **Démarrer** et sélectionnez **Terminal Windows (Admin)** ou **Invite de Commandes (Admin)**.
  2. Tapez : `powercfg /h off`
  3. Appuyez sur Entrée et redémarrez votre %%VM|vm%%. Le fichier `hiberfil.sys` sera supprimé de votre lecteur C:.
</details>

#### Désactiver l'indexation de Windows

Windows Search indexing continuously scans your %%virtual machine|vm%%'s storage to catalog files for faster search results. However, on a %%virtual machine|vm%%, this can cause unnecessary disk I/O, slow down performance, and increase wear on your physical storage, especially SSDs in your [%%cache pool|cache-pool%%](../manage-storage/cache-pools.mdx).

<details>
  <summary><strong>Comment désactiver l'indexation de Windows</strong> - Cliquez pour voir/fermer</summary>

  1. Appuyez sur **Windows + R** pour ouvrir le dialogue Exécuter, tapez `services.msc` et appuyez sur Entrée.
  2. Dans la fenêtre Services, faites défiler vers le bas et cliquez droit sur **Recherche Windows**, puis sélectionnez **Arrêter**.
  3. Double-cliquez sur **Recherche Windows**, changez **Type de démarrage** à **Désactivé**, et cliquez sur **OK**.
</details>

#### Désactiver la défragmentation automatique du disque

Windows est conçu pour défragmenter automatiquement les disques durs physiques selon un calendrier régulier. Sur un %%VM|vm%% - en particulier lors de l'utilisation de stockage SSD ou de %%vDisks|minces-provisionnés vdisks%% - la défragmentation automatique est inutile et peut également réduire la durée de vie du disque et dégrader les performances.

<details>
  <summary><strong>Comment désactiver la défragmentation automatique du disque</strong> - Cliquez pour voir/fermer</summary>

  1. Ouvrez **l'Explorateur de fichiers**, faites un clic droit sur le lecteur C: et sélectionnez **Propriétés**.
  2. Allez dans l'onglet **Outils** et cliquez sur **Optimiser**.
  3. Cliquez sur **Modifier les paramètres**.
  4. Décochez **Exécuter selon un calendrier** et cliquez sur **OK**.
</details>

#### Activer le mode haute performance

Les fonctionnalités de gestion de l'énergie de Windows sont conçues pour les ordinateurs portables et de bureau pour économiser de l'énergie. Dans un environnement %%VM|vm%%, ces fonctionnalités peuvent inutilement réduire les performances ou suspendre votre %%VM|vm%%, le rendant moins réactif et plus difficile à gérer.

Activer le mode **Haute Performance** garantit que votre %%VM|vm%% fonctionne toujours à pleine vitesse et est moins susceptible de se mettre en pause ou de se suspendre de manière inattendue.

<details>
  <summary><strong>Comment activer le mode haute performance</strong> - Cliquez pour voir/fermer</summary>

  1. Ouvrez **Panneau de Configuration** et recherchez "alimentation."
  2. Cliquez sur **Choisir un mode de gestion de l'alimentation**.
  3. Sélectionnez **Haute performance** sous **Modes de gestion préférés**.
</details>

#### Activer l'accès à distance

Le protocole de bureau à distance (RDP) vous permet d'accéder à votre Windows %%VM|vm%% depuis un autre appareil. Il offre de meilleures performances et compatibilité par rapport à %%VNC|session vnc%%. Notez que RDP est pris en charge uniquement sur les éditions Professionnel et Enterprise de Windows. De plus, votre compte utilisateur Windows **doit** avoir un mot de passe défini.

:::caution
RDP n'est pas disponible sur les éditions Home de Windows. Définissez toujours un mot de passe sécurisé pour votre compte utilisateur Windows avant d'activer RDP.
:::

<details>
  <summary><strong>Comment activer l'accès à distance (RDP)</strong> - Cliquez pour voir/fermer</summary>

  Pour activer l'accès RDP, suivez ces étapes :

  1. Appuyez sur **Windows + I** pour ouvrir les Paramètres, puis allez dans ***Système → À propos*** et cliquez sur **Paramètres système avancés**.
  2. Dans la fenêtre Propriétés système, cliquez sur l'onglet **Distant**, puis sélectionnez **Activer le Bureau à distance**.
  3. Cliquez sur **OK** pour confirmer les changements.
  4. Depuis votre appareil client, utilisez un client RDP de Microsoft pour vous connecter à l'**adresse IP de la %%VM|vm%%** (pas le serveur Unraid).

  :::tip
  Les clients RDP officiels de Microsoft sont disponibles pour Windows, Mac, Android et iOS. Assurez-vous que votre %%VM|vm%% est sur un pont réseau qui permet l'accès LAN.
  :::
</details>

#### Corriger l'audio HDMI avec les interruptions MSI

If you're having trouble with HDMI audio in a Windows %%VM|vm%% that uses %%GPU passthrough|gpu-passthrough%% (which often occurs with NVIDIA graphics cards), enabling Message Signaled Interrupts (MSI) might help. MSI enhances the way interrupts are managed for passed-through devices.

<details>
  <summary><strong>Comment activer les interruptions MSI</strong> - Cliquez pour voir/fermer</summary>

  :::caution
  Sauvegardez votre %%VM|vm%% avant de faire des modifications dans le registre. Des modifications incorrectes peuvent causer une instabilité du système.
  :::

  1. **Vérifiez la capacité MSI :**
     - Démarrez votre %%VM|vm%% avec le %%GPU PassThrough|gpu-passthrough%% activé.
     - Accédez à Unraid via [WebTerminal ou SSH](../../system-administration/advanced-tools/command-line-interface.mdx).
     - Exécutez la commande `lspci -v -s 01:00.0` (remplacez `01:00.0` par l'adresse PCI de votre GPU).
     - Cherchez la ligne : `Capacités : [68] MSI : Activer+ Compter=1/1 Masquable- 64bit+`.

  2. **Activez MSI dans Windows :**
     - Si MSI affiche `Enable-`, suivez le [guide de Microsoft](https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/enabling-message-signaled-interrupts-in-the-registry) ou utilisez l'[outil MSI Mode Utility](https://forums.guru3d.com/threads/windows-line-based-vs-message-signaled-based-interrupts-msi-tool.378044/) pour modifier les paramètres du registre Windows.
     - Redémarrez la %%VM|vm%% après avoir apporté les modifications.

  Pour plus de détails techniques, voyez [Explication des interruptions VFIO](https://vfio.blogspot.com/2014/09/vfio-interrupts-and-how-to-coax-windows.html).
</details>

---

### Mettre à niveau vers Windows 11

Windows 11 nécessite TPM 2.0 et Secure Boot. Le BIOS **OVMF-TPM** d'Unraid fournit le support TPM virtuel nécessaire pour ces exigences.

:::important[Before mise à niveau]
- Créez une sauvegarde complète de votre %%VM|vm%%.
- Assurez-vous qu'Unraid exécute la version 6.10 ou plus.
- Vérifiez que votre %%VM|vm%% Windows 10 répond aux [exigences système de Windows 11](https://www.microsoft.com/fr-fr/windows/windows-11-specifications).
:::

Pour ajouter le support TPM :

1. Éteignez votre Windows 10 %%VM|vm%%.
2. Modifiez les paramètres du %%VM|vm%%.
3. Changez le **BIOS** de *%%OVMF|ovmf%%* à *%%OVMF|ovmf%%-TPM*.
4. Enregistrez les modifications et démarrez le %%VM|vm%%.

#### Méthodes de mise à niveau

<Tabs>
  <TabItem value="Mise à niveau sur place" label="Mise à niveau sur place">
    <WindowsUpgradeInPlace />
  </TabItem>

  <TabItem value="Installation propre" label="Installation propre">
    <WindowsUpgradeCleanInstall />
  </TabItem>
</Tabs>

## Étendre les partitions de vDisk VM Windows

:::caution[Data risque de perte]
L'expansion ou la modification de %%vDisk|vdisk%% et des agencements de partitions peut entraîner une perte de données irréversible si elle n'est pas effectuée avec soin. Créez toujours une sauvegarde complète ou un instantané de votre %%VM|vm%% avant de procéder.
:::

Après avoir étendu votre %%vDisk|vdisk%% en suivant les étapes de [Élargir un vDisk](../create-virtual-machines/vm-setup.mdx#expand-a-vdisk), vous pourriez rencontrer un problème où la partition de récupération par défaut de Windows vous bloque pour agrandir facilement votre partition système (C:) afin d'utiliser le nouvel espace. Pour résoudre ce problème, vous devez supprimer la partition de récupération, puis utiliser la gestion des disques de Windows pour étendre la partition.

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![Resize vDisk 2](/img/Resize_vdisk_2.png)
</div>

Après avoir complété l'extension initiale du %%vDisk|vdisk%% :

1. Démarrez votre VM Windows.
2. **Ouvrir l'invite de commande :** Appuyez sur la touche Windows, tapez `cmd`, et appuyez sur Entrée.
3. **Lancez diskpart :** Tapez `diskpart` et appuyez sur Entrée.
4. **Liste des disques :** Tapez `list disk` et appuyez sur Entrée.
5. **Sélectionnez le disque étendu :** Tapez `select disk #`, en remplaçant `#` par le bon numéro de disque.
6. **Liste des partitions :** Tapez `list partition` et appuyez sur Entrée.
7. **Identifiez la partition de récupération :** Recherchez la partition de récupération qui suit votre partition principale.
8. **Sélectionnez et supprimez la partition de récupération :**
   - Tapez `select partition #`, en remplaçant `#` par le numéro de la partition de récupération.
   - Tapez `delete partition override` et appuyez sur Entrée.
9. **Étendre la partition C: :**
   - Cliquez avec le bouton droit sur le menu Démarrer et sélectionnez **Gestion des disques**.
   - Cliquez avec le bouton droit sur la partition que vous souhaitez étendre (généralement C:) et choisissez **Étendre le volume...**.
   - Suivez les invites pour utiliser l'espace non alloué.

<div className="conteneur-flex" style={{ margin: 'auto', maxWidth: '800px'}}>
  <figure className="flex-figure">
    <img src="/img/Resize_vdisk_3.png" alt="Redimensionner vDisk 3" />
  </figure>

  <figure className="flex-figure">
    <img src="/img/Resize_vdisk_4.png" alt="Redimensionner vDisk 4" />
  </figure>
</div>

:::tip
Vous n'avez besoin de supprimer la partition de récupération que si elle bloque l'accès à l'espace libre adjacent. Si l'espace non alloué est déjà à côté de votre partition C:, vous pouvez l'étendre sans rien supprimer.
:::

:::warning
Les modifications apportées aux partitions de disque sont permanentes et ne peuvent pas être annulées. Assurez-vous que vos données sont sauvegardées en toute sécurité avant de supprimer des partitions.
:::
