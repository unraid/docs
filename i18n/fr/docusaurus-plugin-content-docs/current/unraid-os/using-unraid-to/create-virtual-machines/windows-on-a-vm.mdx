---
sidebar_position: 3
sidebar_label: Windows sur une VM
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import WindowsVirtioAutomatic from './partials/windows-virtio-automatic.mdx';
import WindowsVirtioManual from './partials/windows-virtio-manual.mdx';
import WindowsUpgradeInPlace from './partials/windows-upgrade-in-place.mdx';
import WindowsUpgradeCleanInstall from './partials/windows-upgrade-clean-install.mdx';

# Windows sur une VM

Windows est l'un des systèmes d'exploitation invités les plus populaires pour les utilisateurs d'Unraid, en particulier pour les jeux, la productivité et le support des applications héritées. Voici des considérations essentielles pour exécuter Windows %%VM|vm%%.

:::caution[Before vous commencez]
- Microsoft a mis fin au support de Windows 7 en janvier 2020, de Windows 8.1 en janvier 2023, et de Windows 10 en octobre 2025. Utilisez Windows 11 (ou plus récent) ou Server 2022 (ou plus récent) pour des mises à jour de sécurité continues.
- Testez toujours la stabilité de votre %%VM|vm%% avant d'activer votre licence Windows.
- Pour le passage du %%GPU|gpu-passthrough%%, utilisez le BIOS %%OVMF|ovmf%% (%%UEFI|uefi%%) avec Windows 11 ou plus récent.
:::

### Configurations prises en charge

| Édition Windows     | BIOS recommandé    | Type de machine                 | Notes                                           |
| ------------------- | ------------------ | ------------------------------- | ----------------------------------------------- |
| Windows 11          | TPM %%OVMF\|ovmf%% | %%Q35\|q35%%                    | Nécessite l'émulation TPM 2.0                   |
| Windows Server 2022 | %%OVMF\|ovmf%%     | %%Q35\|q35%%                    | Idéal pour les charges de travail en entreprise |
| Windows 10          | %%OVMF\|ovmf%%     | %%Q35\|q35%%                    | Obsolète (fin du support en oct. 2025)          |
| Windows Server 2019 | %%OVMF\|ovmf%%     | %%i440fx\|i440fx%%/%%Q35\|q35%% | Compatible mais non recommandé                  |

---

### Gestion des pilotes VirtIO

Windows nécessite des pilotes paravirtualisés pour des performances optimales avec la pile de virtualisation d'Unraid.

Pour installer ou mettre à jour les pilotes :

<Tabs>
  <TabItem value="Automatique" label="Installation automatique">
    <WindowsVirtioAutomatic />
  </TabItem>

  <TabItem value="Manuel" label="Mise à jour manuelle">
    <WindowsVirtioManual />
  </TabItem>
</Tabs>

:::tip
Using Unraid 7 or later, you can automatically inject %%VirtIO|virtio%% drivers during the Windows installation. Enable this in ***VM Settings → Advanced Options***.
:::

---

### Configurer l'hibernation

Hibernation lets you save your entire Windows %%VM|vm%% state - including open applications and documents - to disk. This allows you to power off the %%VM|vm%% without losing any work. When you resume, Windows restores everything exactly as you left it, skipping the normal boot process. This feature is handy when you need to reboot or power down your Unraid host or want to save energy while keeping your %%VM|vm%%'s state intact.

:::note[Benefits of hibernation]
- Économisez de l'énergie en éteignant les %%VM|vm%% inactives sans perdre de progression
- Reprenez rapidement le travail après la maintenance ou les mises à jour de l'hôte
- Réduisez l'usure des SSD par rapport aux arrêts et redémarrages fréquents
:::

To use hibernation reliably, you must install the %%QEMU|qemu%% %%Guest Agent|guest-agent%% in your Windows %%VM|vm%%. This agent allows Unraid to communicate with the %%VM|vm%% for advanced operations like hibernation, shutdown, and live statistics reporting.

<details>
  <summary><strong>Comment installer le %%Agent invité QEMU|qemu%% %%Guest Agent|guest-agent%%</strong> - Cliquez pour développer/réduire</summary>

  1. Démarrez votre VM %%VM|vm%% Windows avec l'ISO des pilotes %%VirtIO|virtio%% monté.
  2. Ouvrez **l'Explorateur de Fichiers** et accédez aux médias des pilotes %%VirtIO|virtio%%.
  3. Ouvrez le dossier `guest-agent`.
  4. Run `qemu-ga-x64.msi` to install the agent. (You may briefly see a command box; no confirmation dialog will appear.)
</details>

<details>
  <summary><strong>Comment activer l'hibernation dans Windows</strong> - Cliquez pour voir/fermer</summary>

  1. Ouvrez **Panneau de Configuration** et recherchez **Options d'alimentation**.
  2. Cliquez sur **Choisir ce que font les boutons d'alimentation**.
  3. Cliquez sur **Modifier les paramètres actuellement non disponibles** pour déverrouiller les paramètres d'arrêt.
  4. Cochez l'option **Hibernation**.
  5. Cliquez sur **Sauvegarder les modifications**.

  L'option **Hibernation** apparaîtra maintenant dans le menu d'alimentation Windows.
</details>

:::important[What if hibernation fails?]
If your %%VM|vm%% fails to hibernate or resume properly, you may lose unsaved work or face a failed restore. Always save important data before hibernating. If issues persist, ensure the %%QEMU|qemu%% %%Guest Agent|guest-agent%% is installed and updated, and check the Windows event log for errors.
:::

---

### Optimisation des performances

Optimizing your Windows %%VM|vm%% can improve responsiveness, reduce disk usage, and avoid common issues with device passthrough or shutdown. These adjustments are optional and can be applied as needed.

#### Désactiver le démarrage rapide

Disabling fast startup can help prevent issues with device passthrough. It ensures your %%VM|vm%% hardware initializes correctly every time it boots. While this setting is designed for physical PCs, in a virtual environment, it can often cause more problems than benefits.

<details>
  <summary><strong>Comment désactiver le démarrage rapide</strong> - Cliquez pour voir/fermer</summary>

  1. Ouvrez **Panneau de Configuration** et recherchez **Alimentation**.
  2. Cliquez sur **Choisir ce que font les boutons d'alimentation**.
  3. Cliquez sur **Modifier les paramètres actuellement non disponibles**.
  4. Décochez **Activer le démarrage rapide** sous **Paramètres d'arrêt**.
  5. Cliquez sur **Sauvegarder les modifications**.
</details>

#### Désactiver hiberfil.sys

Hibernation in Windows creates a large hidden file called `hiberfil.sys`. This file can consume significant disk space and increase disk activity in your %%VM|vm%%. If you don't rely on hibernation, disabling it will free up storage and reduce unnecessary I/O activity.

<details>
  <summary><strong>Comment désactiver l'hibernation et supprimer hiberfil.sys</strong> - Cliquez pour voir/fermer</summary>

  1. Cliquez droit sur le bouton **Démarrer** et sélectionnez **Terminal Windows (Admin)** ou **Invite de Commandes (Admin)**.
  2. Tapez : `powercfg /h off`
  3. Press Enter and reboot your %%VM|vm%%. The `hiberfil.sys` file will be removed from your C:\ drive.
</details>

#### Désactiver l'indexation de Windows

Windows Search indexing continuously scans your %%virtual machine|vm%%'s storage to catalog files for faster search results. However, on a %%virtual machine|vm%%, this can cause unnecessary disk I/O, slow down performance, and increase wear on your physical storage, especially SSDs in your [%%cache pool|cache-pool%%](../manage-storage/cache-pools.mdx).

<details>
  <summary><strong>Comment désactiver l'indexation de Windows</strong> - Cliquez pour voir/fermer</summary>

  1. Appuyez sur **Windows + R** pour ouvrir le dialogue Exécuter, tapez `services.msc` et appuyez sur Entrée.
  2. Dans la fenêtre Services, faites défiler vers le bas et cliquez droit sur **Recherche Windows**, puis sélectionnez **Arrêter**.
  3. Double-cliquez sur **Recherche Windows**, changez **Type de démarrage** à **Désactivé**, et cliquez sur **OK**.
</details>

#### Désactiver la défragmentation automatique du disque

Windows is designed to defrag physical hard drives on a regular schedule automatically. On a %%VM|vm%% - especially when using SSD storage or thin-provisioned %%vDisks|vdisk%% - automatic defragmenting is unnecessary and can also reduce disk lifespan and degrade performance.

<details>
  <summary><strong>Comment désactiver la défragmentation automatique du disque</strong> - Cliquez pour voir/fermer</summary>

  1. Ouvrez **l'Explorateur de fichiers**, faites un clic droit sur le lecteur C: et sélectionnez **Propriétés**.
  2. Allez dans l'onglet **Outils** et cliquez sur **Optimiser**.
  3. Cliquez sur **Modifier les paramètres**.
  4. Décochez **Exécuter selon un calendrier** et cliquez sur **OK**.
</details>

#### Activer le mode haute performance

Power management features in Windows are designed for laptops and desktops to save energy. In a %%VM|vm%% environment, these features can unnecessarily throttle performance or suspend your %%VM|vm%%, making it less responsive and harder to manage.

Activer le mode **Haute Performance** garantit que votre %%VM|vm%% fonctionne toujours à pleine vitesse et est moins susceptible de se mettre en pause ou de se suspendre de manière inattendue.

<details>
  <summary><strong>Comment activer le mode haute performance</strong> - Cliquez pour voir/fermer</summary>

  1. Ouvrez **Panneau de Configuration** et recherchez "alimentation."
  2. Cliquez sur **Choisir un mode de gestion de l'alimentation**.
  3. Sélectionnez **Haute performance** sous **Modes de gestion préférés**.
</details>

#### Activer l'accès à distance

Remote desktop protocol (RDP) allows you to access your Windows %%VM|vm%% from another device. It offers better performance and compatibility compared to %%VNC|vnc-session%%. Note that RDP is supported only on Windows Professional and Enterprise editions. Also, your Windows user account **must** have a password set.

:::caution
RDP is not available on Windows Home editions. Always set a secure password for your Windows user account before enabling RDP.
:::

<details>
  <summary><strong>Comment activer l'accès à distance (RDP)</strong> - Cliquez pour voir/fermer</summary>

  Pour activer l'accès RDP, suivez ces étapes :

  1. Appuyez sur **Windows + I** pour ouvrir les Paramètres, puis allez dans ***Système → À propos*** et cliquez sur **Paramètres système avancés**.
  2. Dans la fenêtre Propriétés système, cliquez sur l'onglet **Distant**, puis sélectionnez **Activer le Bureau à distance**.
  3. Cliquez sur **OK** pour confirmer les changements.
  4. Depuis votre appareil client, utilisez un client RDP de Microsoft pour vous connecter à l'**adresse IP de la %%VM|vm%%** (pas le serveur Unraid).

  :::tip
  Les clients RDP officiels de Microsoft sont disponibles pour Windows, Mac, Android et iOS. Assurez-vous que votre %%VM|vm%% est sur un pont réseau qui permet l'accès LAN.
  :::
</details>

#### Corriger l'audio HDMI avec les interruptions MSI

If you're having trouble with HDMI audio in a Windows %%VM|vm%% that uses %%GPU passthrough|gpu-passthrough%% (which often occurs with NVIDIA graphics cards), enabling Message Signaled Interrupts (MSI) might help. MSI enhances the way interrupts are managed for passed-through devices.

<details>
  <summary><strong>Comment activer les interruptions MSI</strong> - Cliquez pour voir/fermer</summary>

  :::caution
  Sauvegardez votre %%VM|vm%% avant de faire des modifications dans le registre. Des modifications incorrectes peuvent causer une instabilité du système.
  :::

  1. **Vérifiez la capacité MSI :**
     - Démarrez votre %%VM|vm%% avec le %%GPU PassThrough|gpu-passthrough%% activé.
     - Accédez à Unraid via [WebTerminal ou SSH](../../system-administration/advanced-tools/command-line-interface.mdx).
     - Exécutez la commande `lspci -v -s 01:00.0` (remplacez `01:00.0` par l'adresse PCI de votre GPU).
     - Cherchez la ligne : `Capacités : [68] MSI : Activer+ Compter=1/1 Masquable- 64bit+`.

  2. **Activez MSI dans Windows :**
     - Si MSI affiche `Enable-`, suivez le [guide de Microsoft](https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/enabling-message-signaled-interrupts-in-the-registry) ou utilisez l'[outil MSI Mode Utility](https://forums.guru3d.com/threads/windows-line-based-vs-message-signaled-based-interrupts-msi-tool.378044/) pour modifier les paramètres du registre Windows.
     - Redémarrez la %%VM|vm%% après avoir apporté les modifications.

  Pour plus de détails techniques, voyez [Explication des interruptions VFIO](https://vfio.blogspot.com/2014/09/vfio-interrupts-and-how-to-coax-windows.html).
</details>

---

### Mettre à niveau vers Windows 11

Windows 11 requires TPM 2.0 and Secure Boot. Unraid's **OVMF-TPM** BIOS provides the virtual TPM support needed for these requirements.

:::important[Before mise à niveau]
- Créez une sauvegarde complète de votre %%VM|vm%%.
- Assurez-vous qu'Unraid exécute la version 6.10 ou plus.
- Vérifiez que votre %%VM|vm%% Windows 10 répond aux [exigences système de Windows 11](https://www.microsoft.com/fr-fr/windows/windows-11-specifications).
:::

Pour ajouter le support TPM :

1. Éteignez votre Windows 10 %%VM|vm%%.
2. Modifiez les paramètres du %%VM|vm%%.
3. Changez le **BIOS** de *%%OVMF|ovmf%%* à *%%OVMF|ovmf%%-TPM*.
4. Enregistrez les modifications et démarrez le %%VM|vm%%.

#### Méthodes de mise à niveau

<Tabs>
  <TabItem value="Mise à niveau sur place" label="Mise à niveau sur place">
    <WindowsUpgradeInPlace />
  </TabItem>

  <TabItem value="Installation propre" label="Installation propre">
    <WindowsUpgradeCleanInstall />
  </TabItem>
</Tabs>

## Étendre les partitions de vDisk VM Windows

:::caution[Data loss risk]
Expanding or modifying %%vDisk|vdisk%% and partition layouts can lead to irreversible data loss if not done carefully. Always create a full backup or snapshot of your %%VM|vm%% before proceeding.
:::

After you expand your %%vDisk|vdisk%% following the steps in [Expand a vDisk](../create-virtual-machines/vm-setup.mdx#expand-a-vdisk), you may encounter an issue where Windows’ default recovery partition blocks you from easily expanding your system (C:) partition to utilize the new space. To resolve this issue, you need to delete the recovery partition and then use Windows Disk Management to expand the partition.

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![Resize vDisk 2](/img/Resize_vdisk_2.png)
</div>

Après avoir complété l'extension initiale du %%vDisk|vdisk%% :

1. Démarrez votre VM Windows.
2. **Ouvrir l'invite de commande :** Appuyez sur la touche Windows, tapez `cmd`, et appuyez sur Entrée.
3. **Lancez diskpart :** Tapez `diskpart` et appuyez sur Entrée.
4. **Liste des disques :** Tapez `list disk` et appuyez sur Entrée.
5. **Sélectionnez le disque étendu :** Tapez `select disk #`, en remplaçant `#` par le bon numéro de disque.
6. **Liste des partitions :** Tapez `list partition` et appuyez sur Entrée.
7. **Identifiez la partition de récupération :** Recherchez la partition de récupération qui suit votre partition principale.
8. **Sélectionnez et supprimez la partition de récupération :**
   - Tapez `select partition #`, en remplaçant `#` par le numéro de la partition de récupération.
   - Tapez `delete partition override` et appuyez sur Entrée.
9. **Étendre la partition C: :**
   - Cliquez avec le bouton droit sur le menu Démarrer et sélectionnez **Gestion des disques**.
   - Cliquez avec le bouton droit sur la partition que vous souhaitez étendre (généralement C:) et choisissez **Étendre le volume...**.
   - Suivez les invites pour utiliser l'espace non alloué.

<div className="conteneur-flex" style={{ margin: 'auto', maxWidth: '800px'}}>
  <figure className="flex-figure">
    <img src="/img/Resize_vdisk_3.png" alt="Redimensionner vDisk 3" />
  </figure>

  <figure className="flex-figure">
    <img src="/img/Resize_vdisk_4.png" alt="Redimensionner vDisk 4" />
  </figure>
</div>

:::tip
You only need to remove the recovery partition if it blocks access to adjacent free space. If the unallocated space is already next to your C: partition, you can extend it without deleting anything.
:::

:::warning
Changes made to disk partitions are permanent and cannot be undone. Ensure that your data is securely backed up before deleting any partitions.
:::
