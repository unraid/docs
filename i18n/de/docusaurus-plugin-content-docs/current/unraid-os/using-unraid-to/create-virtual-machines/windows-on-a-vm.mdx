---
sidebar_position: 3
sidebar_label: Windows in einer VM
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import WindowsVirtioAutomatic from './partials/windows-virtio-automatic.mdx';
import WindowsVirtioManual from './partials/windows-virtio-manual.mdx';
import WindowsUpgradeInPlace from './partials/windows-upgrade-in-place.mdx';
import WindowsUpgradeCleanInstall from './partials/windows-upgrade-clean-install.mdx';

# Windows in einer VM

Windows ist eines der beliebtesten Gastbetriebssysteme für Unraid-Benutzer, insbesondere für Gaming, Produktivität und Unterstützung älterer Anwendungen. Hier sind wesentliche Überlegungen zum Betrieb von Windows-VMs.

:::caution[Before Sie beginnen]

- Microsoft beendete den Support für Windows 7 im Januar 2020, Windows 8.1 im Januar 2023 und Windows 10 im Oktober 2025. Verwenden Sie Windows 11 (oder später) oder Server 2022 (oder später) für laufende Sicherheitsupdates.
- Testen Sie immer die Stabilität von %%VM|vm%%, bevor Sie Ihre Windows-Lizenz aktivieren.
- Für %%GPU-Passthrough|gpu-passthrough%% verwenden Sie %%OVMF|ovmf%% (%%UEFI|uefi%%) BIOS mit Windows 11 oder neuer.
  :::

### Unterstützte Konfigurationen

| Windows-Ausgabe     | Empfohlenes BIOS   | Maschinentyp                    | Anmerkungen                      |
| ------------------- | ------------------ | ------------------------------- | -------------------------------- |
| Windows 11          | %%OVMF\|ovmf%% TPM | %%Q35\|q35%%                    | Benötigt TPM 2.0 Emulation       |
| Windows Server 2022 | %%OVMF\|ovmf%%     | %%Q35\|q35%%                    | Ideal für Unternehmens-Workloads |
| Windows 10          | %%OVMF\|ovmf%%     | %%Q35\|q35%%                    | Veraltet (EOL Oktober 2025)      |
| Windows Server 2019 | %%OVMF\|ovmf%%     | %%i440fx\|i440fx%%/%%Q35\|q35%% | Kompatibel, aber nicht empfohlen |

---

### VirtIO-Treiberverwaltung

Windows benötigt paravirtualisierte Treiber für eine optimale Leistung mit Unraid's Virtualisierungsstack.

Um Treiber zu installieren oder zu aktualisieren:

<Tabs>
  <TabItem value="Autostart" label="Automatische Installation">
    <WindowsVirtioAutomatic />
  </TabItem>

  <TabItem value="Manuell" label="Manuelles Update">
    <WindowsVirtioManual />
  </TabItem>
</Tabs>

:::tip
Mit Unraid 7 oder später können Sie %%VirtIO|virtio%%-Treiber während der Windows-Installation automatisch einfügen. Aktivieren Sie dies in den ***VM-Einstellungen → Erweiterte Optionen***.
:::

---

### Einrichten des Ruhemodus

Der Ruhezustand ermöglicht es Ihnen, den gesamten Zustand Ihrer Windows-VM - einschließlich geöffneter Anwendungen und Dokumente - auf die Festplatte zu speichern. Dadurch können Sie die VM ausschalten, ohne Arbeit zu verlieren. Wenn Sie fortfahren, stellt Windows alles genauso wieder her, wie Sie es verlassen haben, und überspringt den normalen Startprozess. Diese Funktion ist nützlich, wenn Sie Ihren Unraid-Host neu starten oder herunterfahren müssen oder Energie sparen möchten, während der Zustand der VM erhalten bleibt.

:::note[Benefits aus dem Ruhezustand]

- Energie sparen, indem inaktive %%VM|vm%% ausgeschaltet werden, ohne Fortschritte zu verlieren
- Arbeit schnell nach Wartung oder Updates am Host wieder aufnehmen
- Verringern Sie den Verschleiß von SSDs im Vergleich zu häufigen vollständigen Ausschaltungen und Neustarts
  :::

Um den Ruhezustand zuverlässig zu verwenden, müssen Sie den %%QEMU|qemu%% %%Guest Agent|guest-agent%% in Ihrer Windows-VM installieren. Dieser Agent ermöglicht es Unraid, mit der VM für erweiterte Vorgänge wie Ruhezustand, Herunterfahren und Echtzeitstatistiken zu kommunizieren.

<details>
  <summary><strong>Wie installiert man den %%QEMU|qemu%% %%Guest Agent|guest-agent%%</strong> – Klicken Sie hier zum Ein-/Ausklappen</summary>

  1. Starten Sie Ihre Windows-%%VM|vm%% mit der eingehängten %%VirtIO|virtio%%-Treiber-ISO.
  2. Öffnen Sie den **Datei-Explorer** und navigieren Sie zu den %%VirtIO|virtio%%-Treibern.
  3. Öffnen Sie den Ordner `guest-agent`.
  4. Führen Sie `qemu-ga-x64.msi` aus, um den Agenten zu installieren. (Eventuell sehen Sie kurz ein Befehlsfeld; es wird kein Bestätigungsdialog angezeigt.)
</details>

<details>
  <summary><strong>Wie aktiviert man den Ruhemodus in Windows</strong> – Klicken Sie hier zum Ein-/Ausklappen</summary>

  1. Öffnen Sie die **Systemsteuerung** und suchen Sie nach **Energieoptionen**.
  2. Klicken Sie auf **Funktion des Ein-/Ausschalters festlegen**.
  3. Klicken Sie auf **Einstellungen ändern, die momentan nicht verfügbar sind**, um Einstellungen zum Ausschalten freizuschalten.
  4. Markieren Sie die Option **Ruhezustand**.
  5. Klicken Sie auf **Änderungen speichern**.

  Die Option **Ruhezustand** wird jetzt im Windows-Energie-Menü angezeigt.
</details>

:::important[What falls der Ruhezustand fehlschlägt?]
Wenn Ihre VM nach dem Ruhezustand oder beim Fortsetzen nicht ordnungsgemäß funktioniert, können ungespeicherte Daten verloren gehen oder eine Wiederherstellung fehlschlagen. Speichern Sie vor dem Ruhezustand immer wichtige Daten. Wenn Probleme weiterhin bestehen, stellen Sie sicher, dass der %%QEMU|qemu%% %%Guest Agent|guest-agent%% installiert und aktualisiert ist, und überprüfen Sie das Windows-Ereignisprotokoll auf Fehler.
:::

---

### Leistungsoptimierung

Die Optimierung Ihrer Windows-VM kann die Reaktionsfähigkeit verbessern, den Speicherplatz reduzieren und häufige Probleme mit Geräteübertragung oder Herunterfahren vermeiden. Diese Anpassungen sind optional und können bei Bedarf angewendet werden.

#### Schnellstart deaktivieren

Das Deaktivieren des Schnellstarts kann helfen, Probleme mit der Geräteübertragung zu verhindern. Es stellt sicher, dass Ihre VM-Hardware bei jedem Start korrekt initialisiert wird. Während diese Einstellung für physische PCs ausgelegt ist, kann sie in einer virtuellen Umgebung oft mehr Probleme als Vorteile verursachen.

<details>
  <summary><strong>Wie man den Schnellstart deaktiviert</strong> – Klicken Sie hier zum Ein-/Ausklappen</summary>

  1. Öffnen Sie die **Systemsteuerung** und suchen Sie nach **Energie**.
  2. Klicken Sie auf **Funktion des Ein-/Ausschalters festlegen**.
  3. Klicken Sie auf **Einstellungen ändern, die momentan nicht verfügbar sind**.
  4. Deaktivieren Sie unter **Ausschaltoptionen** die Option **Schnellstart aktivieren**.
  5. Klicken Sie auf **Änderungen speichern**.
</details>

#### hiberfil.sys deaktivieren

Der Ruhezustand in Windows erstellt eine große versteckte Datei namens `hiberfil.sys`. Diese Datei kann erheblichen Speicherplatz beanspruchen und die Festplattenaktivität in Ihrer VM erhöhen. Wenn Sie sich nicht auf den Ruhezustand verlassen, wird durch das Deaktivieren Speicherplatz freigegeben und unnötige I/O-Aktivitäten reduziert.

<details>
  <summary><strong>Wie man den Ruhezustand deaktiviert und hiberfil.sys entfernt</strong> – Klicken Sie hier zum Ein-/Ausklappen</summary>

  1. Klicken Sie mit der rechten Maustaste auf die **Start**-Taste und wählen Sie **Windows Terminal (Admin)** oder **Eingabeaufforderung (Admin)**.
  2. Geben Sie ein: `powercfg /h off`
  3. Drücken Sie Enter und starten Sie Ihre VM neu. Die Datei `hiberfil.sys` wird von Ihrem C:\ Laufwerk entfernt.
</details>

#### Windows-Indizierung deaktivieren

Windows Search indexing continuously scans your %%virtual machine|vm%%'s storage to catalog files for faster search results. However, on a %%virtual machine|vm%%, this can cause unnecessary disk I/O, slow down performance, and increase wear on your physical storage, especially SSDs in your [%%cache pool|cache-pool%%](../manage-storage/cache-pools.mdx).

<details>
  <summary><strong>Wie man die Windows-Indizierung deaktiviert</strong> – Klicken zum Ein-/Ausklappen</summary>

  1. Drücken Sie **Windows + R**, um den Ausführen-Dialog zu öffnen, geben Sie `services.msc` ein und drücken Sie Enter.
  2. Im Dienstefenster scrollen Sie nach unten und klicken mit der rechten Maustaste auf **Windows Search**, dann wählen Sie **Beenden**.
  3. Doppelklicken Sie auf **Windows Search**, ändern Sie den **Starttyp** auf **Deaktiviert** und klicken Sie auf **OK**.
</details>

#### Automatische Festplattendefragmentierung deaktivieren

Windows ist darauf ausgelegt, physische Festplatten regelmäßig automatisch zu defragmentieren. Auf einer VM - insbesondere bei der Verwendung von SSD-Speichern oder dünn bereitgestellten %%vDisks|vdisk%% - ist eine automatische Defragmentierung unnötig und kann auch die Lebensdauer der Festplatte verringern und die Leistung beeinträchtigen.

<details>
  <summary><strong>Wie man die automatische Festplattendefragmentierung deaktiviert</strong> – Klicken zum Ein-/Ausklappen</summary>

  1. Öffnen Sie den **Datei-Explorer**, klicken Sie mit der rechten Maustaste auf das C:-Laufwerk und wählen Sie **Eigenschaften**.
  2. Gehen Sie auf die Registerkarte **Tools** und klicken Sie auf **Optimieren**.
  3. Klicken Sie auf **Einstellungen ändern**.
  4. Deaktivieren Sie **Planmäßig ausführen** und klicken Sie auf **OK**.
</details>

#### Hochleistungsmodus aktivieren

Energieverwaltungsfunktionen in Windows sind für Laptops und Desktops konzipiert, um Energie zu sparen. In einer VM-Umgebung können diese Funktionen die Leistung unnötig drosseln oder Ihre VM aussetzen, was sie weniger reaktionsfähig und schwieriger zu verwalten macht.

Die Aktivierung des Modus **Hochleistung** stellt sicher, dass Ihre %%VM|vm%% jederzeit mit voller Geschwindigkeit läuft und weniger wahrscheinlich Pausen oder unerwartete Aussetzungen auftreten.

<details>
  <summary><strong>Wie man den Hochleistungsmodus aktiviert</strong> – Klicken zum Ein-/Ausklappen</summary>

  1. Öffnen Sie die **Systemsteuerung** und suchen Sie nach "Energie".
  2. Klicken Sie auf **Energieplan auswählen**.
  3. Wählen Sie **Hochleistung** unter **Bevorzugte Pläne** aus.
</details>

#### Zugriff auf Remote-Desktop aktivieren

Das Remote Desktop Protocol (RDP) ermöglicht Ihnen den Zugriff auf Ihre Windows-VM von einem anderen Gerät aus. Es bietet bessere Leistung und Kompatibilität im Vergleich zu %%VNC|vnc-session%%. Beachten Sie, dass RDP nur auf Windows Professional und Enterprise Editionen unterstützt wird. Auch muss Ihr Windows-Benutzerkonto ein Passwort haben.

:::caution
RDP ist auf Windows Home Editionen nicht verfügbar. Setzen Sie immer ein sicheres Passwort für Ihr Windows-Benutzerkonto, bevor Sie RDP aktivieren.
:::

<details>
  <summary><strong>Wie man den Remote-Desktop-Zugriff (RDP) aktiviert</strong> – Klicken zum Ein-/Ausklappen</summary>

  Um RDP-Zugriff zu aktivieren, folgen Sie diesen Schritten:

  1. Drücken Sie **Windows + I**, um die Einstellungen zu öffnen, navigieren Sie dann zu ***System → Info*** und klicken Sie auf **Erweiterte Systemeinstellungen**.
  2. Im Fenster Systemeigenschaften klicken Sie auf die Registerkarte **Remote**, dann wählen Sie **Remote Desktop aktivieren**.
  3. Klicken Sie auf **OK**, um die Änderungen zu bestätigen.
  4. Von Ihrem Client-Gerät aus verwenden Sie einen Microsoft RDP-Client, um sich mit der **IP-Adresse der %%VM|vm%%** (nicht mit dem Unraid-Server) zu verbinden.

  :::tip
  Offizielle Microsoft RDP-Clients sind für Windows, Mac, Android und iOS verfügbar. Stellen Sie sicher, dass Ihr %%VM|vm%% in einem Netzwerkbridge ist, das LAN-Zugriff ermöglicht.
  :::
</details>

#### HDMI-Audio mit MSI-Interrupts beheben

Wenn Sie Probleme mit HDMI-Audio in einer Windows-%%VM|vm%% haben, die %%GPU-Passthrough|gpu-passthrough%% verwendet (was oft bei NVIDIA-Grafikkarten vorkommt), kann das Aktivieren von Message Signaled Interrupts (MSI) helfen. MSI verbessert die Verwaltung von Interrupts für durchgeschleuste Geräte.

<details>
  <summary><strong>Wie aktiviert man MSI-Interrupts</strong> – Klicken zum Ein-/Ausklappen</summary>

  :::caution
  Sichern Sie Ihre %%VM|vm%%, bevor Sie Änderungen an der Registrierung vornehmen. Falsche Modifikationen können Systeminstabilität verursachen.
  :::

  1. **MSI-Fähigkeit überprüfen:**
     - Starten Sie Ihre %%VM|vm%% mit aktiviertem %%GPU-Passthrough|gpu-passthrough%%.
     - Zugriff auf Unraid über [WebTerminal oder SSH](../../system-administration/advanced-tools/command-line-interface.mdx).
     - Führen Sie den Befehl `lspci -v -s 01:00.0` aus (ersetzen Sie `01:00.0` durch die PCI-Adresse Ihrer GPU).
     - Suchen Sie nach der Zeile: `Capabilities: [68] MSI: Enable+ Count=1/1 Maskable- 64bit+`.

  2. **MSI in Windows einschalten:**
     - Wenn bei MSI `Enable-` angezeigt wird, folgen Sie [Microsofts Anleitung](https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/enabling-message-signaled-interrupts-in-the-registry) oder verwenden Sie das [MSI Mode Utility](https://forums.guru3d.com/threads/windows-line-based-vs-message-signaled-based-interrupts-msi-tool.378044/), um Ihre Windows-Registry-Einstellungen zu ändern.
     - Starten Sie die %%VM|vm%% nach den Änderungen neu.

  Für weitere technische Details siehe [VFIO-Interrupts erklärt](https://vfio.blogspot.com/2014/09/vfio-interrupts-and-how-to-coax-windows.html).
</details>

---

### Upgrade zu Windows 11

Windows 11 erfordert TPM 2.0 und Secure Boot. Das **OVMF-TPM**-BIOS von Unraid bietet die benötigte virtuelle TPM-Unterstützung für diese Anforderungen.

:::important[Before Upgrade]

- Erstellen Sie eine vollständige Sicherung Ihrer %%VM|vm%%.
- Stellen Sie sicher, dass Unraid Version 6.10 oder später ausgeführt wird.
- Überprüfen Sie, ob Ihre Windows 10 %%VM|vm%% die [Systemanforderungen von Windows 11](https://www.microsoft.com/en-us/windows/windows-11-specifications) erfüllt.
  :::

Um TPM-Unterstützung hinzuzufügen:

1. Fahren Sie Ihren Windows 10 %%VM|vm%% herunter.
2. Bearbeiten Sie die %%VM|vm%%-Einstellungen.
3. Ändern Sie das **BIOS** von *%%OVMF|ovmf%%* zu *%%OVMF|ovmf%%-TPM*.
4. Speichern Sie die Änderungen und starten Sie die %%VM|vm%%.

#### Upgrade-Methoden

<Tabs>
  <TabItem value="In-place-Upgrade" label="In-place-Upgrade">
    <WindowsUpgradeInPlace />
  </TabItem>

  <TabItem value="Saubere Installation" label="Saubere Installation">
    <WindowsUpgradeCleanInstall />
  </TabItem>
</Tabs>

## Erweitern von Windows-VM-vDisk-Partitionen

:::caution[Data Verlustrisiko]
Das Erweitern oder Ändern von %%vDisk|vdisk%% und Partitionslayouts kann zu unwiderruflichem Datenverlust führen, wenn es nicht sorgfältig durchgeführt wird. Erstellen Sie immer ein vollständiges Backup oder Snapshot Ihrer VM, bevor Sie fortfahren.
:::

Nachdem Sie Ihren %%vDisk|vdisk%% gemäß den Schritten in [vDisk erweitern](../create-virtual-machines/vm-setup.mdx#expand-a-vdisk) erweitert haben, können Sie auf ein Problem stoßen, bei dem die standardmäßige Wiederherstellungspartition von Windows Sie daran hindert, Ihre Systempartition (C:) zu erweitern, um den neuen Speicherplatz zu nutzen. Um dieses Problem zu lösen, müssen Sie die Wiederherstellungspartition löschen und dann die Windows-Datenträgerverwaltung verwenden, um die Partition zu erweitern.

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![Resize vDisk 2](/img/Resize_vdisk_2.png)
</div>

Nachdem Sie die anfängliche %%vDisk|vdisk%%-Erweiterung abgeschlossen haben:

1. Starten Sie Ihre Windows-VM.
2. **Öffnen Sie die Eingabeaufforderung:** Drücken Sie die Windows-Taste, tippen Sie `cmd` ein und drücken Sie Enter.
3. **Starten Sie diskpart:** Geben Sie `diskpart` ein und drücken Sie Enter.
4. **Listen Sie die Datenträger auf:** Geben Sie `list disk` ein und drücken Sie Enter.
5. **Wählen Sie den erweiterten Datenträger aus:** Geben Sie `select disk #` ein und ersetzen Sie `#` durch die richtige Datenträgernummer.
6. **Listen Sie die Partitionen auf:** Geben Sie `list partition` ein und drücken Sie Enter.
7. **Identifizieren Sie die Wiederherstellungspartition:** Suchen Sie nach der Wiederherstellungspartition, die nach Ihrer primären Partition kommt.
8. **Wählen und löschen Sie die Wiederherstellungspartition:**
   - Geben Sie `select partition #` ein und ersetzen Sie `#` durch die Nummer der Wiederherstellungspartition.
   - Geben Sie `delete partition override` ein und drücken Sie Enter.
9. **Erweitern Sie die C:-Partition:**
   - Klicken Sie mit der rechten Maustaste auf das Startmenü und wählen Sie **Datenträgerverwaltung**.
   - Klicken Sie mit der rechten Maustaste auf die Partition, die Sie erweitern möchten (normalerweise C:), und wählen Sie **Volume erweitern...**.
   - Folgen Sie den Aufforderungen, um den nicht zugewiesenen Speicherplatz zu nutzen.

<div className="flex-container" style={{ margin: 'auto', maxWidth: '800px'}}>
  <figure className="flex-figure">
    <img src="/img/Resize_vdisk_3.png" alt="vDisk 3 anpassen" />
  </figure>

  <figure className="flex-figure">
    <img src="/img/Resize_vdisk_4.png" alt="vDisk 4 anpassen" />
  </figure>
</div>

:::tip
Sie müssen die Wiederherstellungspartition nur entfernen, wenn sie den Zugriff auf den angrenzenden freien Speicherplatz blockiert. Wenn der nicht zugewiesene Speicherplatz bereits neben Ihrer C: Partition liegt, können Sie sie erweitern, ohne etwas zu löschen.
:::

:::warning
Änderungen an Festplattenpartitionen sind dauerhaft und können nicht rückgängig gemacht werden. Stellen Sie sicher, dass Ihre Daten gesichert sind, bevor Sie Partitionen löschen.
:::
