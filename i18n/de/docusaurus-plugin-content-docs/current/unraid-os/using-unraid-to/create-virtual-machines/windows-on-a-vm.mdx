---
sidebar_position: 3
sidebar_label: Windows in einer VM
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import WindowsVirtioAutomatic from './partials/windows-virtio-automatic.mdx';
import WindowsVirtioManual from './partials/windows-virtio-manual.mdx';
import WindowsUpgradeInPlace from './partials/windows-upgrade-in-place.mdx';
import WindowsUpgradeCleanInstall from './partials/windows-upgrade-clean-install.mdx';

# Windows in einer VM

Windows ist eines der beliebtesten Gastbetriebssysteme für Unraid-Benutzer, insbesondere für Gaming, Produktivität und Unterstützung älterer Anwendungen. Hier sind wesentliche Überlegungen zum Betrieb von Windows-VMs.

:::caution[Before Sie beginnen]
- Microsoft beendete den Support für Windows 7 im Januar 2020, Windows 8.1 im Januar 2023 und Windows 10 im Oktober 2025. Verwenden Sie Windows 11 (oder später) oder Server 2022 (oder später) für laufende Sicherheitsupdates.
- Testen Sie immer die Stabilität von %%VM|vm%%, bevor Sie Ihre Windows-Lizenz aktivieren.
- Für %%GPU-Passthrough|gpu-passthrough%% verwenden Sie %%OVMF|ovmf%% (%%UEFI|uefi%%) BIOS mit Windows 11 oder neuer.
:::

### Unterstützte Konfigurationen

| Windows-Ausgabe     | Empfohlenes BIOS   | Maschinentyp                    | Anmerkungen                      |
| ------------------- | ------------------ | ------------------------------- | -------------------------------- |
| Windows 11          | %%OVMF\|ovmf%% TPM | %%Q35\|q35%%                    | Benötigt TPM 2.0 Emulation       |
| Windows Server 2022 | %%OVMF\|ovmf%%     | %%Q35\|q35%%                    | Ideal für Unternehmens-Workloads |
| Windows 10          | %%OVMF\|ovmf%%     | %%Q35\|q35%%                    | Veraltet (EOL Oktober 2025)      |
| Windows Server 2019 | %%OVMF\|ovmf%%     | %%i440fx\|i440fx%%/%%Q35\|q35%% | Kompatibel, aber nicht empfohlen |

---

### VirtIO-Treiberverwaltung

Windows benötigt paravirtualisierte Treiber für eine optimale Leistung mit Unraid's Virtualisierungsstack.

Um Treiber zu installieren oder zu aktualisieren:

<Tabs>
  <TabItem value="Autostart" label="Automatische Installation">
    <WindowsVirtioAutomatic />
  </TabItem>

  <TabItem value="Manuell" label="Manuelles Update">
    <WindowsVirtioManual />
  </TabItem>
</Tabs>

:::tip
Using Unraid 7 or later, you can automatically inject %%VirtIO|virtio%% drivers during the Windows installation. Enable this in ***VM Settings → Advanced Options***.
:::

---

### Einrichten des Ruhemodus

Hibernation lets you save your entire Windows %%VM|vm%% state - including open applications and documents - to disk. This allows you to power off the %%VM|vm%% without losing any work. When you resume, Windows restores everything exactly as you left it, skipping the normal boot process. This feature is handy when you need to reboot or power down your Unraid host or want to save energy while keeping your %%VM|vm%%'s state intact.

:::note[Benefits of hibernation]
- Energie sparen, indem inaktive %%VM|vm%% ausgeschaltet werden, ohne Fortschritte zu verlieren
- Arbeit schnell nach Wartung oder Updates am Host wieder aufnehmen
- Verringern Sie den Verschleiß von SSDs im Vergleich zu häufigen vollständigen Ausschaltungen und Neustarts
:::

To use hibernation reliably, you must install the %%QEMU|qemu%% %%Guest Agent|guest-agent%% in your Windows %%VM|vm%%. This agent allows Unraid to communicate with the %%VM|vm%% for advanced operations like hibernation, shutdown, and live statistics reporting.

<details>
  <summary><strong>Wie installiert man den %%QEMU|qemu%% %%Guest Agent|guest-agent%%</strong> – Klicken Sie hier zum Ein-/Ausklappen</summary>

  1. Starten Sie Ihre Windows-%%VM|vm%% mit der eingehängten %%VirtIO|virtio%%-Treiber-ISO.
  2. Öffnen Sie den **Datei-Explorer** und navigieren Sie zu den %%VirtIO|virtio%%-Treibern.
  3. Öffnen Sie den Ordner `guest-agent`.
  4. Run `qemu-ga-x64.msi` to install the agent. (You may briefly see a command box; no confirmation dialog will appear.)
</details>

<details>
  <summary><strong>Wie aktiviert man den Ruhemodus in Windows</strong> – Klicken Sie hier zum Ein-/Ausklappen</summary>

  1. Öffnen Sie die **Systemsteuerung** und suchen Sie nach **Energieoptionen**.
  2. Klicken Sie auf **Funktion des Ein-/Ausschalters festlegen**.
  3. Klicken Sie auf **Einstellungen ändern, die momentan nicht verfügbar sind**, um Einstellungen zum Ausschalten freizuschalten.
  4. Markieren Sie die Option **Ruhezustand**.
  5. Klicken Sie auf **Änderungen speichern**.

  Die Option **Ruhezustand** wird jetzt im Windows-Energie-Menü angezeigt.
</details>

:::important[What if hibernation fails?]
If your %%VM|vm%% fails to hibernate or resume properly, you may lose unsaved work or face a failed restore. Always save important data before hibernating. If issues persist, ensure the %%QEMU|qemu%% %%Guest Agent|guest-agent%% is installed and updated, and check the Windows event log for errors.
:::

---

### Leistungsoptimierung

Optimizing your Windows %%VM|vm%% can improve responsiveness, reduce disk usage, and avoid common issues with device passthrough or shutdown. These adjustments are optional and can be applied as needed.

#### Schnellstart deaktivieren

Disabling fast startup can help prevent issues with device passthrough. It ensures your %%VM|vm%% hardware initializes correctly every time it boots. While this setting is designed for physical PCs, in a virtual environment, it can often cause more problems than benefits.

<details>
  <summary><strong>Wie man den Schnellstart deaktiviert</strong> – Klicken Sie hier zum Ein-/Ausklappen</summary>

  1. Öffnen Sie die **Systemsteuerung** und suchen Sie nach **Energie**.
  2. Klicken Sie auf **Funktion des Ein-/Ausschalters festlegen**.
  3. Klicken Sie auf **Einstellungen ändern, die momentan nicht verfügbar sind**.
  4. Deaktivieren Sie unter **Ausschaltoptionen** die Option **Schnellstart aktivieren**.
  5. Klicken Sie auf **Änderungen speichern**.
</details>

#### hiberfil.sys deaktivieren

Hibernation in Windows creates a large hidden file called `hiberfil.sys`. This file can consume significant disk space and increase disk activity in your %%VM|vm%%. If you don't rely on hibernation, disabling it will free up storage and reduce unnecessary I/O activity.

<details>
  <summary><strong>Wie man den Ruhezustand deaktiviert und hiberfil.sys entfernt</strong> – Klicken Sie hier zum Ein-/Ausklappen</summary>

  1. Klicken Sie mit der rechten Maustaste auf die **Start**-Taste und wählen Sie **Windows Terminal (Admin)** oder **Eingabeaufforderung (Admin)**.
  2. Geben Sie ein: `powercfg /h off`
  3. Press Enter and reboot your %%VM|vm%%. The `hiberfil.sys` file will be removed from your C:\ drive.
</details>

#### Windows-Indizierung deaktivieren

Windows Search indexing continuously scans your %%virtual machine|vm%%'s storage to catalog files for faster search results. However, on a %%virtual machine|vm%%, this can cause unnecessary disk I/O, slow down performance, and increase wear on your physical storage, especially SSDs in your [%%cache pool|cache-pool%%](../manage-storage/cache-pools.mdx).

<details>
  <summary><strong>Wie man die Windows-Indizierung deaktiviert</strong> – Klicken zum Ein-/Ausklappen</summary>

  1. Drücken Sie **Windows + R**, um den Ausführen-Dialog zu öffnen, geben Sie `services.msc` ein und drücken Sie Enter.
  2. Im Dienstefenster scrollen Sie nach unten und klicken mit der rechten Maustaste auf **Windows Search**, dann wählen Sie **Beenden**.
  3. Doppelklicken Sie auf **Windows Search**, ändern Sie den **Starttyp** auf **Deaktiviert** und klicken Sie auf **OK**.
</details>

#### Automatische Festplattendefragmentierung deaktivieren

Windows is designed to defrag physical hard drives on a regular schedule automatically. On a %%VM|vm%% - especially when using SSD storage or thin-provisioned %%vDisks|vdisk%% - automatic defragmenting is unnecessary and can also reduce disk lifespan and degrade performance.

<details>
  <summary><strong>Wie man die automatische Festplattendefragmentierung deaktiviert</strong> – Klicken zum Ein-/Ausklappen</summary>

  1. Öffnen Sie den **Datei-Explorer**, klicken Sie mit der rechten Maustaste auf das C:-Laufwerk und wählen Sie **Eigenschaften**.
  2. Gehen Sie auf die Registerkarte **Tools** und klicken Sie auf **Optimieren**.
  3. Klicken Sie auf **Einstellungen ändern**.
  4. Deaktivieren Sie **Planmäßig ausführen** und klicken Sie auf **OK**.
</details>

#### Hochleistungsmodus aktivieren

Power management features in Windows are designed for laptops and desktops to save energy. In a %%VM|vm%% environment, these features can unnecessarily throttle performance or suspend your %%VM|vm%%, making it less responsive and harder to manage.

Die Aktivierung des Modus **Hochleistung** stellt sicher, dass Ihre %%VM|vm%% jederzeit mit voller Geschwindigkeit läuft und weniger wahrscheinlich Pausen oder unerwartete Aussetzungen auftreten.

<details>
  <summary><strong>Wie man den Hochleistungsmodus aktiviert</strong> – Klicken zum Ein-/Ausklappen</summary>

  1. Öffnen Sie die **Systemsteuerung** und suchen Sie nach "Energie".
  2. Klicken Sie auf **Energieplan auswählen**.
  3. Wählen Sie **Hochleistung** unter **Bevorzugte Pläne** aus.
</details>

#### Zugriff auf Remote-Desktop aktivieren

Remote desktop protocol (RDP) allows you to access your Windows %%VM|vm%% from another device. It offers better performance and compatibility compared to %%VNC|vnc-session%%. Note that RDP is supported only on Windows Professional and Enterprise editions. Also, your Windows user account **must** have a password set.

:::caution
RDP is not available on Windows Home editions. Always set a secure password for your Windows user account before enabling RDP.
:::

<details>
  <summary><strong>Wie man den Remote-Desktop-Zugriff (RDP) aktiviert</strong> – Klicken zum Ein-/Ausklappen</summary>

  Um RDP-Zugriff zu aktivieren, folgen Sie diesen Schritten:

  1. Drücken Sie **Windows + I**, um die Einstellungen zu öffnen, navigieren Sie dann zu ***System → Info*** und klicken Sie auf **Erweiterte Systemeinstellungen**.
  2. Im Fenster Systemeigenschaften klicken Sie auf die Registerkarte **Remote**, dann wählen Sie **Remote Desktop aktivieren**.
  3. Klicken Sie auf **OK**, um die Änderungen zu bestätigen.
  4. Von Ihrem Client-Gerät aus verwenden Sie einen Microsoft RDP-Client, um sich mit der **IP-Adresse der %%VM|vm%%** (nicht mit dem Unraid-Server) zu verbinden.

  :::tip
  Offizielle Microsoft RDP-Clients sind für Windows, Mac, Android und iOS verfügbar. Stellen Sie sicher, dass Ihr %%VM|vm%% in einem Netzwerkbridge ist, das LAN-Zugriff ermöglicht.
  :::
</details>

#### HDMI-Audio mit MSI-Interrupts beheben

If you're having trouble with HDMI audio in a Windows %%VM|vm%% that uses %%GPU passthrough|gpu-passthrough%% (which often occurs with NVIDIA graphics cards), enabling Message Signaled Interrupts (MSI) might help. MSI enhances the way interrupts are managed for passed-through devices.

<details>
  <summary><strong>Wie aktiviert man MSI-Interrupts</strong> – Klicken zum Ein-/Ausklappen</summary>

  :::caution
  Sichern Sie Ihre %%VM|vm%%, bevor Sie Änderungen an der Registrierung vornehmen. Falsche Modifikationen können Systeminstabilität verursachen.
  :::

  1. **MSI-Fähigkeit überprüfen:**
     - Starten Sie Ihre %%VM|vm%% mit aktiviertem %%GPU-Passthrough|gpu-passthrough%%.
     - Access Unraid via [WebTerminal or SSH](../../system-administration/advanced-tools/command-line-interface.mdx).
     - Führen Sie den Befehl `lspci -v -s 01:00.0` aus (ersetzen Sie `01:00.0` durch die PCI-Adresse Ihrer GPU).
     - Suchen Sie nach der Zeile: `Capabilities: [68] MSI: Enable+ Count=1/1 Maskable- 64bit+`.

  2. **MSI in Windows einschalten:**
     - If MSI shows `Enable-`, follow [Microsoft's guide](https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/enabling-message-signaled-interrupts-in-the-registry) or use the [MSI Mode Utility](https://forums.guru3d.com/threads/windows-line-based-vs-message-signaled-based-interrupts-msi-tool.378044/) to modify your Windows registry settings.
     - Starten Sie die %%VM|vm%% nach den Änderungen neu.

  Für weitere technische Details siehe [VFIO-Interrupts erklärt](https://vfio.blogspot.com/2014/09/vfio-interrupts-and-how-to-coax-windows.html).
</details>

---

### Upgrade zu Windows 11

Windows 11 requires TPM 2.0 and Secure Boot. Unraid's **OVMF-TPM** BIOS provides the virtual TPM support needed for these requirements.

:::important[Before aktualisierung]
- Erstellen Sie eine vollständige Sicherung Ihrer %%VM|vm%%.
- Stellen Sie sicher, dass Unraid Version 6.10 oder später ausgeführt wird.
- Überprüfen Sie, ob Ihre Windows 10 %%VM|vm%% die [Systemanforderungen von Windows 11](https://www.microsoft.com/en-us/windows/windows-11-specifications) erfüllt.
:::

Um TPM-Unterstützung hinzuzufügen:

1. Fahren Sie Ihren Windows 10 %%VM|vm%% herunter.
2. Bearbeiten Sie die %%VM|vm%%-Einstellungen.
3. Ändern Sie das **BIOS** von *%%OVMF|ovmf%%* zu *%%OVMF|ovmf%%-TPM*.
4. Speichern Sie die Änderungen und starten Sie die %%VM|vm%%.

#### Upgrade-Methoden

<Tabs>
  <TabItem value="In-place-Upgrade" label="In-place-Upgrade">
    <WindowsUpgradeInPlace />
  </TabItem>

  <TabItem value="Saubere Installation" label="Saubere Installation">
    <WindowsUpgradeCleanInstall />
  </TabItem>
</Tabs>

## Erweitern von Windows-VM-vDisk-Partitionen

:::caution[Data loss risk]
Expanding or modifying %%vDisk|vdisk%% and partition layouts can lead to irreversible data loss if not done carefully. Always create a full backup or snapshot of your %%VM|vm%% before proceeding.
:::

After you expand your %%vDisk|vdisk%% following the steps in [Expand a vDisk](../create-virtual-machines/vm-setup.mdx#expand-a-vdisk), you may encounter an issue where Windows’ default recovery partition blocks you from easily expanding your system (C:) partition to utilize the new space. To resolve this issue, you need to delete the recovery partition and then use Windows Disk Management to expand the partition.

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![Resize vDisk 2](/img/Resize_vdisk_2.png)
</div>

Nachdem Sie die anfängliche %%vDisk|vdisk%%-Erweiterung abgeschlossen haben:

1. Starten Sie Ihre Windows-VM.
2. **Öffnen Sie die Eingabeaufforderung:** Drücken Sie die Windows-Taste, tippen Sie `cmd` ein und drücken Sie Enter.
3. **Starten Sie diskpart:** Geben Sie `diskpart` ein und drücken Sie Enter.
4. **Listen Sie die Datenträger auf:** Geben Sie `list disk` ein und drücken Sie Enter.
5. **Wählen Sie den erweiterten Datenträger aus:** Geben Sie `select disk #` ein und ersetzen Sie `#` durch die richtige Datenträgernummer.
6. **Listen Sie die Partitionen auf:** Geben Sie `list partition` ein und drücken Sie Enter.
7. **Identifizieren Sie die Wiederherstellungspartition:** Suchen Sie nach der Wiederherstellungspartition, die nach Ihrer primären Partition kommt.
8. **Wählen und löschen Sie die Wiederherstellungspartition:**
   - Geben Sie `select partition #` ein und ersetzen Sie `#` durch die Nummer der Wiederherstellungspartition.
   - Geben Sie `delete partition override` ein und drücken Sie Enter.
9. **Erweitern Sie die C:-Partition:**
   - Klicken Sie mit der rechten Maustaste auf das Startmenü und wählen Sie **Datenträgerverwaltung**.
   - Klicken Sie mit der rechten Maustaste auf die Partition, die Sie erweitern möchten (normalerweise C:), und wählen Sie **Volume erweitern...**.
   - Folgen Sie den Aufforderungen, um den nicht zugewiesenen Speicherplatz zu nutzen.

<div className="flex-container" style={{ margin: 'auto', maxWidth: '800px'}}>
  <figure className="flex-figure">
    <img src="/img/Resize_vdisk_3.png" alt="vDisk 3 anpassen" />
  </figure>

  <figure className="flex-figure">
    <img src="/img/Resize_vdisk_4.png" alt="vDisk 4 anpassen" />
  </figure>
</div>

:::tip
You only need to remove the recovery partition if it blocks access to adjacent free space. If the unallocated space is already next to your C: partition, you can extend it without deleting anything.
:::

:::warning
Changes made to disk partitions are permanent and cannot be undone. Ensure that your data is securely backed up before deleting any partitions.
:::
