---
sidebar_position: 2
sidebar_label: Unbereinigt heruntergefahrene Systeme
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# Unbereinigt heruntergefahrene Systeme

An unclean shutdown happens when Unraid detects that the %%array|array%% was not properly stopped before the system powered off. This situation can trigger an automatic %%parity check|parity-check%% during the next boot to ensure data integrity.

:::important[Recommendations um unsaubere Abschaltungen zu verhindern]

Durch einige proaktive Maßnahmen können Sie unbereinigte Herunterfahrten vermeiden oder erkennen:

- **Verwenden Sie eine USV:** Halten Sie Ihren Server mit einer unterbrechungsfreien Stromversorgung (USV) verbunden und richten Sie diese ein, um einen kontrollierten Shutdown einzuleiten, wenn der Batteriestrom niedrig wird.
- **Versuchen Sie ein geordnetes Herunterfahren:** Wenn Ihr Server nicht reagiert, drücken Sie kurz den Netzschalter, um ein sicheres Herunterfahren zu initiieren. Halten Sie den Knopf nicht gedrückt, da dies ein hartes Ausschalten erzwingt und zu einem nicht ordnungsgemäßen Herunterfahren führt.
- **Aktivierung des persistenten Loggings:** Gehen Sie zu ***Einstellungen → Syslog-Server***, um Logging zu aktivieren, das nach einem Neustart erhalten bleibt. Weitere Details finden Sie unter [Persistente Logs (Syslog-Server)](../diagnostics/capture-diagnostics-and-logs.mdx#persistent-logs-syslog-server).
- **Diagnosen für den Support anhängen:** Wenn ein unsauberer Shutdown auftritt, versucht Unraid, Diagnosen unter `/log/diagnostics.zip` auf Ihrem Flash-Gerät zu speichern. Hängen Sie diese Datei an Forumsbeiträge an, wenn Sie Unterstützung suchen.

:::

:::tip[UPS beste Konfigurationspraktiken]

Eine gut konfigurierte USV ist Ihre beste Verteidigung gegen unbereinigte Herunterfahrten, die durch Stromausfall verursacht werden.

- **Verbinden Sie die USV über USB** mit Ihrem Unraid-Server.
- **Aktivieren Sie die USV-Unterstützung** unter ***Einstellungen → USV-Einstellungen***.
- **Configure shutdown timeouts:** Set the UPS to trigger a controlled shutdown before the battery runs low. Adjust the "Battery runtime left" or "Battery charge level" thresholds to provide enough time for Unraid to [stop the %%array|array%%](../../using-unraid-to/manage-storage/array/overview.mdx#startstop-the-array) and power down safely.
- **Testen Sie Ihre Konfiguration:** Simulieren Sie einen Stromausfall, um sicherzustellen, dass die USV und Unraid korrekt reagieren.

Schauen Sie sich das [NUT Plugin](https://unraid.net/community/apps/c/plugins/p4?srsltid=AfmBOop675PrJQW4iqb4JBN3GyPpwDDiSmnZReq78t27XyxkFdMX8inO#:~:text=NUT%20%2D%20Network%20UPS%20Tools) für eine bessere Kompatibilität mit fortschrittlicheren USV-Modellen oder nicht unterstützter Hardware an.

:::

## Events that cause unclean shutdowns

Understanding the main triggers for unclean shutdowns helps you prevent them. The following sections cover the most common scenarios and their solutions.

### Unerwarteter Stromausfall

Stromausfälle sind einer der Hauptgründe für unsaubere Abschaltungen. Schützen Sie Ihr System mit einer richtig konfigurierten USV, die Unraid automatisch herunterfahren kann, bevor der Akku leer ist.

:::note

Unraid supports most UPS units using the %%apcupsd Protocol|apcupsd%% protocol (APC and CyberPower are usually compatible). If your UPS isn't supported, consider using the Network UPS Tools (NUT) plugin from Community Applications.

:::

### Fehler des Flash-Laufwerks

Der Status des %%array|array%% wird auf Ihrem USB-Flash-Laufwerk gespeichert. Wenn das Flash-Laufwerk nicht verfügbar oder schreibgeschützt wird, kann Unraid den Herunterfahrstatus nicht aktualisieren, selbst wenn das %%array|array%% korrekt stoppt. Dies führt dazu, dass beim nächsten Start ein unsauberes Herunterfahren erkannt wird.

### Terminalsitzungen öffnen

Unraid wartet während des Herunterfahrens auf alle offenen Terminal- oder SSH-Sitzungen. Wenn diese Sitzungen aktiv bleiben und der Shutdown-Timer abläuft, erfolgt ein erzwungenes Herunterfahren.

:::tip

Das [Dynamix Stop Shell](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository) Plugin kann automatisch lange offene Bash- oder SSH-Sitzungen schließen und so für ein reibungsloses Herunterfahren sorgen. Seien Sie jedoch vorsichtig, wenn noch Schreibvorgänge auf das %%array|array%% ausgeführt werden.

:::

---

## Timeout für virtuelle Maschinen

Die ordnungsgemäße Konfiguration von Abschalt-Timeouts ist unerlässlich, um sicherzustellen, dass Ihr Unraid-Server alle Dienste effektiv stoppen kann. Dies verhindert unsaubere Abschaltungen, insbesondere bei Stromausfall oder Wartung. Der wichtigste Schritt besteht darin, Ihre %%VMs|vm%% so zu konfigurieren, dass sie in den Ruhezustand versetzt werden, anstatt herunterzufahren. Dieser Ansatz beseitigt viele Timeout-bezogene Probleme.

### Einrichtung des VM-Ruhezustands

:::tip[Use VM-Ruhezustand]

Für die zuverlässigsten und schnellsten Abschaltungen konfigurieren Sie Ihre %%VMs|vm%% so, dass sie ruhezustand anstelle des Herunterfahrens verwenden. Dies ist besonders wichtig für Windows-%%VMs|vm%%, ist aber für alle %%VM|vm%%-Typen von Vorteil.

Wir empfehlen die Verwendung des Ruhezustands, weil er:

- **Speichert den VM-Zustand sofort** - Kein Warten darauf, dass das Gast-Betriebssystem herunterfährt.
- **Verhindert Datenverlust** - Kein Risiko, Updates oder ungespeicherte Arbeiten zu unterbrechen.
- **Vermeidet Timeout-Probleme** - Der Ruhezustand erfolgt nahezu augenblicklich.
- **Schnellere Wiederherstellung** - %%VMs|vm%% nehmen genau dort wieder auf, wo sie aufgehört haben.

Herunterfahren kann problematisch sein, weil:

- Windows möglicherweise Dialogfelder ("Dieses Dokument speichern?") anzeigt, die das Herunterfahren unbefristet anhalten.
- Windows-Updates können während des Herunterfahrens 10+ Minuten in Anspruch nehmen.
- Wenn das Timeout abläuft, erzwingt Unraid ein Bedingung-killing der %%VM|vm%%, was möglicherweise in fortlaufende Windows-Updates, ungespeicherte Dokumente, Anwendungsdaten und Dateisysteme im Gastbetriebssystem korruptieren könnte.

**Kritische Anforderung:** Stellen Sie sicher, dass der %%QEMU|qemu%% %%Guest Agent|guest-agent%% in der %%VM|vm%% installiert ist, damit der Ruhezustand ordnungsgemäß funktioniert.

:::

Um den VM-Ruhezustand zu aktivieren:

<Tabs>
  <TabItem value="windows" label="Windows-VMs" default>
    1. **Laden Sie %%QEMU|qemu%% %%Guest Agent|guest-agent%% herunter:**
       - Gehen Sie zur [VirtIO-Treiber-Downloadseite](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/).
       - Laden Sie die neueste `virtio-win.iso`-Datei herunter.

    2. **Installieren Sie in Windows %%VM|vm%%:**
       - Binden Sie die `virtio-win.iso` in Ihrer %%VM|vm%% ein.
       - Führen Sie den Installer von der eingebundenen ISO aus.
       - Install both %%VirtIO|virtio%% drivers AND %%QEMU|qemu%% %%Guest Agent|guest-agent%%.
       - Starten Sie die %%VM|vm%% neu.

    3. **Konfigurieren in Unraid:**
       - Gehen Sie zu Ihren %%VM|vm%%-Einstellungen im ***VMs***-Tab.
       - Stellen Sie **Abschaltaktion** auf **Ruhezustand** ein.
       - Klicken Sie auf **Übernehmen**.
  </TabItem>

  <TabItem value="linux" label="Linux-VMs">
    1. **Installieren Sie %%QEMU|qemu%% %%Guest Agent|guest-agent%%:**

    ```bash
    # Ubuntu/Debian
    sudo apt install qemu-guest-agent

    # CentOS/RHEL/Fedora
    sudo yum install qemu-guest-agent
    # or
    sudo dnf install qemu-guest-agent
    ```

    2. **Aktivieren Sie den Dienst:**
       ```bash
       sudo systemctl enable qemu-guest-agent
       sudo systemctl start qemu-guest-agent
       ```

    3. **Konfigurieren in Unraid:**
       - Setzen Sie **Abschaltaktion** in Ihren %%VM|vm%%-Einstellungen auf **Ruhezustand**.
  </TabItem>

  <TabItem value="Appliance" label="Appliance-VMs">
    Einige %%VMs|vm%%, wie Home Assistant, erlauben die Installation zusätzlicher Software nicht. Für diese:

    - Lassen Sie **Abschaltaktion** auf **Shutdown** eingestellt.
    - Verwenden Sie längere Timeout-Werte (siehe Timeout-Empfehlungen unten).
    - Betrachten Sie die Risiken des erzwungen-Tötens dieser %%VMs|vm%% während Updates.

    :::note[Warum Appliance-VMs unterschiedlich sind]
    Appliance-%%VMs|vm%% sind dazu ausgelegt, spezielle Software auszuführen und erlauben oft nicht die Installation zusätzlicher Pakete, wie dem %%QEMU|qemu%% %%Guest Agent|guest-agent%%. Dies bedeutet, dass kein Ruhezustand verfügbar ist, weshalb Sie sich auf eine ordnungsgemäße Timeout-Konfiguration verlassen müssen.
    :::
  </TabItem>
</Tabs>

Zum Verifizieren, dass Ihr Ruhezustand funktioniert, starten Sie Ihre %%VM|vm%% und öffnen einige Anwendungen. Beenden Sie es dann von Unraid aus. Wenn Sie es wieder starten, sollte es mit allen Anwendungen weiterhin geöffnet sein.

:::warning[Guest Agent ist kritisch]

Without the %%QEMU|qemu%% %%Guest Agent|guest-agent%% installed, hibernation may not work properly. In that case, the %%VM|vm%% will revert to shutdown mode, consuming the full timeout period.

:::

---

### Timeout-Konfiguration

In diesem Abschnitt behandeln wir, wie man Timeouts für verschiedene Systeme und Prozesse konfiguriert. Diese Informationen sind wichtig, um sicherzustellen, dass Ihre %%VMs|vm%% und Docker-Container ohne Datenverlust ordnungsgemäß heruntergefahren werden.

| Einstellung                                  | Standard | Wann erhöhen                                               | Wo einstellen                                                   |
| -------------------------------------------- | -------- | ---------------------------------------------------------- | --------------------------------------------------------------- |
| %%VM\|vm%% Herunterfahren-Zeitüberschreitung | 60s      | 300s, wenn kein Ruhezustand genutzt wird und VMs abstürzen | ***Einstellungen → VM-Manager → VM-Shutdown (Erweitert)***      |
| Docker-Container-Stop-Timeout                | 10s      | 30s, wenn Container beim Stoppen abstürzen                 | ***Einstellungen → Docker (Erweitert)***                        |
| Allgemeiner Shutdown-Timeout                 | 90s      | 180s bei unsauberen Abschaltungen, 300s+ mit VMs           | ***Einstellungen → Laufwerkseinstellungen → Shutdown-Timeout*** |

:::tip[When um Timeouts zu erhöhen]

Wenn Sie nicht saubere Abschaltungen oder abstürzende Container beim Herunterfahren erleben, ziehen Sie in Betracht, den allgemeinen Shutdown-Timeout auf **180 Sekunden** (oder **300+ Sekunden**, falls Sie mehrere %%VMs|vm%% haben) zu erhöhen. Dies gibt den Diensten mehr Zeit, um ordentlich herunterzufahren.

:::

### Abschaltsequenz

Beim Herunterfahren erfolgt der Prozess in folgender Reihenfolge:

1. **%%VM|vm%%-Abschaltung**: Dies umfasst drei Phasen, und jede kann bis zum VM-Timeout dauern:

   - Phase 1: Alle pausierten %%VMs|vm%% fortsetzen
   - Phase 2: %%VMs|vm%%, die für den Ruhezustand eingerichtet sind, in den Ruhezustand versetzen
   - Phase 3: Alle verbleibenden %%VMs|vm%% herunterfahren

   Alle %%VMs|vm%% in jeder Phase werden gleichzeitig verarbeitet, was bedeutet, dass die gesamte Abschaltzeit berechnet werden kann als: VM-Timeout × 3.

2. Docker containers stop simultaneously (total time = Docker timeout).

3. Other services include tasks like LXC containers and third-party plugins, which usually take a few seconds.

4. Array shutdown: drives need to be unmounted and data synced; this typically takes 15-30 seconds.

:::tip[Calculate Ihr allgemeines Abschalt-Timeout]

**Formel:** Ihr allgemeines Abschalt-Timeout sollte größer sein als:

```
(VM timeout × 3) + (Docker timeout) + (Other services) + 15-30 seconds
```

**Beispiel:** Wenn wir der Formel folgen, würde es so aussehen: `(300 × 3) + 30 + 10 + 30 = 970 Sekunden (über 16 Minuten)`.

**Empfehlung:** Mindestens **180 Sekunden (3 Minuten)** als Minimum und **300+ Sekunden (5+ Minuten)**, wenn Sie mehrere %%VMs|vm%% oder komplexe Container haben.

:::

If all your %%VMs|vm%% are set to hibernate rather than shutting down, then the VM timeout is less critical since hibernation is nearly immediate. You could use a lower VM timeout (for example, 60-120 seconds) as a backup for any %%VMs|vm%% that don't support hibernation.

---

### Detaillierte Konfigurationsanleitung

Dieser Abschnitt bietet ausführliche Informationen zur Konfiguration von Timeouts für verschiedene Systemkomponenten. Jede Timeout-Einstellung arbeitet zusammen, um sicherzustellen, dass Ihr Server ohne Datenverlust ordnungsgemäß heruntergefahren wird.

#### VM timeouts

Configure VM shutdown timeouts in ***Settings → VM Manager → VM Shutdown*** (enable Advanced view).

**Wie es funktioniert:**

- %%VMs|vm%% durchlaufen drei Abschaltphasen, die jeweils das vollständige VM-Timeout benötigen
- Alle %%VMs|vm%% in jeder Phase werden gleichzeitig verarbeitet
- Gesamt-VM-Abschaltzeit = VM-Timeout × 3

**Häufige Probleme:**

- **Unterbrechungen von Windows-Updates:** Updates während des Herunterfahrens können beschädigt werden, wenn das Timeout abläuft.
- **Ungespeicherte Arbeit:** Dialogfelder, die zum Speichern von Dokumenten auffordern, können das Herunterfahren unbegrenzt aufhalten.
- **Ruhezustandsfehler:** %%VMs|vm%% ohne %%QEMU|qemu%% %%Guest Agent|guest-agent%% werden möglicherweise beim Ruhezustand fehlschlagen und das vollständige Timeout verwenden.

:::tip[VM timeout recommendations]

- **Primäre Empfehlung:** Konfigurieren Sie %%VMs|vm%% so, dass sie in den Ruhezustand versetzt werden, anstatt herunterzufahren (erfordert %%QEMU|qemu%% %%Guest Agent|guest-agent%%).
- **Wenn VMs während des Herunterfahrens abstürzen:** Erhöhen Sie das Timeout auf **300 Sekunden (5 Minuten)** für Windows-%%VMs|vm%%.
- **Windows-Updates:** Stellen Sie Windows so ein, dass es Updates beim Starten anstatt beim Herunterfahren installiert.
- **Test your setup:** Manually stop your %%VMs|vm%% to confirm they shut down or hibernate within the timeout period.

:::

:::warning[No safe timeout without hibernation]
Without hibernation and %%QEMU|qemu%% %%Guest Agent|guest-agent%%, there isn't a truly safe timeout for Windows %%VMs|vm%%. Dialog boxes or ongoing update installations could render any timeout inadequate, leading to forced shutdowns and data corruption risk.
:::

#### Docker timeouts

Configure Docker container stop timeouts in ***Settings → Docker*** (enable Advanced view).

**Wie es funktioniert:**

- Die meisten Container stoppen innerhalb von 10 Sekunden, aber einige benötigen möglicherweise mehr Zeit.
- Komplexe Container mit großen Datenbanken oder laufenden Operationen könnten zusätzliche Zeit benötigen.
- :::tip[Docker-Timeout-Empfehlungen]
- Wenn der Timer abläuft, werden Container erzwungenermaßen gestoppt.

:::tip[Docker timeout recommendations]

- Die **standardmäßigen 10 Sekunden** funktionieren gut für die meisten Container.
- **Wenn Container beim Stoppen abstürzen:** Erhöhen Sie das Timeout auf **30 Sekunden**.
- Monitor your containers during shutdown to identify any that consistently need more time.

:::

#### General timeouts

Configure the general shutdown timeout in ***Settings → Disk Settings → Shutdown time-out***.

**UPS considerations (most critical factor):**

- Your UPS must provide enough runtime to complete the full shutdown sequence before battery runs out.
- For **manual shutdown**, you can set longer timeouts since you control when shutdown starts.
- With **power outage shutdown**, your timeout is limited by UPS battery life.
- **Test your UPS** by simulating a power outage to ensure your server shuts down cleanly with time to spare.

:::tip[General timeout recommendations]

- **If you get unclean shutdowns:** Increase to **180 seconds (3 minutes)** for systems without %%VMs|vm%%.
- **For systems with %%VMs|vm%%:** Use **300+ seconds (5+ minutes)** if not using hibernation.
- **If using hibernation:** **180-300 seconds** is usually sufficient.
- Ensure timeouts are not longer than what your UPS can support during a power outage.

:::

#### Third-party services

**LXC containers:**
The LXC plugin has its own timeout setting for stopping containers. Like Docker containers, LXC containers typically stop within a few seconds, but some may require more time. Check the LXC plugin settings for the container stop timeout and include this timeout in your general shutdown timeout calculation.

**Other services:**
Some plugins or custom services may have their own shutdown procedures. Refer to the plugin documentation for specific timeout settings and incorporate them into your calculations.

**Aktualisierte Formel mit Drittanbieterdiensten:**

```
(VM timeout × 3) + (Docker timeout) + (LXC/other timeouts) + 15-30 seconds
```

**Dynamix Stop Shell plugin:**
If you frequently use SSH or terminal sessions, open sessions can prevent clean shutdowns because Unraid waits for them to close before proceeding.

Das [Dynamix Stop Shell](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository) Plugin hilft, indem es automatisch verbleibende Bash- oder SSH-Sitzungen schließt, wenn das Array gestoppt wird, und so für eine rechtzeitige Abschaltung sorgt.

Sie können es von [Community Applications (nach "Dynamix Stop Shell" suchen)](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository) installieren.

:::tip[When to use the plugin]

- Wenn Sie regelmäßig Terminalsitzungen offen haben.
- Um zu verhindern, dass vergessene SSH-Sitzungen das Herunterfahren verzögern.
- For automated cleanup during shutdown.

:::

:::caution

- Seien Sie vorsichtig, wenn Sie Skripte oder Prozesse in Terminalsitzungen laufen haben.
- Stellen Sie sicher, dass keine kritischen Schreibvorgänge vor dem Herunterfahren in Bearbeitung sind.
- The plugin will forcefully close sessions, which could interrupt work.

:::
