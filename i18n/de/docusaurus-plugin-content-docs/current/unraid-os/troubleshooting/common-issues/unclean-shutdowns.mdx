---
sidebar_position: 2
sidebar_label: Unbereinigt heruntergefahrene Systeme
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import UncleanShutdownsPower from "./partials/unclean-shutdowns/unexpected-power-loss.mdx";
import UncleanShutdownsFlash from "./partials/unclean-shutdowns/flash-drive-failure.mdx";
import UncleanShutdownsTerminal from "./partials/unclean-shutdowns/open-terminal-sessions.mdx";

# Unbereinigt heruntergefahrene Systeme

An unclean shutdown happens when Unraid detects that the %%array|array%% was not properly stopped before the system powered off. This situation can trigger an automatic %%parity check|parity-check%% during the next boot to ensure data integrity.

:::important[Recommendations um unsaubere Abschaltungen zu verhindern]

Durch einige proaktive Maßnahmen können Sie unbereinigte Herunterfahrten vermeiden oder erkennen:

- **Verwenden Sie eine USV:** Halten Sie Ihren Server mit einer unterbrechungsfreien Stromversorgung (USV) verbunden und richten Sie diese ein, um einen kontrollierten Shutdown einzuleiten, wenn der Batteriestrom niedrig wird.
- **Versuchen Sie ein geordnetes Herunterfahren:** Wenn Ihr Server nicht reagiert, drücken Sie kurz den Netzschalter, um ein sicheres Herunterfahren zu initiieren. Halten Sie den Knopf nicht gedrückt, da dies ein hartes Ausschalten erzwingt und zu einem nicht ordnungsgemäßen Herunterfahren führt.
- **Aktivieren Sie die persistente Protokollierung:** Gehen Sie zu ***Einstellungen → Syslog-Server***, um die Protokollierung zu aktivieren, die auch nach einem Neustart erhalten bleibt. Siehe [Persistente Protokolle (Syslog-Server)](../diagnostics/capture-diagnostics-and-logs.mdx#persistent-logs-syslog-server) für weitere Details.
- **Diagnosen für den Support anhängen:** Wenn ein unsauberer Shutdown auftritt, versucht Unraid, Diagnosen unter `/log/diagnostics.zip` auf Ihrem Flash-Gerät zu speichern. Hängen Sie diese Datei an Forumsbeiträge an, wenn Sie Unterstützung suchen.

:::

:::tip[UPS beste Konfigurationspraktiken]

Eine gut konfigurierte USV ist Ihre beste Verteidigung gegen unbereinigte Herunterfahrten, die durch Stromausfall verursacht werden.

- **Verbinden Sie die USV über USB** mit Ihrem Unraid-Server.
- **Aktivieren Sie Unterstützung für USV** in ***Einstellungen → USV-Einstellungen***.
- **Configure shutdown timeouts:** Set the UPS to trigger a controlled shutdown before the battery runs low. Adjust the "Battery runtime left" or "Battery charge level" thresholds to provide enough time for Unraid to [stop the %%array|array%%](../../using-unraid-to/manage-storage/array-configuration.mdx#startstop-the-array) and power down safely.
- **Testen Sie Ihre Konfiguration:** Simulieren Sie einen Stromausfall, um sicherzustellen, dass die USV und Unraid korrekt reagieren.

Schauen Sie sich das [NUT Plugin](https://unraid.net/community/apps/c/plugins/p4?srsltid=AfmBOop675PrJQW4iqb4JBN3GyPpwDDiSmnZReq78t27XyxkFdMX8inO#:~:text=NUT%20%2D%20Network%20UPS%20Tools) für eine bessere Kompatibilität mit fortschrittlicheren USV-Modellen oder nicht unterstützter Hardware an.

:::

## Konfigurierung der Shutdown-Timeouts

Properly configuring shutdown timeouts is essential to ensure your Unraid server can stop all services effectively, preventing unclean shutdowns, particularly during power loss or maintenance. Each component of your system - %%VM|vm%%s, Docker containers, and the overall %%array|array%% - has its own timeout setting that can be adjusted.

<Tabs>
  <TabItem value="leistung" label="Unerwarteter Stromausfall" default>
    <UncleanShutdownsPower />
  </TabItem>

  <TabItem value="Blitz" label="Fehler des Flash-Laufwerks">
    <UncleanShutdownsFlash />
  </TabItem>

  <TabItem value="Terminal" label="Terminalsitzungen öffnen">
    <UncleanShutdownsTerminal />
  </TabItem>
</Tabs>

---

## Timeout für virtuelle Maschinen

Die ordnungsgemäße Konfiguration von Abschalt-Timeouts ist unerlässlich, um sicherzustellen, dass Ihr Unraid-Server alle Dienste effektiv stoppen kann. Dies verhindert unsaubere Abschaltungen, insbesondere bei Stromausfall oder Wartung. Der wichtigste Schritt besteht darin, Ihre %%VMs|vm%% so zu konfigurieren, dass sie in den Ruhezustand versetzt werden, anstatt herunterzufahren. Dieser Ansatz beseitigt viele Timeout-bezogene Probleme.

### Einrichtung des VM-Ruhezustands

:::tip[Use VM-Ruhezustand]

Für die zuverlässigsten und schnellsten Abschaltungen konfigurieren Sie Ihre %%VMs|vm%% so, dass sie ruhezustand anstelle des Herunterfahrens verwenden. Dies ist besonders wichtig für Windows-%%VMs|vm%%, ist aber für alle %%VM|vm%%-Typen von Vorteil.

Wir empfehlen die Verwendung des Ruhezustands, weil er:

- **Speichert den VM-Zustand sofort** - Kein Warten darauf, dass das Gast-Betriebssystem herunterfährt.
- **Verhindert Datenverlust** - Kein Risiko, Updates oder ungespeicherte Arbeiten zu unterbrechen.
- **Vermeidet Timeout-Probleme** - Der Ruhezustand erfolgt nahezu augenblicklich.
- **Schnellere Wiederherstellung** - %%VMs|vm%% nehmen genau dort wieder auf, wo sie aufgehört haben.

Herunterfahren kann problematisch sein, weil:

- Windows möglicherweise Dialogfelder ("Dieses Dokument speichern?") anzeigt, die das Herunterfahren unbefristet anhalten.
- Windows-Updates können während des Herunterfahrens 10+ Minuten in Anspruch nehmen.
- Wenn das Timeout abläuft, erzwingt Unraid ein Bedingung-killing der %%VM|vm%%, was möglicherweise in fortlaufende Windows-Updates, ungespeicherte Dokumente, Anwendungsdaten und Dateisysteme im Gastbetriebssystem korruptieren könnte.

**Kritische Anforderung:** Stellen Sie sicher, dass der %%QEMU|qemu%% %%Guest Agent|guest-agent%% in der %%VM|vm%% installiert ist, damit der Ruhezustand ordnungsgemäß funktioniert.

:::

Um den VM-Ruhezustand zu aktivieren:

<Tabs>
  <TabItem value="windows" label="Windows-VMs" default>
    1. **Laden Sie %%QEMU|qemu%% %%Guest Agent|guest-agent%% herunter:**
       - Gehen Sie zur [VirtIO-Treiber-Downloadseite](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/).
       - Laden Sie die neueste `virtio-win.iso`-Datei herunter.

    2. **Installieren Sie in Windows %%VM|vm%%:**
       - Binden Sie die `virtio-win.iso` in Ihrer %%VM|vm%% ein.
       - Führen Sie den Installer von der eingebundenen ISO aus.
       - Install both %%VirtIO|virtio%% drivers AND %%QEMU|qemu%% %%Guest Agent|guest-agent%%.
       - Starten Sie die %%VM|vm%% neu.

    3. **Konfigurieren in Unraid:**
       - Gehen Sie zu Ihren %%VM|vm%%-Einstellungen im ***VMs***-Tab.
       - Stellen Sie **Abschaltaktion** auf **Ruhezustand** ein.
       - Klicken Sie auf **Übernehmen**.
  </TabItem>

  <TabItem value="linux" label="Linux-VMs">
    1. **Installieren Sie %%QEMU|qemu%% %%Guest Agent|guest-agent%%:**

    ```bash
    # Ubuntu/Debian
    sudo apt install qemu-guest-agent

    # CentOS/RHEL/Fedora
    sudo yum install qemu-guest-agent
    # or
    sudo dnf install qemu-guest-agent
    ```

    2. **Aktivieren Sie den Dienst:**
       ```bash
       sudo systemctl enable qemu-guest-agent
       sudo systemctl start qemu-guest-agent
       ```

    3. **Konfigurieren in Unraid:**
       - Setzen Sie **Abschaltaktion** in Ihren %%VM|vm%%-Einstellungen auf **Ruhezustand**.
  </TabItem>

  <TabItem value="Appliance" label="Appliance-VMs">
    Einige %%VMs|vm%%, wie Home Assistant, erlauben die Installation zusätzlicher Software nicht. Für diese:

    - Lassen Sie **Abschaltaktion** auf **Shutdown** eingestellt.
    - Verwenden Sie längere Timeout-Werte (siehe Timeout-Empfehlungen unten).
    - Betrachten Sie die Risiken des erzwungen-Tötens dieser %%VMs|vm%% während Updates.

    :::note[Warum Appliance-VMs anders sind]

    Appliance-%%VMs|vm%% sind so konzipiert, dass sie spezifische Software ausführen und lassen oft die Installation zusätzlicher Pakete, wie %%QEMU|qemu%% %%Guest Agent|guest-agent%%, nicht zu. Das bedeutet, der Ruhezustand ist nicht verfügbar, sodass Sie sich auf die richtige Timeout-Konfiguration verlassen müssen.

    :::
  </TabItem>
</Tabs>

Zum Verifizieren, dass Ihr Ruhezustand funktioniert, starten Sie Ihre %%VM|vm%% und öffnen einige Anwendungen. Beenden Sie es dann von Unraid aus. Wenn Sie es wieder starten, sollte es mit allen Anwendungen weiterhin geöffnet sein.

:::warning[Guest Agent ist kritisch]

Without the %%QEMU|qemu%% %%Guest Agent|guest-agent%% installed, hibernation may not work properly. In that case, the %%VM|vm%% will revert to shutdown mode, consuming the full timeout period.

:::

### Timeout-Konfiguration

In diesem Abschnitt behandeln wir, wie man Timeouts für verschiedene Systeme und Prozesse konfiguriert. Diese Informationen sind wichtig, um sicherzustellen, dass Ihre %%VMs|vm%% und Docker-Container ohne Datenverlust ordnungsgemäß heruntergefahren werden.

| Einstellung                                  | Standard | Wann erhöhen                                               | Wo einstellen                                                   |
| -------------------------------------------- | -------- | ---------------------------------------------------------- | --------------------------------------------------------------- |
| %%VM\|vm%% Herunterfahren-Zeitüberschreitung | 60s      | 300s, wenn kein Ruhezustand genutzt wird und VMs abstürzen | ***Einstellungen → VM-Manager → VM-Shutdown (Erweitert)***      |
| Docker-Container-Stop-Timeout                | 10s      | 30s, wenn Container beim Stoppen abstürzen                 | ***Einstellungen → Docker (Erweitert)***                        |
| Allgemeiner Shutdown-Timeout                 | 90s      | 180s bei unsauberen Abschaltungen, 300s+ mit VMs           | ***Einstellungen → Laufwerkseinstellungen → Shutdown-Timeout*** |

:::tip[When um Timeouts zu erhöhen]

Wenn Sie unsaubere Abschaltungen oder Container haben, die beim Abschalten abstürzen, erwägen Sie, das allgemeine Abschalt-Timeout auf **180 Sekunden** (oder **300+ Sekunden**, wenn Sie mehrere %%VMs|vm%% haben) zu erhöhen. Dies gibt den Diensten mehr Zeit für ein sanftes Abschalten.
:::

### Abschaltsequenz

Beim Herunterfahren erfolgt der Prozess in folgender Reihenfolge:

1. **%%VM|vm%%-Abschaltung**: Dies umfasst drei Phasen, und jede kann bis zum VM-Timeout dauern:

   - Phase 1: Alle pausierten %%VMs|vm%% fortsetzen
   - Phase 2: %%VMs|vm%%, die für den Ruhezustand eingerichtet sind, in den Ruhezustand versetzen
   - Phase 3: Alle verbleibenden %%VMs|vm%% herunterfahren

   Alle %%VMs|vm%% in jeder Phase werden gleichzeitig verarbeitet, was bedeutet, dass die gesamte Abschaltzeit berechnet werden kann als: VM-Timeout × 3.

2. **Docker-Container stoppen**: Alle Container werden gleichzeitig gestoppt (Gesamtzeit = Docker-Timeout).

3. **Weitere Dienste:** Dies umfasst Aufgaben wie LXC-Container und von Drittanbietern angebotene Plugins, die normalerweise nur wenige Sekunden erfordern.

4. **Festplattenabschaltung**: Laufwerke müssen ausgehängt und Daten synchronisiert werden; dies dauert normalerweise 15-30 Sekunden.

:::tip[Calculate Ihr allgemeines Abschalt-Timeout]

**Formel:** Ihr allgemeines Abschalt-Timeout sollte größer sein als:

```
(VM timeout × 3) + (Docker timeout) + (Other services) + 15-30 seconds
```

**Beispiel:** Wenn wir der Formel folgen, würde es so aussehen: `(300 × 3) + 30 + 10 + 30 = 970 Sekunden (über 16 Minuten)`.

**Empfehlung:** Mindestens **180 Sekunden (3 Minuten)** als Minimum und **300+ Sekunden (5+ Minuten)**, wenn Sie mehrere %%VMs|vm%% oder komplexe Container haben.

:::

Wenn alle Ihre %%VMs|vm%% so eingestellt sind, dass sie in den Ruhezustand gehen, anstatt herunterzufahren, ist das VM-Timeout weniger kritisch, da der Ruhezustand nahezu sofort erfolgt. Sie könnten ein niedrigeres VM-Timeout verwenden (zum Beispiel 60-120 Sekunden) als Backup für irgendwelche %%VMs|vm%%, die den Ruhezustand nicht unterstützen.

### Detaillierte Konfigurationsanleitung

Dieser Abschnitt bietet ausführliche Informationen zur Konfiguration von Timeouts für verschiedene Systemkomponenten. Jede Timeout-Einstellung arbeitet zusammen, um sicherzustellen, dass Ihr Server ohne Datenverlust ordnungsgemäß heruntergefahren wird.

<Tabs>
  <TabItem value="VM-Timeouts" label="Wo zu setzen: ***Einstellungen → VM-Manager → VM-Abschaltung*** (erweiterte Ansicht aktivieren)" default>
    Wo einzustellen: ***Einstellungen → VM-Manager → VM-Herunterfahren*** (Erweiterte Ansicht aktivieren)

    **Wie es funktioniert:**

    - %%VMs|vm%% durchlaufen drei Abschaltphasen, die jeweils das vollständige VM-Timeout benötigen
    - Alle %%VMs|vm%% in jeder Phase werden gleichzeitig verarbeitet
    - Gesamt-VM-Abschaltzeit = VM-Timeout × 3

    **Häufige Probleme:**

    - **Unterbrechungen von Windows-Updates:** Updates während des Herunterfahrens können beschädigt werden, wenn das Timeout abläuft.
    - **Ungespeicherte Arbeit:** Dialogfelder, die zum Speichern von Dokumenten auffordern, können das Herunterfahren unbegrenzt aufhalten.
    - **Ruhezustandsfehler:** %%VMs|vm%% ohne %%QEMU|qemu%% %%Guest Agent|guest-agent%% werden möglicherweise beim Ruhezustand fehlschlagen und das vollständige Timeout verwenden.

    :::tip[VM-Timeout-Empfehlungen]

    - **Primäre Empfehlung:** Konfigurieren Sie %%VMs|vm%% so, dass sie in den Ruhezustand versetzt werden, anstatt herunterzufahren (erfordert %%QEMU|qemu%% %%Guest Agent|guest-agent%%).
    - **Wenn VMs während des Herunterfahrens abstürzen:** Erhöhen Sie das Timeout auf **300 Sekunden (5 Minuten)** für Windows-%%VMs|vm%%.
    - **Windows-Updates:** Stellen Sie Windows so ein, dass es Updates beim Starten anstatt beim Herunterfahren installiert.
    - **Testen Sie Ihr Setup:** Stoppen Sie manuell Ihre %%VMs|vm%%, um zu bestätigen, dass sie innerhalb der Timeout-Periode heruntergefahren oder in den Ruhezustand versetzt werden.
      :::

    :::warning[Kein sicheres Timeout ohne Ruhezustand]
    Ohne Ruhezustand und %%QEMU|qemu%% %%Guest Agent|guest-agent%% gibt es kein wirklich sicheres Timeout für Windows-%%VMs|vm%%. Dialogfelder oder laufende Update-Installationen könnten jedes Timeout unzureichend machen, was zu erzwungenen Abschaltungen und einem Risiko der Datenbeschädigung führen könnte.
    :::
  </TabItem>

  <TabItem value="Docker-Timeouts" label="Wo zu setzen: ***Einstellungen → Docker*** (erweiterte Ansicht aktivieren)">
    Container werden parallel gestoppt, sodass die Gesamtzeit dem Docker-Stop-Timeout entspricht.

    **Wie es funktioniert:**

    - Die meisten Container stoppen innerhalb von 10 Sekunden, aber einige benötigen möglicherweise mehr Zeit.
    - Komplexe Container mit großen Datenbanken oder laufenden Operationen könnten zusätzliche Zeit benötigen.
    - :::tip[Docker-Timeout-Empfehlungen]
    - Wenn der Timer abläuft, werden Container erzwungenermaßen gestoppt.

    :::tip[Docker-Timeout-Empfehlungen]

    - Die **standardmäßigen 10 Sekunden** funktionieren gut für die meisten Container.
    - **Wenn Container beim Stoppen abstürzen:** Erhöhen Sie das Timeout auf **30 Sekunden**.
    - Überwachen Sie Ihre Container während des Herunterfahrens, um festzustellen, ob jemand dabei konstant mehr Zeit benötigt.
      :::
  </TabItem>

  <TabItem value="Allgemeine Timeouts" label="Wo zu setzen: ***Einstellungen → Festplatten Einstellungen → Herunterfahr-Timeout***">
    **Überlegungen zur USV (wichtigster Faktor):**

    Ihre USV muss genügend Laufzeit bieten, um die vollständige Abschaltsequenz abzuschließen, bevor die Batterie leer ist.

    - Für **manuelle Abschaltung** können Sie längere Timeouts einstellen, da Sie kontrollieren, wann die Abschaltung startet.
    - Bei **Stromausfall-Abschaltung** ist Ihr Timeout durch die Batterielebensdauer der USV begrenzt.
    - **Testen Sie Ihre USV** durch Simulieren eines Stromausfalls, um sicherzustellen, dass Ihr Server sauber herunterfährt und noch Zeit übrig bleibt.
    - **Testen Sie Ihre USV**, indem Sie einen Stromausfall simulieren, um sicherzustellen, dass ihr Server sauber herunterfährt, mit genügend Zeit zum Ausführen.

    :::tip[Allgemeine Timeout-Empfehlungen]

    - **Wenn Sie unsaubere Abschaltungen erleben:** Erhöhen auf **180 Sekunden (3 Minuten)** für Systeme ohne %%VMs|vm%%.
    - **Für Systeme mit %%VMs|vm%%:** Verwenden Sie **300+ Sekunden (5+ Minuten)**, wenn kein Ruhezustand verwendet wird.
    - **Wenn Ruhezustand verwendet wird:** **180-300 Sekunden** sind in der Regel ausreichend.
    - Stellen Sie sicher, dass Timeouts nicht länger sind, als Ihre USV während eines Stromausfalls unterstützen kann.
      :::
  </TabItem>

  <TabItem value="Drittanbieter" label="Drittanbieter-Dienste">
    **LXC-Container:**
    Das LXC-Plugin verfügt über eine eigene Timeout-Einstellung für das Stoppen von Containern. Wie Docker-Container stoppen LXC-Container normalerweise innerhalb weniger Sekunden, aber einige benötigen möglicherweise mehr Zeit. Überprüfen Sie die LXC-Plugin-Einstellungen für das Container-Stop-Timeout und schließen Sie dieses Timeout in Ihre allgemeine Abschalt-Timeout-Berechnung ein.

    **Andere Dienste:**
    Einige Plugins oder benutzerdefinierte Dienste können ihre eigenen Abschaltverfahren haben. Beziehen Sie sich auf die Plugin-Dokumentation für spezifische Timeout-Einstellungen und integrieren Sie sie in Ihre Berechnungen.

    **Aktualisierte Formel mit Drittanbieterdiensten:**

    ```
    (VM timeout × 3) + (Docker timeout) + (LXC/other timeouts) + 15-30 seconds
    ```

    **Dynamix Stop Shell Plugin:**
    Wenn Sie häufig SSH- oder Terminal-Sitzungen verwenden, können geöffnete Sitzungen einen sauberen Abschaltungsprozess verhindern, da Unraid darauf wartet, dass sie sich schließen, bevor es fortfährt.

    Das [Dynamix Stop Shell](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository) Plugin hilft, indem es automatisch verbleibende Bash- oder SSH-Sitzungen schließt, wenn das Array gestoppt wird, und so für eine rechtzeitige Abschaltung sorgt.

    Sie können es von [Community Applications (nach "Dynamix Stop Shell" suchen)](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository) installieren.

    :::tip[Wann das Plugin zu verwenden ist]

    - Wenn Sie regelmäßig Terminalsitzungen offen haben.
    - Um zu verhindern, dass vergessene SSH-Sitzungen das Herunterfahren verzögern.
    - Für die automatisierte Bereinigung während des Herunterfahrens.
      :::

    :::vorsicht

    - Seien Sie vorsichtig, wenn Sie Skripte oder Prozesse in Terminalsitzungen laufen haben.
    - Stellen Sie sicher, dass keine kritischen Schreibvorgänge vor dem Herunterfahren in Bearbeitung sind.
    - Das Plugin wird Sitzungen gewaltsam schließen, was die Arbeit unterbrechen könnte.
      :::
  </TabItem>
</Tabs>
