---
sidebar_position: 1
sidebar_label: ZFS 存储
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# ZFS 存储

:::important[Special 谢谢]
我们要感谢Ed Rawlings ([Spaceinvader One](https://www.youtube.com/c/SpaceinvaderOne)) 的专业技术和指导，本%%ZFS|zfs%%存储文档是从他的教程和见解改编而成的。他的教程帮助了无数的Unraid用户掌握了高级存储技术。我们感谢他对 Unraid 社区的持续贡献。
:::

%%ZFS|zfs%% 为您的 Unraid 系统提供了高级数据完整性、灵活的存储配置和高性能。本指南解释了 %%ZFS|zfs%% 的核心概念，并指导您直接从 Unraid %%WebGUI|web-gui%% 管理 %%ZFS|zfs%% 存储池。无论是设置新的 %%ZFS|zfs%% 存储还是集成现有存储池，您都能找到所需的步骤和背景信息，以自信地开始。

---

## 为什么选择 ZFS？

%%ZFS|zfs%% 是一种现代文件系统和卷管理器，旨在保护您的数据、预防损坏并简化存储管理。

使用 %%ZFS|zfs%%，您可以获得：

- 自动数据完整性检查和自我修复
- 内置 %%RAID|raid%% 支持（镜像、RAIDZ）
- %%Snapshots|snapshot%% 和克隆功能，用于轻松备份和回滚
- %%ZFS|zfs%% 发送/接收，高效复制
- 实时压缩

Unraid supports %%ZFS|zfs%% for any storage pool. You can create a new %%ZFS|zfs%% pool, import one from another system, or use Unraid’s unique hybrid %%ZFS|zfs%% setup: add a %%ZFS|zfs%%-formatted disk directly to the Unraid %%array|array%% (not a pool) and combine %%ZFS|zfs%% features with Unraid’s %%parity|parity%% protection.

:::info[Example]
您可以在单个磁盘上使用 %%ZFS|zfs%% %%snapshots|snapshot%% 和复制作为备份目标，或将快速 SSD %%ZFS|zfs%% 池复制到由 Unraid %%parity|parity%% 保护的 %%ZFS|zfs%% 磁盘中的 %%array|array%%，以获得双重优势。
:::

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![](/img/zfs1.png)
</div>

:::note
混合%%ZFS|zfs%%-in-array方法对特定的备份或复制场景有帮助，但不能替代完整的%%ZFS|zfs%%池。%%ZFS|zfs%%磁盘在%%array|array%%中单独管理；您无法获得真正多磁盘%%ZFS|zfs%%池的组合性能、冗余或自愈功能。为获得完整%%ZFS|zfs%%功能，总是使用专用的%%ZFS|zfs%%池。
:::

### 池、vdevs 和冗余

一个 %%ZFS|zfs%% 池（称为 "zpool"）由一个或多个 vdev（虚拟设备）组成。每个 vdev 是具有其自身冗余级别的物理磁盘组。%%ZFS|zfs%% 在 vdev 之间写入数据，但每个 vdev 负责其故障容忍。

:::caution
冗余总是以 vdev 为单位的。如果任何 vdev 失败，整个池都会失败，即使其他 vdev 健康。谨慎规划您的 vdev！
:::

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![](/img/zfs2.png)
</div>

---

## 创建一个 ZFS 池

要使用 %%WebGUI|web-gui%% 创建 %%ZFS|zfs%% 池：

1. 停止%%array|array%%。
2. 点击**添加池**。

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![](/img/zfs3.png)
</div>

3. 为您的存储池选择一个名称（例如，`raptor`）。
4. 设置槽位数量以匹配您想要在主数据 vdev(s) 中的磁盘数量。

:::note
此初始插槽数仅适用于数据vdev。支持vdev（如日志或缓存驱动器）可以在创建池后单独添加。
:::

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![](/img/zfs4.png)
</div>

5. 将磁盘分配到池中（磁盘顺序无关紧要）。

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![](/img/zfs5.png)
</div>

6. 点击池名称（例如 `raptor`）以打开其配置屏幕。
7. 将文件系统类型设置为 `zfs` 或 `zfs-encrypted`（用于 LUKS 加密）。

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![](/img/zfs6.png)
</div>

8. 选择您的分配配置文件 - 这会决定您的池的冗余和性能。

:::tip
在最终确定之前，检查关于分配配置文件和拓扑结构的章节以做出明智的选择。
:::

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![](/img/zfs7.png)
</div>

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![](/img/zfs8.png)
</div>

9. 如果需要，可以启用压缩（推荐用于大多数工作负载）。
10. 点击**完成**，然后启动 %%array|array%%。

---

## 将 ZFS 磁盘添加到阵列（混合设置）

您可以将独立的 %%ZFS|zfs%% 磁盘添加到您的 Unraid %%array|array%%（而不是 %%ZFS|zfs%% 池）中，以结合 %%ZFS|zfs%% 功能和 Unraid 的 %%parity|parity%% 保护。

:::info[What 这使得]

- **%%Parity Protection%%:** ZFS 磁盘由 Unraid 的 %%array|array%% %%parity|parity%% 保护，确保您的数据免受单个（或多个，取决于您的 %%parity drives|parity-drives%%）磁盘故障的影响。

- **数据完整性：**%%ZFS|zfs%%提供块级别的完整性检查（校验和）。虽然单个磁盘不能自行修复位腐败，但%%ZFS|zfs%%将检测腐败并提醒你，使你能够在静默数据丢失之前从备份中恢复。

- **%%ZFS|zfs%% features:** You can utilize %%ZFS|zfs%% %%snapshots|snapshot%% and replication on this disk, making it ideal for backup targets, specific datasets, or scenarios where you want %%ZFS|zfs%% features alongside traditional Unraid storage.
  :::

将 %%ZFS|zfs%% 磁盘添加到 %%array|array%%:

1. 在 %%WebGUI|web-gui%% 中转到 **Main** 标签。
2. 停止%%array|array%%。
3. 点击**阵列设备**下的空槽。
4. 选择您要添加的磁盘。

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![](/img/zfs9.png)
</div>

5. 在 **文件系统** 下，选择 `zfs` 或 `zfs-encrypted`。

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![](/img/zfs9.png)
</div>

6. 点击 **应用**。
7. 启动 %%array|array%%，并在需要时让磁盘格式化。

---

## 选择分配配置文件

当你设置一个%%ZFS|zfs%%池时，你的分配配置文件决定了数据的保护方式、池的性能以及扩展方式。以下是一个简单的对比来帮助你选择适合你需要的配置文件：

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![](/img/zfs11.png)
</div>

| 配置     | 冗余                        | 性能                     | 扩展        | 空间效率 | 典型用例        |
| ------ | ------------------------- | ---------------------- | --------- | ---- | ----------- |
| 条带     | 无                         | 快，但风险大                 | 增加更多磁盘    | 100% | 临时/临时存储     |
| 镜像     | 1:1（%%RAID 1\|raid1%% 样式） | 对于随机 I/O 表现出色          | 增加更多镜像    | 50%  | 高性能，易于扩展    |
| RAIDZ1 | 每个 vdev 1 个盘              | 对大文件快速。对于小的或随机写入不理想。   | 增加新的 vdev | 高    | 通用用途，1 盘容错  |
| RAIDZ2 | 每个 vdev 2 个盘              | 与 Z1 类似，但写入略慢（额外的奇偶校验） | 增加新的 vdev | 中等   | 重要数据，2 盘容错  |
| RAIDZ3 | 每个 vdev 3 个盘              | 与 Z2 类似，写入更多负担（最大安全性）  | 增加新的 vdev | 低    | 任务关键型，3 盘容错 |

:::important[How 选择]

- 选择 **镜像** 如果您想要最佳性能和易于、灵活的扩展，并且愿意使用更多磁盘空间来确保冗余。
- 选择 **RAIDZ1/2/3** 如果您想最大化可用空间并存储大文件，但要记住扩展的灵活性较低，随机写性能较差。
- **条纹** 仅适用于非关键的临时数据 - 如果有任意磁盘出现故障，您将失去所有数据。
  :::

---

## 拓扑和扩展

您如何将磁盘分组到 vdevs 中会影响数据安全性和速度。

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![](/img/zfs12.png)
</div>

- 如果将所有硬盘放入大型的 RAIDZ2 vdev 中，您可以在不丢失数据的情况下失去两个硬盘。然而，扩展意味着添加另一个完整的 vdev。
- 如果将磁盘分成多个较小的 RAIDZ1 vdev，您将获得更好的并行性能。请谨慎；如果同一个 vdev 中的两个磁盘失败，您将失去整个池。
- %%ZFS|zfs%% 将数据跨 vdev 条带化，而不是单个磁盘，因此更多的 vdev 能够提升处理很多小文件或随机 I/O 的工作负载性能。
- 扩展一个 %%ZFS|zfs%% 容量池通常意味着添加一个新的相同布局的 vdev，而不仅仅是单个磁盘。

:::tip
规划您的池布局以适应您的需求和未来增长。与 Unraid %%array|array%% 不同，您无法通过 %%WebGUI|web-gui%% 将单个磁盘添加到现有的 vdev。
:::

---

## 压缩和 RAM

%%ZFS|zfs%%提供的高级特性可以显著提高 Unraid 的存储效率和性能。两个常见的关注点是压缩和内存需求。

%%ZFS|zfs%% 压缩是透明的 - 它在后台运行，在数据到达磁盘之前缩小数据。

这提供了两个主要优点：

- **减少磁盘使用量:** 所需存储空间更少。
- **提高性能:** 写入和读取较少数据可以导致更快的操作，特别是在现代 CPU 上。

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![](/img/zfs13.png)
</div>

:::tip
为大多数 Unraid %%ZFS|zfs%% 池启用 %%ZFS|zfs%% 压缩。它安全、高效，几乎不影响兼容性或稳定性。
:::

<details>
  <summary><strong>ZFS RAM 神话</strong> - 点击展开/折叠</summary>

  您可能听说过过时的建议："ZFS 需要每 TB 存储 1 GB 的 RAM。" 这对于大多数用户来说已不再适用。ZFS 利用 RAM 作为自适应替换缓存 (ARC) 以加速频繁访问的读取。

  Unraid 自动限制 ZFS 使用系统 RAM 的合理部分（通常为总 RAM 的 1/8）。这使 ZFS 能够在不影响 Docker 容器、VM 或 Unraid OS 的情况下良好运行。

  <div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
    ![](/img/zfs14.png)
  </div>
</details>

:::info
%%ZFS|zfs%% 随着可用内存的增加而具有良好的扩展性。更多的 RAM 可以提高缓存性能，但 %%ZFS|zfs%% 在适度硬件条件下也能可靠地运行。不要让旧有的建议阻止你在 Unraid 上使用 %%ZFS|zfs%%。
:::

---

## 导入其他系统创建的 ZFS 池

Unraid 可以轻松导入其他平台上创建的 %%ZFS|zfs%% 池。

<details>
  <summary><strong>如何导入 ZFS 池</strong> - 点击展开/折叠</summary>

  1. **停止阵列:** 确保您的 Unraid %%array|array%% 已停止。
  2. **添加新池:** 点击 **添加池**。
  3. **分配所有驱动器:**
     - 将 **数据槽位数量** 设置为您的 %%ZFS|zfs%% 池中磁盘（包括数据 vdevs 和支持 vdevs）总数。
     - 将每个驱动器分配到正确的插槽。
     - *示例：* 对于具有 4 个驱动器镜像 vdev 和 2 个驱动器 L2ARC vdev 的池，设置 6 个插槽并分配所有六个驱动器。
  4. **设置文件系统为 "Auto"：** 点击池名称（例如，`raptor`）并将 **文件系统** 设置为 **Auto**。
  5. **完成并启动阵列:** 点击 **完成**，然后启动 %%array|array%%。

  :::info[Automatic detection]
  Unraid will automatically detect and import the %%ZFS|zfs%% pool. Support vdevs (like log, cache/L2ARC, special/dedup) are listed under **Subpools** in the %%WebGUI|web-gui%%. There is no need to add subpools separately after initiating the import. Unraid will automatically import them alongside the main data disks when all required drives are assigned.
  :::

  导入后，强烈建议运行 %%scrub|scrub%% 以验证数据完整性。

  - 点击池名（例如 `raptor`）以打开其配置。
  - 在 **池状态** 下，检查状态并点击 **Scrub**。

  <div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
    ![](/img/zfs15.png)
  </div>
</details>

---

## 支持 vdev（子池）

Unraid 将 %%ZFS|zfs%% 支持vdevs称为子池。大多数用户**不**需要这些，但高级用户可能会遇到它们：

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![](/img/zfs16.png)
</div>

| 支持的 vdev（子池）   | 用途                    | 风险/注意事项                             |
| -------------- | --------------------- | ----------------------------------- |
| 特殊 vdev        | 存储元数据和小文件             | 如果丢失，池将无法读取。                        |
| 去重 vdev        | 启用去重功能                | 需要大量RAM；大多数用户来说风险大。除非有专门需要，否则请避免使用。 |
| 日志 vdev（SLOG）  | 提高同步写入性能              | 可选。仅对某些负载有益。                        |
| 缓存 vdev（L2ARC） | 提供基于 SSD 的读取缓存        | 可选。可提高大型工作集的读取速度。                   |
| 备用 vdev        | Unraid（截至 7.1.2 版）不支持 |                                     |

:::caution
除非有明确理解的需要，大多数 Unraid 用户应避免使用支持 vdevs/子池。它们是为专用工作负载设计的，如果使用不当可能会增加复杂性或风险。
:::

---

## 导入时未分配重要的支持 vdev 驱动器

当你将一个 %%ZFS|zfs%% 池导入 Unraid 时，你需要将原始池中的每个驱动器，包括用于支持 vdev 的驱动器，分配到池槽中。一旦%%array|array%% 启动，Unraid 会自动识别每个驱动器的角色（数据、日志、缓存、特殊或去重）。你不需要手动指定每个驱动器的作用。

如果在导入期间忘记包含一个支持 vdev 的驱动器，结果将取决于 vdev 的功能：

| Vdev 类型          | 导入时驱动器缺失情况     | 结果                                             |
| ---------------- | -------------- | ---------------------------------------------- |
| 特殊 vdev 或去重 vdev | 池将无法导入或无法使用    | 这些 vdev 存储关键元数据或去重表。没有它们，%%ZFS\|zfs%% 无法安全挂载池。 |
| 日志（SLOG）vdev     | 池导入，但同步写入性能下降。 | 池仍然可访问，但你可能会注意到依赖同步写入的工作负载的性能变慢。               |
| 缓存（L2ARC）vdev    | 池导入，但读取缓存丢失    | 池正常工作，但您会失去来自 L2ARC 缓存的性能提升。没有数据丢失。            |

:::tip
导入到 Unraid 时，始终分配原始 %%ZFS|zfs%% 池的每个物理驱动器，包括所有支持 vdev。这保证了顺畅的检测和集成。对于在 Unraid 中创建的新池，支持 vdevs 是可选的且通常对于大多数用户不需要。
:::

---

## 扩展存储

%%ZFS|zfs%% 功能强大，但重要的是要了解其存储扩展是如何工作的—尤其是在规划未来增长时。

从历史上看，%%ZFS|zfs%% vdevs 有固定的宽度。你不能向现有的 RAIDZ vdev 添加磁盘来扩大它。

扩展池的方法包括：

- \*\*添加新 vdev：\*\*通过添加另一个 vdev（如新镜像或 RAIDZ 组）来扩展你的池。这增加了容量，但你必须以与 vdev 配置相匹配的集合添加磁盘。
- **用更大的硬盘替换驱动器：** 在 vdev 中一次交换一个驱动器，以换取更大的磁盘。详细步骤请参见[驱动器更换](../../using-unraid-to/manage-storage/array-configuration.mdx#replacing-faileddisabled-disks)。在所有驱动器被替换且池解析之后，vdev 的容量将增加。
- **创建新池：** 启动一个新的 %%ZFS|zfs%% 池可将不同的数据类型或工作负载组织并独立管理。

:::tip[Planning 前进]
在构建你的池之前，考虑你需要的存储量 - 不仅是今天，而且是将来。%%ZFS|zfs%% 奖励良好的规划，特别是当你想避免将来的重大升级时。
:::

---

## 在现有 Unraid 服务器上使用 ZFS 池

如果你运行传统 Unraid %%array|array%% 并希望添加 %%ZFS|zfs%% 池，以下是一些有效的集成方法：

| 使用场景                                       | 描述                                                                                                                                                                          | 详细信息/示例                                                |
| ------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------ |
| 用于 appdata 和 Docker 的快速 SSD/NVMe 池         | Store the appdata share for fast, responsive containers and databases. This supports %%snapshot\|snapshot%%s for easy rollbacks and can also host %%VM\|vm%%s for high I/O. | 许多用户为此选择 2 驱动器 %%ZFS\|zfs%% 镜像。它易于扩展并提供强大的性能。          |
| 用于重要数据的%%ZFS\|zfs%%池                       | 为不可替代的文件（如照片、税务记录和 %%user share\|user-share%% 数据）使用 %%ZFS\|zfs%% 镜像或 RAIDZ2 池。%%ZFS\|zfs%% 检查腐败并通过冗余自我修复。                                                                   | 这种设置通过自动的完整性检查和自我修复功能保护关键数据。                           |
| 每日备份或复制目标                                  | Use a %%ZFS\|zfs%% disk (even within the Unraid %%array\|array%%) as a replication target. You can replicate other pools locally or from another Unraid server.             | 利用 `zfs send/receive` 或诸如 Syncoid 之类的工具，以实现快速可靠的备份和还原。 |
| %%Snapshot\|snapshot%%-based recovery pool | Keep point-in-time %%snapshot\|snapshot%%s of critical data or containers. %%snapshot\|snapshot%%s can be auto-scheduled and are space-efficient.                           | 此功能可以从意外删除或配置错误中快速恢复。                                  |

## 避免常见的 ZFS 错误

%%ZFS|zfs%% 是一个强大的文件系统，但有几个常见的陷阱可能会阻碍其带来的好处。在配置池之前，务必记住下面几点，以便获得更顺畅的体验：

- **RAIDZ 中的驱动器尺寸不匹配：** %%ZFS|zfs%% 将 RAIDZ vdev 中的所有磁盘视为最小的一个的尺寸。为了确保最佳效率，请始终在每个 vdev 中使用尺寸相同的驱动器。

- \*\*通过 %%WebGUI|web-gui%% 扩展 RAIDZ vdevs：\*\*尽管 Unraid 7.1.x 及更高版本支持通过命令行扩展 RAIDZ， 但这一功能在 %%WebGUI|web-gui%% 中尚未可用。目前，请通过 CLI 扩展或通过 GUI 添加新的 vdevs。

- **%%ZFS|zfs%% disk vs. full zpool:** A single %%ZFS|zfs%%-formatted disk in the Unraid %%array|array%% does not offer the redundancy or features of a dedicated %%ZFS|zfs%% pool. To leverage advanced functionality, use standalone pools.

- \*\*内存不足的去重：\*\*去重需要大量内存，在没有足够内存的情况下启用去重会严重影响性能。仅在完全了解要求的情况下启用去重。

- **vdev 冗余是局部的：**%%ZFS|zfs%% 中的冗余是局部适用于每个 vdev，并且不会在池之间共享。务必规划你的 vdev 布局，以达到所需的弹性水平。
