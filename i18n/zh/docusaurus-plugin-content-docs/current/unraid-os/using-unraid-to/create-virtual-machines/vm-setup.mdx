---
sidebar_position: 2
sidebar_label: VM 设置
---

# VM 设置

Setting up a virtual machine (VM) on Unraid is a flexible way to run full operating systems - such as Windows, Linux, or other platforms - alongside your containers and native apps. Whether you want to test new software, run legacy applications, host a desktop environment, or utilize hardware passthrough for gaming or creative work, Unraid’s **VM Manager** makes the process approachable for all skill levels.

:::tip[New 在 Unraid 7.0 中]

- %%VM|虚拟机%% 克隆和快照
- 用户创建的 %%VM|虚拟机%% 模板
- 内联 XML 编辑/查看
- 高级 GPU 共享和直通功能

查看 [%%VM|vm%% 管理器功能](#new-in-unraid-7x-vm-manager) 部分以获得更多详细信息。
:::

如果您还没有，请查看 [概述和系统准备](./overview-and-system-prep.mdx) 指南，以确保您的硬件和共享已准备好虚拟化。

## 创建您自己的虚拟机

在准备好系统和设置好偏好后，您可以使用 %%WebGUI|web-gui%% 创建新的 %%虚拟机 (VM)|虚拟机%%。

:::note[Before 开始]

- 确认您的`isos`和`domains`共享已配置并可访问。了解更多关于[共享管理](../manage-storage/shares.mdx)的信息。
- 上传您的操作系统安装 ISO，以及适用于 Windows %%VM|虚拟机%% 的最新 %%VirtIO|virtio%% 驱动程序 ISO 到 `isos` 共享。
- 决定您将使用 %%GPU passthrough|gpu-passthrough%% 还是 %%VNC|vnc-session%% 做图形处理。
  :::

要创建一个基本的 %%VM|虚拟机%%：

1. 从 **虚拟机** 页面中点击 **添加 VM**。
2. 将 **模板** 设置为 **自定义**，或者为常见发行版选择预定义的操作系统模板。
3. 输入 %%VM|虚拟机%% 的 **名称**，并可选提供描述。
4. 如果希望 %%VM|虚拟机%% 随 %%array|array%% 自动启动，请切换 **自动启动**。
5. 选择**操作系统**类型。这也会调整%%VM|vm%%图标。
6. 分配给%%VM|vm%%的**CPU核心**。您可以分配最多与主机上的物理核心数相等的数量。
7. 指定%%VM|vm%%的**初始内存**(RAM)。请参阅您的来宾操作系统文档以获得建议值。
8. 从 **isos** 共享中选择 **OS 安装 ISO**。
9. 配置 **主 vDisk**（位置、大小和类型）。
   - 主 %%vDisk|vdisk%% 存储 VM 的操作系统。
   - 使用加号按需添加附加的 %%vDisk|vdisk%%。
10. 选择 **显卡**：
    - 选择 %%VNC|vnc-session%% 以进行远程访问或选择物理 GPU 进行直通。
    - 如果使用物理GPU，请分配USB键盘/鼠标。
    - 如果需要，请设置 %%VNC|vnc-session%% 密码。
11. 分配 **声卡**（可选，但对于通过GPU实现HDMI音频是必须的）。
12. 按需分配 **USB 设备**。
    - 设备必须在启动 %%VM|虚拟机%% 之前连接（不支持 USB 热插拔）。
    - Unraid USB 闪存设备无法进行分配。
13. 点击**创建VM**。除非您取消勾选**创建后启动VM**，否则%%VM|vm%%将自动启动。

---

## 用户 VM 模板

Unraid 7.1+引入了用户%%VM|vm%%模板，使得保存和重用您自定义的%%VM|vm%%配置变得容易。用户模板简化了%%VM|vm%%的部署，并确保设置的一致性。

创建用户模板：

1. 编辑您想要模板化的 %%VM|虚拟机%%。
2. 选择 **创建/修改模版** 并输入名称。
3. 您的模板现在将可在 **添加 VM** 屏幕上的用户模板区域中使用。

使用用户模板：

- 在 **VMs** 页面上，点击 **添加 VM** 并从 **用户模板** 部分选择您的模板。

导入/导出：

- 将鼠标悬停在用户模板上，然后单击箭头将其导出到服务器或下载它。
- 在另一台 Unraid 系统上，使用 **从文件导入** 或 **上传** 来添加模板。

---

## Unraid 7.x 新增功能：VM 管理器

Unraid 7.x为\*\*%%VM|vm%%管理器\*\*引入了许多强大的增强功能，简化了运行和管理%%虚拟机|vm%%的过程。这些功能满足了初学者和高级用户的需求，使得部署、定制和优化您的%%VM|vm%%更加简单。

:::tip\[Highlights]

- 通过 %%VM|虚拟机%% 克隆、快照和可重用模板节省时间
- 通过高级直通和存储选项优化性能和兼容性
- 通过使用情况统计和内联 `XML` 编辑享受更好的可见性和控制:::

<details>
  <summary><strong>工作流增强</strong></summary>

  - **VM 克隆与快照：** 复制 %%虚拟机%% 或快速保存/恢复其状态以进行测试或备份。
  - **用户 VM 模板：** 保存您自定义的 %%虚拟机%% 配置，并只需几次点击即可部署新 %%虚拟机%%。
  - **内联 XML 查看/编辑：** 立即查看或复制 %%WebGUI|web-gui%% 生成的 `XML`；切换到 `XML` 模式以进行高级编辑。
  - **自动启动禁用：** 选择哪些 %%VM|虚拟机%% 随您的 %%array|array%% 自动启动。
  - **VM 使用统计：** 直接从仪表板跟踪每个 %%VM|虚拟机%% 的资源使用情况。
</details>

<details>
  <summary><strong>高级硬件与存储选项</strong></summary>

  - **PCI 多功能/其他：** 为高级直通场景分配复杂的 PCI 设备或组。
  - **%%QEMU|qemu%% 命令行直通：** 添加自定义 %%QEMU|qemu%% 参数以进行专家级别的 %%VM|虚拟机%% 调优。
  - **存储覆盖：** 指定每个 VM 的 %%虚拟磁盘|vdisk%% 的存储位置。
  - **SSD 标志与 unmap:** 优化 %%vDisk|vdisk%% 性能使其适用于 SSD，并启用 discard/unmap 支持。
  - **`SR-IOV` 用于 Intel iGPU：** 在多个 %%VM|虚拟机%% 之间共享集成 Intel 图形。
  - **ZFS 的 VM 名称验证：** 防止在 [%%ZFS|zfs%% 存储池](../../advanced-configurations/optimize-storage/zfs-storage.mdx) 使用不受支持的字符。
</details>

<details>
  <summary><strong>增强的图形和 GPU 共享</strong></summary>

  - **`VirGL` 与 `QXL` 虚拟 GPU：** 在多个 Linux %%VM|虚拟机%% 间共享 Intel/AMD GPU，或利用 `QXL` 进行多屏幕/内存选项。
  - **%%CPU 绑定|cpu-pinning%% 可选：** 允许 Unraid 自动管理 CPU 分配，或根据需要手动设置核心。
</details>

<details>
  <summary><strong>更多高级功能</strong></summary>

  - View all graphics cards and %%VM|vm%%-assigned IP addresses in the %%VM|vm%% tab
  - 支持 %%QEMU|qemu%% ppc64 target 和 `qemu:override`
  - Windows %%虚拟机%% 的 hypervclock 支持
  - 仿真 CPU 的“可迁移”开/关
  - 计时器/偏移配置选项
  - 不支持的特定用例的 no keymap/nogpu 选项
  - 改进的 %%VM|虚拟机%% 图标选择与编辑
  - 当设置主 GPU 作为直通时的警告（可能需要`vBIOS`）
  - 通过 `QXL` 视频驱动程序，将 Unraid %%VM|虚拟机%% 启动到 GUI 模式
  - 在 `XML` 视图中修复路径和图标问题
</details>

---

## 使用虚拟 GPU 和 GPU 共享

Unraid 现在支持通过 `VirGL` 和 `QXL` 的高级 GPU 共享适用于 Linux %%VM|虚拟机%%（及支持 `Nouveau` 驱动的某些 Nvidia GPU）。

- 使用 `VirGL`：将 **显卡** 设置为 **虚拟**，并将 **VM 控制台视频驱动** 设置为 **VirtIO(3D)**。
- 使用 `QXL`：将 **显卡** 设置为 **虚拟**，并将 **VM 控制台视频驱动** 设置为 **`QXL` (最好)**。
- `VirGL` 不输出到物理显示器，并且不兼容 Windows %%VM|虚拟机%% 或标准 Nvidia 插件。
- `QXL` 支持多屏幕和可配置的视频内存。

---

## 高级选项

<details>
  <summary>展开此部分查看有关更多高级选项的指南</summary>

  在 **添加 VM** 页面上切换到 **高级视图** 以访问其他设置。

  以下是最重要的高级选项，分为集中部分：

  **CPU 模式：**

  - **主机直通**：向 %%虚拟机%% 暴露所有主机 CPU 功能以获得最佳性能。
  - **仿真**：使用通用 CPU 模型，减少兼容性问题，但性能有限。

  **内存气球：**

  - 设置 **最大内存** 值以启用动态内存分配（%%内存气球|memory-ballooning%%）。
  - 具有 PCI 设备分配（例如 %%GPU 直通|gpu-passthrough%%）的 %%虚拟机%% 不可用。

  **机器类型：**

  - **`i440fx`**：Windows %%VMs|vm%%的默认值。只有在%%GPU直通|gpu-passthrough%%问题时更改。
  - **`Q35`**：Linux %%虚拟机%% 的默认值，建议大多数现代操作系统使用，尤其是在有 %%GPU 直通|gpu-passthrough%% 场景下。

  **BIOS 类型：**

  - **SeaBIOS**：传统 BIOS，适用于旧版操作系统。
  - **OVMF**：%%UEFI|uefi%% BIOS，适用于 Windows 8+、大多数现代 Linux 发行版，以及 %%GPU 直通|gpu-passthrough%%。

  :::note
  仅在创建新的%%VM|vm%%时才可以设置BIOS类型。
  :::

  **Hyper-V 扩展：**

  - 对于 Windows %%虚拟机%%，启用 Hyper-V 扩展以提高兼容性和性能。

  **VirtIO 驱动 ISO：**

  - 如有需要，尤其是在测试或使用更新驱动时，覆盖默认的 %%VirtIO|virtio%% ISO。

  **vDisk 类型：**

  - **`RAW`**：最佳性能，快照功能较差。
  - **`QCOW2`**：支持快照但性能稍差。

  **VirtFS 映射（Linux %%虚拟机%%）：**

  - 添加多个 %%VirtFS|virtfs%% (`9p`) 共享以实现主机和来宾之间的文件系统集成。
  - 参阅 [%%QEMU|qemu%% 9p 文档](http://wiki.qemu.org/Documentation/9psetup)。

  **网络设置：**

  - 修改 **网络 MAC 地址** 或选择备用 **网络桥**。
  - 单击刷新符号以自动生成新 MAC 地址。
  - 根据需要添加额外的虚拟网络接口。
</details>

:::info[Troubleshooting 提示]

- 如果您的 %%VM|虚拟机%% 启动失败，请仔细检查您的 ISO 和 %%vDisk|vdisk%% 路径。
- 对于 %%GPU 直通|gpu-passthrough%%，确保您的硬件和 BIOS 设置支持 %%IOMMU|iommu%%/VT-d/AMD-Vi。
- 某些 USB 设备可能在透传时无法可靠工作 - 请测试并咨询 [Unraid 论坛](https://forums.unraid.net/) 获取特定设备的建议。
  :::

---

## 绑定 PCI 设备以进行直通

Before you can assign a GPU or any PCI device to a %%virtual machine|vm%%, it's important to “bind” the device to the **vfio-pci** driver. This process hides the device from Unraid and dedicates it solely to your %%VM|vm%%.

要绑定PCI设备（GPU、USB控制器、NVMe等）以进行直通：

1. 定位到 %%WebGUI|web-gui%% 中的 ***工具→系统设备***。
2. 查看所有检测到的 PCI 设备及其 %%IOMMU|iommu%% 组的列表。
3. 选中您希望绑定到 **vfio-pci** 的每个设备的复选框（以将其从 Unraid 隐藏）。
   - 注意，Unraid 已使用的设备（例如磁盘控制器和网卡）无法选择。
   - 如果选择了 GPU，请选择相关的声音设备。
4. 单击 **绑定选择到 VFIO 开机时** 以保存更改。
5. 重新启动服务器以使绑定生效。

:::caution
如果您进行了硬件更改（如添加或删除PCI设备），请返回到**系统设备**以确保正确的设备仍然绑定。如果设备未绑定或错误绑定，它们可能不会出现用于直通。
:::

绑定后，绑定设备将在编辑或创建 %%虚拟机|虚拟机%% 时出现在 **其他 PCI 设备** 下拉菜单中。

<details>
  <summary>故障排除</summary>

  - 如果您之前使用过 `VFIO-PCI` 配置插件，请卸载它 - 这项功能已经集成。
  - 要重置所有绑定，删除 `/boot/config/vfio-pci.cfg` 并重新启动系统。
  - 重启后，在**系统设备**页面上使用**查看`VFIO-PCI`日志**按钮进行高级故障排除。
  - Remember that if you bind your only GPU, Unraid may not boot to the GUI. Make sure you plan for this.
  - 有关更多信息，请查看[Unraid论坛官方指南](https://forums.unraid.net/topic/93781-guide-bind-devices-to-vfio-pci-for-easy-passthrough-to-vms/)。
</details>

---

## GPU透传用于虚拟机

%%GPU透传|gpu-passthrough%%允许您将物理显卡直接分配给%%虚拟机 (VM)|vm%%，为游戏、创作工作或机器学习提供近乎原生的性能。

:::info[Why 使用 GPU 直通功能？]

- \*\*性能：\*\*为高需求应用提供直接硬件访问。
- \*\*兼容性：\*\*运行需要专用GPU的图形密集型工作负载。
- \*\*灵活性：\*\*将您的 Unraid 服务器转变为多功能工作站。
  :::

<h4>先决条件</h4>

**硬件：**

- 支持Intel VT-d或AMD-Vi的处理器（在BIOS中启用%%IOMMU|iommu%%）。
- 与透传兼容的GPU（参见[社区测试硬件](https://docs.google.com/spreadsheets/d/1LnGpTrXalwGVNy0PWJDURhyxa3sgqkGXmvNCIvIMenk/edit#ggid=0)）。
- 主板支持正确隔离PCIe设备。

**软件：**

- Unraid 6.9以上版本，启用了虚拟化。
- %%OVMF|ovmf%%（%%UEFI|uefi%%） BIOS用于%%VM|vm%%（推荐使用%%OVMF|ovmf%%而不是%%SeaBIOS|seabios%%）。

设置GPU透传：

1. 确保您的硬件支持%%IOMMU|iommu%%并在您的BIOS中启用。
2. 在BIOS中启用虚拟化特性（Intel VT-x/VT-d或AMD-v/AMD-vi）。
3. 将 Unraid 更新到最新稳定版本。
4. 在图形卡部分中，将GPU分配给%%VM|vm%%的%%VM|vm%%创建或编辑屏幕。
5. 如果使用%%GPU透传|gpu-passthrough%%，请为%%VM|vm%%分配USB键盘和鼠标。
6. 为%%VM|vm%%使用%%OVMF|ovmf%% BIOS，以便更好地兼容%%GPU透传|gpu-passthrough%%。
7. 启动%%VM|vm%%并确认GPU正确透传。

:::note
某些GPU可能需要额外配置或ROM注入才能正常透传。
:::

### 手动ROM注入

某些GPU，特别是特定的NVIDIA型号，需要手动为VM提供ROM文件才能正确初始化。这通常在GPU的板载固件未默认正确传递时是必要的，导致诸如黑屏或无法启动等问题。在尝试BIOS和VM配置调整后，手动ROM注入是最后的手段。

注入ROM：

1. **下载GPU ROM：**
   - 访问[TechPowerUp VGA BIOS数据库](https://www.techpowerup.com/vgabios/)。
   - 搜索您的GPU型号并下载正确的ROM文件。
   - Store the rom in your unraid `isos` or `domains` share.

2. **编辑%%VM|vm%% XML：**
   - 停止%%VM|vm%%并打开其XML配置（在%%VM|vm%%上下文菜单中选择**编辑XML**）。
   - 定位GPU的`<hostdev>`块并添加`<rom>`标签：

     ```xml

     <hostdev mode='subsystem' type='pci' managed='yes'>
       <driver name='vfio'/>
       <source>
         <address domain='0x0000' bus='0x02' slot='0x00' function='0x0'/>
       </source>
       <rom file='/mnt/user/isos/gpu_roms/your_gpu.rom'/> <!-- Update path -->
       <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>
     </hostdev>
     ```

3. **保存并测试：**点击**更新**并启动%%VM|vm%%。

---

## 常见问题

This section covers advanced topics and solutions for common issues when managing %%virtual machines (VMs)|vm%% on Unraid. Expand the sections below for step-by-step instructions and troubleshooting tips.

### 扩展vDisk

<details>
  <summary><strong>Click to expand/collapse</strong></summary>

  如果您的 %%VM|vm%% 磁盘空间不足，可以直接通过%%WebGUI|web-gui%%增加其%%virtual disk (**vDisk**)|vdisk%%的大小。

  要扩展%%vDisk|vdisk%%：

  1. 进入 %%WebGUI|web-gui%% 中的 **VMs** 标签。
  2. 确保%%VM|vm%%已停止。
  3. 点击VM的名称以展开其详细信息。
  4. 找到您要扩展的%%vDisk|vdisk%%。点击**容量**字段中的值以使其可编辑。
  5. 输入新的所需大小（例如， `100G`表示100GB）并按**Enter**。
  6. 新的容量现已设置。

  :::note
  You cannot shrink a %%vDisk|vdisk%% from the Unraid GUI; only expansion is supported.
  :::

  <h4>在您的客户操作系统中扩展分区</h4>

  调整%%vDisk|vdisk%%大小后，启动您的%%VM|vm%%。您必须在客户操作系统中扩展分区以使用新空间：

  - \*\*Windows：\*\*使用内置磁盘管理工具扩展分区。

  - \*\*Linux (LVM)：\*\*使用`fdisk`、`pvresize`、`lvextend`和`resize2fs`等工具扩展分区和逻辑卷。

    **示例：**

    ```bash
    sudo fdisk /dev/vda
    sudo pvresize /dev/vda3
    sudo lvextend -l +100%FREE /dev/mapper/ubuntu--vg-ubuntu--lv
    sudo resize2fs /dev/mapper/ubuntu--vg-ubuntu--lv
    ```

    根据您的设置调整设备名称。

  :::tip
  在进行磁盘更改之前，请始终备份您的%%VM|vm%%。
  :::
</details>

### 停留在UEFI shell

<details>
  <summary><strong>Click to expand/collapse</strong></summary>

  如果您的%%VM|vm%%启动到%%UEFI|uefi%% shell而非您的操作系统，您可以手动启动引导过程：

  在%%UEFI|uefi%% shell提示符下输入：

  ```bash
  fs0:
  cd efi/boot
  bootx64.efi
  ```

  %%VM|vm%%现在应该继续引导您的操作系统。

  :::tip
  如果此情况频繁发生，请检查您的VM启动顺序并确保在VM设置中正确设定了主启动设备为%%vDisk|vdisk%%或ISO。
  :::
</details>

### 启动后黑屏

<details>
  <summary><strong>Click to expand/collapse</strong></summary>

  如果您的%%VM|vm%%启动但显示器保持空白：

  1. **检查BIOS设置：**
     - 将主图形设置为集成GPU（iGPU），而不是透传GPU。
     - 将主板和GPU BIOS更新至最新版本。

  2. **调整%%VM|vm%%设置：**
     - 将%%SeaBIOS|seabios%%换为%%OVMF|ovmf%%（%%UEFI|uefi%%）在%%VM|vm%%设置中。
     - 将**机器类型** 从i440fx更改为Q35。

  3. **手动ROM注入（最后一招）：**[手动注入GPU ROM](#manual-rom-injection)。
</details>

### 错误：“设置容器的IOMMU失败：操作不允许”

<details>
  <summary><strong>Click to expand/collapse</strong></summary>

  此错误通常指示%%IOMMU|iommu%%组冲突或缺少中断重映射：

  1. **启用PCIe ACS重置：**
     - 进入 ***设置 → 虚拟机管理器***。
     - 将**PCIe ACS重置**设置为*下游*或*均*。
     - 重启 Unraid。

  2. **允许不安全的中断（高级）：**
     - 在您的 Unraid 闪存驱动器上编辑 `syslinux.cfg`：

       ```bash
       append vfio_iommu_type1.allow_unsafe_interrupts=1 initrd=/bzroot
       ```

     - 仅在您完全信任您的%%VM|vm%%客户时使用此功能。

  :::note
  对于详细的%%IOMMU|iommu%%组解释，建议查看[Alex Williamson的博客](http://vfio.blogspot.com/2014/08/iommu-groups-inside-and-out.html)。
  :::
</details>
