---
sidebar_position: 3
sidebar_label: Windows on a VM
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import WindowsVirtioAutomatic from './partials/windows-virtio-automatic.mdx';
import WindowsVirtioManual from './partials/windows-virtio-manual.mdx';
import WindowsUpgradeInPlace from './partials/windows-upgrade-in-place.mdx';
import WindowsUpgradeCleanInstall from './partials/windows-upgrade-clean-install.mdx';

# Windows on a VM

Windows is one of the most popular guest operating systems for Unraid users, especially for gaming, productivity, and support for legacy applications. Here are essential considerations for running Windows %%VM|vm%%.

:::caution[Before you begin]

- Microsoft ended support for Windows 7 in Jan. 2020, Windows 8.1 in January 2023, and Windows 10 in October 2025. Use Windows 11 (or later) or Server 2022 (or later) for ongoing security updates.
- Always test %%VM|vm%% stability before activating your Windows license.
- 对于%%GPU直通|gpu-passthrough%%，使用%%OVMF|ovmf%%（%%UEFI|uefi%%）BIOS与Windows 11或更新版本。
  :::

### Supported configurations

| Windows 版本          | 推荐的 BIOS           | 机器类型                            | Notes                          |
| ------------------- | ------------------ | ------------------------------- | ------------------------------ |
| Windows 11          | %%OVMF\|ovmf%% TPM | %%Q35\|q35%%                    | 需要 TPM 2.0 模拟                  |
| Windows Server 2022 | %%OVMF\|ovmf%%     | %%Q35\|q35%%                    | Ideal for enterprise workloads |
| Windows 10          | %%OVMF\|ovmf%%     | %%Q35\|q35%%                    | 已停用（生命周期结束于 2025 年 10 月）       |
| Windows Server 2019 | %%OVMF\|ovmf%%     | %%i440fx\|i440fx%%/%%Q35\|q35%% | Compatible but not recommended |

---

### VirtIO driver management

Windows requires paravirtualized drivers for optimal performance with Unraid’s virtualization stack.

To install or update drivers:

<Tabs>
  <TabItem value="自动化" label="自动安装">
    <WindowsVirtioAutomatic />
  </TabItem>

  <TabItem value="手动" label="手动更新">
    <WindowsVirtioManual />
  </TabItem>
</Tabs>

:::tip
Using Unraid 7 or later, you can automatically inject %%VirtIO|virtio%% drivers during the Windows installation. Enable this in ***VM Settings → Advanced Options***.
:::

---

### Setting up hibernation

Hibernation lets you save your entire Windows %%VM|vm%% state - including open applications and documents - to disk. This allows you to power off the %%VM|vm%% without losing any work. When you resume, Windows restores everything exactly as you left it, skipping the normal boot process. This feature is handy when you need to reboot or power down your Unraid host or want to save energy while keeping your %%VM|vm%%'s state intact.

:::note[Benefits of hibernation]

- Save energy by powering down idle %%VM|vm%% without losing progress
- Quickly resume work after host maintenance or updates
- 与频繁的完全关机和重启相比，降低 SSD 磨损
  :::

To use hibernation reliably, you must install the %%QEMU|qemu%% %%Guest Agent|guest-agent%% in your Windows %%VM|vm%%. This agent allows Unraid to communicate with the %%VM|vm%% for advanced operations like hibernation, shutdown, and live statistics reporting.

<details>
  <summary><strong>如何安装 %%QEMU|qemu%% %%Guest Agent|guest-agent%%</strong> - 点击展开/收起</summary>

  1. Start your Windows %%VM|vm%% with the %%VirtIO|virtio%% drivers ISO mounted.
  2. Open **File Explorer** and navigate to the %%VirtIO|virtio%% drivers media.
  3. Open the `guest-agent` folder.
  4. Run `qemu-ga-x64.msi` to install the agent. (You may briefly see a command box; no confirmation dialog will appear.)
</details>

<details>
  <summary><strong>如何在 Windows 中启用休眠</strong> - 点击展开/收起</summary>

  1. Open **Control Panel** and search for **Power Options**.
  2. Click on **Choose what the power buttons do**.
  3. Click **Change settings that are currently unavailable** to unlock shutdown settings.
  4. Check the **Hibernate** option.
  5. Click **Save changes**.

  Windows 电源菜单中现在会显示 **休眠** 选项。
</details>

:::important[What if hibernation fails?]
If your %%VM|vm%% fails to hibernate or resume properly, you may lose unsaved work or face a failed restore. Always save important data before hibernating. If issues persist, ensure the %%QEMU|qemu%% %%Guest Agent|guest-agent%% is installed and updated, and check the Windows event log for errors.
:::

---

### Performance tuning

Optimizing your Windows %%VM|vm%% can improve responsiveness, reduce disk usage, and avoid common issues with device passthrough or shutdown. These adjustments are optional and can be applied as needed.

#### Disable fast startup

Disabling fast startup can help prevent issues with device passthrough. It ensures your %%VM|vm%% hardware initializes correctly every time it boots. While this setting is designed for physical PCs, in a virtual environment, it can often cause more problems than benefits.

<details>
  <summary><strong>如何禁用快速启动</strong> - 点击展开/收起</summary>

  1. Open **Control Panel** and search for **Power**.
  2. Click on **Choose what the power buttons do**.
  3. Click **Change settings that are currently unavailable**.
  4. Uncheck **Turn on fast startup** under **Shutdown settings**.
  5. Click **Save changes**.
</details>

#### Disable hiberfil.sys

Hibernation in Windows creates a large hidden file called `hiberfil.sys`. This file can consume significant disk space and increase disk activity in your %%VM|vm%%. If you don't rely on hibernation, disabling it will free up storage and reduce unnecessary I/O activity.

<details>
  <summary><strong>如何禁用休眠并移除 hiberfil.sys</strong> - 点击展开/收起</summary>

  1. Right-click the **Start** button and select **Windows Terminal (Admin)** or **Command Prompt (Admin)**.
  2. Type: `powercfg /h off`
  3. Press Enter and reboot your %%VM|vm%%. The `hiberfil.sys` file will be removed from your C:\ drive.
</details>

#### Disable Windows indexing

Windows Search indexing continuously scans your %%virtual machine|vm%%'s storage to catalog files for faster search results. However, on a %%virtual machine|vm%%, this can cause unnecessary disk I/O, slow down performance, and increase wear on your physical storage, especially SSDs in your [%%cache pool|cache-pool%%](../manage-storage/cache-pools.mdx).

<details>
  <summary><strong>如何禁用 Windows 索引</strong> - 点击展开/收起</summary>

  1. Press **Windows + R** to open the Run dialog, type `services.msc`, and press Enter.
  2. In the Services window, scroll down and right-click **Windows Search**, then select **Stop**.
  3. Double-click **Windows Search**, change **Startup type** to **Disabled**, and click **OK**.
</details>

#### Disable automatic disk defragmenting

Windows is designed to defrag physical hard drives on a regular schedule automatically. On a %%VM|vm%% - especially when using SSD storage or thin-provisioned %%vDisks|vdisk%% - automatic defragmenting is unnecessary and can also reduce disk lifespan and degrade performance.

<details>
  <summary><strong>如何禁用自动磁盘碎片整理</strong> - 点击展开/收起</summary>

  1. Open **File Explorer**, right-click the C: drive, and select **Properties**.
  2. Go to the **Tools** tab and click **Optimize**.
  3. Click **Change settings**.
  4. Uncheck **Run on a schedule** and click **OK**.
</details>

#### Enable high-performance power mode

Power management features in Windows are designed for laptops and desktops to save energy. In a %%VM|vm%% environment, these features can unnecessarily throttle performance or suspend your %%VM|vm%%, making it less responsive and harder to manage.

Enabling **High Performance** mode ensures your %%VM|vm%% always runs at full speed and is less likely to pause or suspend unexpectedly.

<details>
  <summary><strong>如何启用高性能电源模式</strong> - 点击展开/收起</summary>

  1. Open **Control Panel** and search for "power."
  2. Click **Choose a power plan**.
  3. Select **High performance** under **Preferred plans**.
</details>

#### Enable remote desktop access

Remote desktop protocol (RDP) allows you to access your Windows %%VM|vm%% from another device. It offers better performance and compatibility compared to %%VNC|vnc-session%%. Note that RDP is supported only on Windows Professional and Enterprise editions. Also, your Windows user account **must** have a password set.

:::caution
RDP is not available on Windows Home editions. Always set a secure password for your Windows user account before enabling RDP.
:::

<details>
  <summary><strong>如何启用远程桌面（RDP）访问</strong> - 点击展开/收起</summary>

  要启用 RDP 访问，请按照以下步骤：

  1. Press **Windows + I** to open Settings, then navigate to ***System → About*** and click **Advanced system settings**.
  2. In the System Properties window, click the **Remote** tab, then select **Enable Remote Desktop**.
  3. Click **OK** to confirm the changes.
  4. From your client device, use a Microsoft RDP client to connect to the **IP address of the %%VM|vm%%** (not the Unraid server).

  :::技巧
  官方Microsoft RDP客户端适用于 Windows、Mac、Android 和 iOS。确保您的 %%VM|vm%% 处于允许局域网访问的网络桥上。
  :::
</details>

#### Fix HDMI audio with MSI interrupts

If you're having trouble with HDMI audio in a Windows %%VM|vm%% that uses %%GPU passthrough|gpu-passthrough%% (which often occurs with NVIDIA graphics cards), enabling Message Signaled Interrupts (MSI) might help. MSI enhances the way interrupts are managed for passed-through devices.

<details>
  <summary><strong>如何启用 MSI 中断</strong> - 点击展开/收起</summary>

  :::注意
  在进行注册表更改之前，请备份您的 %%VM|vm%%。不正确的修改可能导致系统不稳定。
  :::

  1. **Verify MSI capability:**
     - Start your %%VM|vm%% with %%GPU passthrough|gpu-passthrough%% enabled.
     - Access Unraid via [WebTerminal or SSH](../../system-administration/advanced-tools/command-line-interface.mdx).
     - Run the command `lspci -v -s 01:00.0` (replace `01:00.0` with your GPU's PCI address).
     - Look for the line: `Capabilities: [68] MSI: Enable+ Count=1/1 Maskable- 64bit+`.

  2. **Enable MSI in Windows:**
     - If MSI shows `Enable-`, follow [Microsoft's guide](https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/enabling-message-signaled-interrupts-in-the-registry) or use the [MSI Mode Utility](https://forums.guru3d.com/threads/windows-line-based-vs-message-signaled-based-interrupts-msi-tool.378044/) to modify your Windows registry settings.
     - Reboot the %%VM|vm%% after making the changes.

  获取更多技术细节，请参阅 [VFIO 中断解释](https://vfio.blogspot.com/2014/09/vfio-interrupts-and-how-to-coax-windows.html)。
</details>

---

### Upgrading to Windows 11

Windows 11 requires TPM 2.0 and Secure Boot. Unraid's **OVMF-TPM** BIOS provides the virtual TPM support needed for these requirements.

:::important[Before upgrading]

- Create a complete backup of your %%VM|vm%%.
- Ensure that Unraid is running version 6.10 or later.
- 确保您的 Windows 10 %%VM|vm%% 满足 [Windows 11 的系统要求](https://www.microsoft.com/en-us/windows/windows-11-specifications)。
  :::

To add TPM support:

1. Shut down your Windows 10 %%VM|vm%%.
2. Edit the %%VM|vm%% settings.
3. Change **BIOS** from *%%OVMF|ovmf%%* to *%%OVMF|ovmf%%-TPM*.
4. Save the changes and start the %%VM|vm%%.

#### Upgrade methods

<Tabs>
  <TabItem value="就地升级" label="就地升级">
    <WindowsUpgradeInPlace />
  </TabItem>

  <TabItem value="全新安装" label="全新安装">
    <WindowsUpgradeCleanInstall />
  </TabItem>
</Tabs>

## Expanding Windows VM vDisk partitions

:::caution[Data loss risk]
Expanding or modifying %%vDisk|vdisk%% and partition layouts can lead to irreversible data loss if not done carefully. Always create a full backup or snapshot of your %%VM|vm%% before proceeding.
:::

After you expand your %%vDisk|vdisk%% following the steps in [Expand a vDisk](../create-virtual-machines/vm-setup.mdx#expand-a-vdisk), you may encounter an issue where Windows’ default recovery partition blocks you from easily expanding your system (C:) partition to utilize the new space. To resolve this issue, you need to delete the recovery partition and then use Windows Disk Management to expand the partition.

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![Resize vDisk 2](/img/Resize_vdisk_2.png)
</div>

After you complete the initial %%vDisk|vdisk%% expansion:

1. Start your Windows VM.
2. **Open command prompt:** Press the Windows key, type `cmd`, and hit Enter.
3. **Launch diskpart:** Type `diskpart` and press Enter.
4. **List disks:** Type `list disk` and press Enter.
5. **Select the expanded disk:** Type `select disk #`, replacing `#` with the correct disk number.
6. **List partitions:** Type `list partition` and press Enter.
7. **Identify the recovery partition:** Look for the recovery partition that comes after your primary partition.
8. **Select and delete the recovery partition:**
   - Type `select partition #`, replacing `#` with the number of the recovery partition.
   - Type `delete partition override` and press Enter.
9. **Expand the C: partition:**
   - Right-click the Start menu and select **Disk Management**.
   - Right-click the partition you want to extend (usually C:) and choose **Extend Volume...**.
   - Follow the prompts to use the unallocated space.

<div className="flex-容器" style={{ margin: 'auto', maxWidth: '800px'}}>
  <figure className="flex-figure">
    <img src="/img/Resize_vdisk_3.png" alt="调整虚拟磁盘3" />
  </figure>

  <figure className="flex-figure">
    <img src="/img/Resize_vdisk_4.png" alt="调整虚拟磁盘4" />
  </figure>
</div>

:::tip
You only need to remove the recovery partition if it blocks access to adjacent free space. If the unallocated space is already next to your C: partition, you can extend it without deleting anything.
:::

:::warning
Changes made to disk partitions are permanent and cannot be undone. Ensure that your data is securely backed up before deleting any partitions.
:::
