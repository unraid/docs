---
sidebar_position: 3
sidebar_label: VM中的Windows
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import WindowsVirtioAutomatic from './partials/windows-virtio-automatic.mdx';
import WindowsVirtioManual from './partials/windows-virtio-manual.mdx';
import WindowsUpgradeInPlace from './partials/windows-upgrade-in-place.mdx';
import WindowsUpgradeCleanInstall from './partials/windows-upgrade-clean-install.mdx';

# VM中的Windows

Windows 是 Unraid 用户中最受欢迎的客制操作系统之一，尤其适用于游戏、生产力和支持旧版应用程序。这是运行 Windows %%VM|vm%% 的一些重要注意事项。

:::caution[Before 开始]
- 微软已于2020年1月结束了对Windows 7的支持，于2023年1月结束了对Windows 8.1的支持，并计划于2025年10月结束对Windows 10的支持。请使用Windows 11（或更新版本）或Server 2022（或更新版本）以获得持续的安全更新。
- 在激活 Windows 许可之前，始终测试 %%VM|vm%% 的稳定性。
- 对于%%GPU直通|gpu-passthrough%%，使用%%OVMF|ovmf%%（%%UEFI|uefi%%）BIOS与Windows 11或更新版本。
:::

### 支持的配置

| Windows 版本          | 推荐的 BIOS           | 机器类型                            | 笔记                       |
| ------------------- | ------------------ | ------------------------------- | ------------------------ |
| Windows 11          | %%OVMF\|ovmf%% TPM | %%Q35\|q35%%                    | 需要 TPM 2.0 模拟            |
| Windows Server 2022 | %%OVMF\|ovmf%%     | %%Q35\|q35%%                    | 适合企业负载                   |
| Windows 10          | %%OVMF\|ovmf%%     | %%Q35\|q35%%                    | 已停用（生命周期结束于 2025 年 10 月） |
| Windows Server 2019 | %%OVMF\|ovmf%%     | %%i440fx\|i440fx%%/%%Q35\|q35%% | 兼容但不推荐                   |

---

### VirtIO 驱动管理

Windows 需要使用准虚拟化驱动程序以在 Unraid 的虚拟化堆栈上获得最佳性能。

安装或更新驱动程序：

<Tabs>
  <TabItem value="自动化" label="自动安装">
    <WindowsVirtioAutomatic />
  </TabItem>

  <TabItem value="手动" label="手动更新">
    <WindowsVirtioManual />
  </TabItem>
</Tabs>

:::tip
使用 Unraid 7 或更高版本，您可以在 Windows 安装期间自动注入 %%VirtIO|virtio%% 驱动程序。在 ***VM 设置 → 高级选项*** 中启用此功能。
:::

---

### 设置休眠

休眠功能让您可以将整个 Windows %%VM|vm%% 状态（包括打开的应用程序和文档）保存到磁盘。这使您可以在不丢失任何工作的情况下关闭 %%VM|vm%%。当您恢复时，Windows 会精确地恢复所有内容，跳过正常的启动过程。当您需要重启或关闭 Unraid 主机，或者希望在保留 %%VM|vm%% 状态完整的同时节省能源时，此功能非常方便。

:::note[Benefits 休眠]
- 关闭闲置 %%VM|vm%% 来节约能源而又不丢失进度
- 在主机维护或更新后快速恢复工作
- 与频繁的完全关机和重启相比，降低 SSD 磨损
:::

要可靠地使用休眠功能，您必须在 Windows %%VM|vm%% 中安装 %%QEMU|qemu%% %%Guest Agent|guest-agent%%。该代理允许 Unraid 与 %%VM|vm%% 进行通信，以进行诸如休眠、关机和实时统计报告等高级操作。

<details>
  <summary><strong>如何安装 %%QEMU|qemu%% %%Guest Agent|guest-agent%%</strong> - 点击展开/收起</summary>

  1. 启动带有 %%VirtIO|virtio%% 驱动程序 ISO 的 Windows %%VM|vm%%。
  2. 打开 **文件资源管理器** 并导航到 %%VirtIO|virtio%% 驱动器媒体。
  3. 打开 `guest-agent` 文件夹。
  4. 运行 `qemu-ga-x64.msi` 以安装代理。（您可能会短暂看到一个命令框；不会显示确认对话框。）
</details>

<details>
  <summary><strong>如何在 Windows 中启用休眠</strong> - 点击展开/收起</summary>

  1. 打开 **控制面板** 并搜索 **电源选项**。
  2. 点击 **选择电源按钮的功能**。
  3. 点击 **更改当前不可用的设置** 以解锁关机设置。
  4. 勾选 **休眠** 选项。
  5. 点击 **保存更改**。

  Windows 电源菜单中现在会显示 **休眠** 选项。
</details>

:::important[What 如果休眠失败？]
如果您的 %%VM|vm%% 无法正常休眠或恢复，可能会丢失未保存的工作或面临恢复失败的情况。休眠之前请务必保存重要数据。如果问题持续存在，请确保安装并更新 %%QEMU|qemu%% %%Guest Agent|guest-agent%%，并检查 Windows 事件日志中的错误。
:::

---

### 性能调优

优化您的 Windows %%VM|vm%% 可以提高响应速度、减少磁盘使用并避免设备直通或关机时出现的常见问题。这些调整是可选的，可以根据需要进行应用。

#### 禁用快速启动

禁用快速启动可以帮助避免设备直通问题。它确保您的 %%VM|vm%% 硬件在每次启动时正确初始化。虽然该设置是为物理 PC 设计的，在虚拟环境中，它通常会引发比带来好处更多的问题。

<details>
  <summary><strong>如何禁用快速启动</strong> - 点击展开/收起</summary>

  1. 打开 **控制面板** 并搜索 **电源**。
  2. 点击 **选择电源按钮的功能**。
  3. 点击 **更改当前不可用的设置**。
  4. 在 **关机设置** 下取消勾选 **启用快速启动**。
  5. 点击 **保存更改**。
</details>

#### 禁用 hiberfil.sys

Windows 的休眠功能会创建一个名为 `hiberfil.sys` 的大型隐藏文件。该文件可能会占用大量磁盘空间并增加 %%VM|vm%% 的磁盘活动。如果您不依赖休眠功能，禁用它将释放存储空间并减少不必要的 I/O 活动。

<details>
  <summary><strong>如何禁用休眠并移除 hiberfil.sys</strong> - 点击展开/收起</summary>

  1. 右键点击 **开始** 按钮并选择 **Windows 终端（管理员）** 或 **命令提示符（管理员）**。
  2. 输入：`powercfg /h off`
  3. 按 Enter 键并重新启动您的 %%VM|vm%%。`hiberfil.sys` 文件将从您的 C:\ 驱动器中删除。
</details>

#### 禁用 Windows 索引

Windows 搜索索引会持续扫描您的 %%virtual machine|vm%% 的存储以对文件进行编目，以便更快的搜索结果。然而，在 %%virtual machine|vm%% 上，这可能导致不必要的磁盘 I/O，降低性能，并增加对物理存储的磨损，特别是您 [%%cache pool|cache-pool%%](../manage-storage/cache-pools.mdx) 中的 SSD。

<details>
  <summary><strong>如何禁用 Windows 索引</strong> - 点击展开/收起</summary>

  1. 按 **Windows + R** 打开运行对话框，输入 `services.msc`，然后按回车。
  2. 在服务窗口中，向下滚动并右键点击 **Windows Search**，然后选择 **停止**。
  3. 双击 **Windows Search**，更改 **启动类型** 为 **禁用**，然后点击 **确定**。
</details>

#### 禁用自动磁盘碎片整理

Windows 设计为定期自动碎片整理物理硬盘。在 %%VM|vm%% 上—尤其是使用 SSD 存储或精简配置的 %%vDisks|vdisk%% 时—自动碎片整理是多余的，还可能会降低磁盘寿命并降低性能。

<details>
  <summary><strong>如何禁用自动磁盘碎片整理</strong> - 点击展开/收起</summary>

  1. 打开 **文件资源管理器**，右键点击 C: 驱动器，然后选择 **属性**。
  2. 转到 **工具** 标签并点击 **优化**。
  3. 点击 **更改设置**。
  4. 取消勾选 **按计划运行**，然后点击 **确定**。
</details>

#### 启用高性能电源模式

Windows 的电源管理功能专为笔记本电脑和台式机设计，以节省能源。在 %%VM|vm%% 环境中，这些功能可能会不必要地限制性能或挂起您的 %%VM|vm%%，使其响应速度变慢且更难管理。

启用 **高性能** 模式可以确保您的 %%VM|vm%% 始终以全速运行，并且不太可能意外暂停或挂起。

<details>
  <summary><strong>如何启用高性能电源模式</strong> - 点击展开/收起</summary>

  1. 打开 **控制面板** 并搜索 "电源"。
  2. 点击 **选择电源计划**。
  3. 在 **首选计划** 下选择 **高性能**。
</details>

#### 启用远程桌面访问

远程桌面协议 (RDP) 允许您从其他设备访问您的 Windows %%VM|vm%%。与 %%VNC|vnc-session%% 相比，它提供了更好的性能和兼容性。请注意，RDP 仅支持在 Windows 专业版和企业版上。此外，您的 Windows 用户帐户**必须**设置密码。

:::caution
RDP 在 Windows 家庭版上不可用。在启用 RDP 之前，请务必为您的 Windows 用户帐户设置一个安全的密码。
:::

<details>
  <summary><strong>如何启用远程桌面（RDP）访问</strong> - 点击展开/收起</summary>

  要启用 RDP 访问，请按照以下步骤：

  1. 按 **Windows + I** 打开设置，然后导航至 ***系统 → 关于*** 并点击 **高级系统设置**。
  2. 在系统属性窗口中，点击 **远程** 标签，然后选择 **启用远程桌面**。
  3. 点击 **确定** 确认更改。
  4. 从您的客户端设备，使用 Microsoft RDP 客户端连接到 **%%VM|vm%% 的 IP 地址**（而不是 Unraid 服务器）。

  :::技巧
  官方Microsoft RDP客户端适用于 Windows、Mac、Android 和 iOS。确保您的 %%VM|vm%% 处于允许局域网访问的网络桥上。
  :::
</details>

#### 使用 MSI 中断修复 HDMI 音频

如果您在使用 %%GPU passthrough|gpu-passthrough%%（通常发生在 NVIDIA 显卡上）时的 Windows %%VM|vm%% 出现 HDMI 音频问题，启用消息信号中断（MSI）可能会有所帮助。MSI 改善了传递设备的中断管理方式。

<details>
  <summary><strong>如何启用 MSI 中断</strong> - 点击展开/收起</summary>

  :::注意
  在进行注册表更改之前，请备份您的 %%VM|vm%%。不正确的修改可能导致系统不稳定。
  :::

  1. **验证 MSI 功能：**
     - 启用 %%GPU passthrough|gpu-passthrough%% 启动您的 %%VM|vm%%。
     - 通过 [WebTerminal 或 SSH](../../system-administration/advanced-tools/command-line-interface.mdx) 访问 Unraid。
     - 运行命令 `lspci -v -s 01:00.0`（将 `01:00.0` 替换为您的 GPU 的 PCI 地址）。
     - 查找行：`Capabilities: [68] MSI: Enable+ Count=1/1 Maskable- 64bit+`。

  2. **在 Windows 中启用 MSI：**
     - 如果 MSI 显示`Enable-`，请遵循 [微软指南](https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/enabling-message-signaled-interrupts-in-the-registry) 或使用 [MSI 模式工具](https://forums.guru3d.com/threads/windows-line-based-vs-message-signaled-based-interrupts-msi-tool.378044/) 修改您的 Windows 注册表设置。
     - 在更改后重启 %%VM|vm%%。

  获取更多技术细节，请参阅 [VFIO 中断解释](https://vfio.blogspot.com/2014/09/vfio-interrupts-and-how-to-coax-windows.html)。
</details>

---

### 升级到 Windows 11

Windows 11 需要 TPM 2.0 和安全启动支持。Unraid 的 **OVMF-TPM** BIOS 提供了所需的虚拟 TPM 支持。

:::important[Before 升级]
- 创建完整的 %%VM|vm%% 备份。
- 确保 Unraid 运行的是版本 6.10 或更高版本。
- 确保您的 Windows 10 %%VM|vm%% 满足 [Windows 11 的系统要求](https://www.microsoft.com/en-us/windows/windows-11-specifications)。
:::

添加 TPM 支持：

1. 关闭您的Windows 10 %%VM|vm%%。
2. 编辑%%VM|vm%%设置。
3. 将**BIOS**从\*%%OVMF|ovmf%%*更改为*%%OVMF|ovmf%%-TPM\*。
4. 保存更改并启动%%VM|vm%%。

#### 升级方法

<Tabs>
  <TabItem value="就地升级" label="就地升级">
    <WindowsUpgradeInPlace />
  </TabItem>

  <TabItem value="全新安装" label="全新安装">
    <WindowsUpgradeCleanInstall />
  </TabItem>
</Tabs>

## 扩展Windows VM vDisk分区

:::caution[Data 数据丢失风险]
扩展或修改 %%vDisk|vdisk%% 和分区布局，如果操作不当，可能导致不可逆的数据丢失。在进行操作之前务必创建 %%VM|vm%% 的完整备份或快照。
:::

在按照[扩展 vDisk](../create-virtual-machines/vm-setup.mdx#expand-a-vdisk) 中的步骤扩展 %%vDisk|vdisk%% 之后，您可能会遇到一个问题，即 Windows 的默认恢复分区会阻止您轻松扩展系统 (C:) 分区以利用新增的空间。要解决此问题，您需要删除恢复分区，然后使用 Windows 磁盘管理来扩展分区。

<div style={{ margin: 'auto', maxWidth: '600px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
  ![Resize vDisk 2](/img/Resize_vdisk_2.png)
</div>

完成初始%%vDisk|vdisk%%扩展后：

1. 启动您的Windows VM。
2. **打开命令提示符：** 按Windows键，输入`cmd`，然后按Enter。
3. **启动diskpart：** 输入`diskpart`并按Enter。
4. **列出磁盘：** 输入`list disk`并按Enter。
5. **选择扩展的磁盘：** 输入`select disk #`，替换`#`为正确的磁盘编号。
6. **列出分区：** 输入`list partition`并按Enter。
7. **识别恢复分区：** 查找在您的主分区之后的恢复分区。
8. **选择并删除恢复分区：**
   - 输入`select partition #`，替换`#`为恢复分区的编号。
   - 输入`delete partition override`并按Enter。
9. **扩展C:分区：**
   - 右键单击开始菜单并选择**磁盘管理**。
   - 右键单击您想要扩展的分区（通常是C:）并选择**扩展卷...**。
   - 按照提示使用未分配的空间。

<div className="flex-容器" style={{ margin: 'auto', maxWidth: '800px'}}>
  <figure className="弹性图形">
    <img src="/img/Resize_vdisk_3.png" alt="调整虚拟磁盘3" />
  </figure>

  <figure className="弹性图形">
    <img src="/img/Resize_vdisk_4.png" alt="调整虚拟磁盘4" />
  </figure>
</div>

:::tip
只有在恢复分区阻挡邻近空闲空间时，才需要将其移除。如果未分配的空间已经在您的 C: 分区旁边，您可以直接扩展而无需删除任何内容。
:::

:::warning
对磁盘分区所做的更改是永久性的，无法撤消。在删除任何分区之前，请确保您的数据已安全备份。
:::
