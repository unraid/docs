---
sidebar_position: 5
sidebar_label: VM conversion & migration
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# VM conversion and migration

When consolidating hardware, preserving legacy systems, or testing upgrades in a virtual environment, you may need to convert a physical disk or migrate an existing system into a %%virtual machine|vm%% on Unraid. This process applies to both Linux and Windows systems, enabling you to run your installation as a %%VM|vm%% within your Unraid server.

:::note\[Prerequisites]

- Your Unraid server should meet the minimum [hardware requirements for virtualization](./overview-and-system-prep.mdx#requirements) (see table below).
- The source disk must be connected to your Unraid server (via SATA, USB, or as an unassigned device).
- Ensure you have enough free space in your **%%array|array%%** or **%%cache pool|cache-pool%%** to accommodate the new virtual disk image.
- 在开始转换或迁移过程之前，备份任何重要数据。

## Hardware requirements

| 组件                   | 最低要求                                                                              | 建议以获得最佳性能                                                        |
| -------------------- | --------------------------------------------------------------------------------- | ---------------------------------------------------------------- |
| **CPU**              | 64-bit with hardware virtualization (%%Intel VT-X\|intel-vt-x%%/%%AMD-V\|amd-v%%) | 具有 VT-d/AMD-Vi 直通功能的多核 CPU                                       |
| **内存**               | 8 GB                                                                              | 16 GB 或更多                                                        |
| **存储**               | SSD 或 NVMe %%cache pool\|cache-pool%% 需要足够的空间                                     | Dedicated NVMe %%cache pool\|cache-pool%% for %%VM\|vm%% storage |
| **Motherboard/BIOS** | 启用虚拟化的%%UEFI\|uefi%%                                                              | 启用%%IOMMU\|iommu%%/VT-d/AMD-Vi的%%UEFI\|uefi%%                    |

---

## Convert a physical disk to a VM

Migrating an existing Linux or Windows system into a %%virtual machine|vm%% on your Unraid server can be a great way to save hardware space, keep legacy systems running, or test new upgrades safely.

To convert a physical disk to a %%VM|vm%%:

<Tabs>
  <TabItem value="Linux" label="Linux" default>
    <h4>步骤 1: 准备物理磁盘</h4>

    1. 通过 SATA 或 USB 将源磁盘连接到您的 Unraid 服务器。
    2. Log in to the %%WebGUI|web-gui%% (`http://tower` or `http://tower.local`).
    3. Click on the **Main** tab.
    4. 启动 **%%array|array%%**，如果其尚未运行。
    5. 在 **未分配设备** 中找到您的磁盘。
    6. 注意设备字母（例如，`sdb`，`sdc`）和磁盘大小。你需要在你的 **%%array|array%%** 或 **%%cache pool|cache-pool%%** 上至少有这个空闲空间用于新的 %%virtual disk|vdisk%%。

    <h4>步骤 2: 创建新的虚拟机</h4>

    参考[创建您的虚拟机](../create-virtual-machines/vm-setup.mdx#creating-your-own-virtual-machines)指南，但有以下例外：

    - 设置 **BIOS** 为 **OVMF**。
      确保指定 **VirtIO 驱动程序 ISO** 以获得[最佳性能](./overview-and-system-prep.mdx#set-up-virtualization-preferences)。
    - 将 %%VM|vm%% 映像存储在 **%%cache pool|cache-pool%%** 上，而不是 %%array|array%%，以获得 [最佳性能](./overview-and-system-prep.mdx#user-shares-for-virtualization)。

    <h4>步骤 3: 将物理磁盘转换为 %%虚拟磁盘|vdisk%% 映像</h4>

    打开终端 (使用 [%%SSH|ssh%%](../../system-administration/advanced-tools/command-line-interface.mdx) 或本地控制台) 并以 `root` 身份登录。

    使用以下命令将物理磁盘转换为 %%虚拟磁盘|vdisk%% 映像：

    ```
    qemu-img convert -p -O raw /dev/sdX /mnt/user/[vdisk_share]/[vmname]/vdisk1.img
    ```

    - **/dev/sdX**: 替换为步骤 1 中的设备字母 (例如 `/dev/sdb`)
    - **[vdisk_share]**: 保存你的 %%VM|vm%% 映像的共享
    - **[vmname]**: 你想为你的 %%VM|vm%% 指定的名称

    **命令分解：**

    - `qemu-img convert`: 此工具用于磁盘映像转换。
    - `-p`: 显示百分比进度。
    - `-O raw`: 输出格式设置为 raw (Unraid 默认)。
    - `/dev/sdX`: 源是您的物理磁盘。
    - `/mnt/user/[vdisk_share]/[vmname]/vdisk1.img`: 目标是 %%虚拟磁盘|vdisk%% 映像。

    等待操作完成。生成的 `.img` 文件将是你的 %%VM|vm%% 的主磁盘。
  </TabItem>

  <TabItem value="Windows" label="Windows">
    <h4>步骤 1: 编辑您的虚拟机的 XML</h4>

    - 在 %%VMs|vm%% 选项卡中，点击 %%VM|vm%% 图标并从上下文菜单中选择 **编辑 XML**。

    - 接下来，向下滚动 XML，找到 `<target>` 标签，其中 `<disk>` 设置的 `<source>` 文件为 `vdisk1.img`。它应该如下所示：

      ```xml

      <disk type='file' device='disk'>
      <driver name='qemu' type='raw' cache='writeback'/>
      <source file='/mnt/cache/vdisk_share/vmname/vdisk1.img'/>
      <backingStore/>
      <target dev='hda' bus='virtio'/>
      <boot order='1'/>
      <alias name='virtio-disk0'/>
      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>
      </disk>
      ```

    - 更改 `<target>` 标签中 **bus** 属性，从 `virtio` 改为 `ide`。

    - Then, remove the entire `<address>` line for that `<disk>`.

    - 更新后的 XML 应如下所示：

      ```xml

      <disk type='file' device='disk'>
      <driver name='qemu' type='raw' cache='writeback'/>
      <source file='/mnt/cache/vdisk_share/vmname/vdisk1.img'/>
      <backingStore/>
      <target dev='hda' bus='ide'/>
      <boot order='1'/>
      </disk>
      ```

    - 最后，点击 **更新** 保存您对 %%虚拟机|vm%% XML 的更改。

    <h4>步骤 2: 从虚拟机内部安装 VirtIO 驱动程序（仅适用于 Windows 客户端）</h4>

    - 打开 **Windows 资源管理器**，访问 %%VirtIO|virtio%% 虚拟 CD-ROM，查看其内容。
      - 进入 **Balloon** 文件夹。
      - 在该文件夹中，找到适合您的 **Windows 操作系统版本** 的子文件夹（例如，`w8.1`）。
      - 进入 **amd64** 子文件夹。
      - 右键单击 **balloon.inf** 文件并从上下文菜单中选择 **安装**。（你需要启用文件扩展名可见性才能执行此操作。）
    - 为每个以下文件夹重复这些步骤：
      - **NetKVM**
      - **vioserial**
      - **viostor**
    - 安装完驱动程序后，重新进入虚拟 CD-ROM，打开 **guest-agent** 文件夹。
    - 双击 **qemu-ga-x64.msi** 以安装 %%QEMU|qemu%%/%%KVM|kvm%% 客户代理。

    <h4>步骤 3：将磁盘总线转换回 VirtIO</h4>

    - 如果您的 %%VM|vm%% 正在运行，请继续**关闭它**。
    - 在 **VMs** 选项卡中，单击 %%VM|vm%% 图标并从上下文菜单中选择 **编辑 XML**。
    - 找到 `vdisk1.img` 的 `<disk>` 部分，并在 `<target>` 标签中将 `bus='ide'` 改回 `bus='virtio'`。
    - 点击 **更新** 保存您对 %%VM|vm%% 的更改。
    - 现在您可以启动转换后的 %%虚拟机|vm%%！
  </TabItem>
</Tabs>

---

## Migrating a physical disk to a VM

You can run a Windows installation directly from a physical disk in an Unraid virtual machine (VM). This method helps migrate an existing Windows system without converting it to a virtual disk image. For a visual walkthrough, check out Spaceinvader One’s tutorial:\
[How to pass through hard drives, convert disks, and test performance in Unraid VMs (YouTube)](https://www.youtube.com/watch?v=QaB9HhpbDAI).

:::important[Choosing your migration approach]

**Physical disk passthrough:** This uses the original disk directly in the %%VM|vm%%.

- Pros: Fastest method, no image conversion required.
- Cons: Takes up a SATA port; Unraid cannot use the disk for other purposes when it's attached to the VM.

**Disk image conversion:** This converts the physical disk to a %%virtual disk|vdisk%% image (`.img`) for use in the %%VM|vm%%.

- Pros: More flexibility, allows the disk to be used as an Unraid share or for snapshots.
- Cons: Requires time and free space for the conversion process.

如果你想进行简单的迁移或计划双启动磁盘，请选择直通。选择映像转换以获得更好的便携性和备份选项。
:::

:::note\[Prerequisites]

- Back up your Windows installation before starting.
- Have a spare USB flash drive ready for recovery tools.
- Select a hardware preparation tool that enables Windows to boot on virtualized hardware by modifying drivers and the hardware abstraction layer (HAL):
  - **Microsoft Sysprep** (free and built into Windows 8.1 and later)
  - **Acronis True Image 2025** (commercial solution with advanced migration capabilities)
- 确保你的 Unraid 服务器有一个用于实体磁盘的空闲 SATA 或 NVMe 接口。
  :::

<h4>Step 1: Prepare the Windows disk for migration</h4>

Moving a Windows installation to new hardware, whether physical or virtual, can result in boot failures due to hardware differences. Follow one of the methods below to prepare your Windows system:

<h5>Option A: Microsoft sysprep (recommended - free)</h5>

Sysprep is built into Windows and eliminates unique system information, preparing Windows for different hardware.

:::note[Before running sysprep]

- Temporarily disable any antivirus software.
- Clean up unnecessary user profiles and temporary files.
- 修复或删除任何可能阻止 sysprep 运行的问题 Microsoft Store 应用。
  :::

1. **Run sysprep:**
   - Open Command Prompt as an administrator.
   - Navigate to the sysprep directory:

     ```bash
     cd C:\Windows\System32\Sysprep
     ```
   - Execute sysprep with generalization:
     ```bash
     sysprep.exe /generalize /shutdown /oobe
     ```
   - The system will generalize the installation and then shut down.

2. **Install the disk in your Unraid server** after the shutdown.

<h5>Option B: Acronis True Image 2025 (commercial)</h5>

Acronis True Image 2025 features Universal Restore, which assists with hardware migration.

1. Download and install [Acronis True Image 2025](https://www.acronis.com/en-us/products/true-image/).
2. Create bootable recovery media using the included tools:
   - Choose the Windows-like interface.
   - Select the architecture that matches your Windows (32-bit or 64-bit).
3. Boot your Windows system from the Acronis recovery media.
4. Follow the on-screen instructions to apply Universal Restore to your Windows disk. This will update drivers and the HAL for better compatibility with virtualized hardware.
5. Shut down the system and install the disk in your Unraid server.

<h4>Step 2: Identify the physical disk in Unraid</h4>

1. Log in to the %%WebGUI|web-gui%% (`http://tower` or `http://tower.local`).
2. Go to the **Main** tab.
3. Start the %%array|array%% if it’s not already running.
4. Locate your disk under **Unassigned Devices**.
5. Note the device letter (for example, `sdb`, `sdc`) for use in the %%VM|vm%% configuration.

<h4>Step 3: Create a new virtual machine</h4>

1. Go to the **%%VMs|vm%%** tab in the %%WebGUI|web-gui%%. If the tab is missing, ensure that virtualization is enabled and that hardware requirements are met.
2. Click **Add VM**.
3. Follow the [Creating your own virtual machines](../create-virtual-machines/vm-setup.mdx#creating-your-own-virtual-machines) guide, using these settings:
   - Set **BIOS** to %%SeaBIOS|seabios%% (try %%OVMF|ovmf%% if %%SeaBIOS|seabios%% fails to boot).
   - Leave **OS Install ISO** blank.
   - Specify the **VirtIO Drivers ISO** for optimal performance after boot.
   - For the primary %%virtual disk|vdisk%%, select any location and size (this will be replaced in the next step).
   - Uncheck **Start VM after creation**.

<h4>Step 4: Edit the XML for your virtual machine</h4>

You'll need to modify the %%VM|vm%%'s XML configuration to connect your physical disk to the %%virtual machine|vm%%.

1. From the **VMs** tab, click the %%VM|vm%% icon, then select **Edit XML** from the context menu.

2. Scroll down in the XML and find the existing `<disk>` entry for your primary %%virtual disk|vdisk%%. This usually points to a `.img` file and will look something like this:

   ```xml

   <disk type='file' device='disk'>
   <driver name='qemu' type='raw' cache='writeback'/>
   <source file='/mnt/cache/vdisk_share/vmname/vdisk1.img'/>
   <backingStore/>
   <target dev='hda' bus='virtio'/>
   <boot order='1'/>
   <alias name='virtio-disk0'/>
   <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>
   </disk>
   ```

   Replace this block with the following, where `sdX` is the device letter or, better yet, use `/dev/disk/by-id/[your-disk-id]` for a more reliable device assignment (refer to the [Unraid Docs: Using a physical disk in a VM]):

   ```xml

   <disk type='block' device='disk'>
   <driver name='qemu' type='raw' cache='writeback'/>
   <source dev='/dev/disk/by-id/[your-disk-id]'/>
   <target dev='hdd' bus='sata'/>
   </disk>
   ```

   If your disk is IDE, change the bus from "SATA" to "IDE".

   Using `/dev/disk/by-id/` is preferred over `/dev/sdX` to ensure the disk assignment stays consistent after reboots or hardware changes.

3. Click **Update** to save your XML changes.

<h4>Step 5: Install drivers</h4>

1. Start your %%VM|vm%%.
2. Once in Windows, open Device Manager by right-clicking the Start menu and selecting **Device Manager**.
3. Look for devices marked with a yellow exclamation mark (indicating missing drivers). Right-click on each and select **Update driver**.
4. Choose **Browse my computer for drivers**.
5. Direct it to the drive where the %%VirtIO|virtio%% Drivers ISO is mounted (usually D: or E:).
6. Make sure **Include subfolders** is checked, then click **Next**.
7. Repeat this process for each device with missing drivers, commonly including: SCSI Controller, Ethernet, Balloon, and Serial devices.

Remember to reinstall those applications after migration if you use software that installs its own drivers (such as antivirus programs).

:::tip
If you are stuck at %%SeaBIOS|seabios%% with a "Booting from Hard Disk" message, it’s likely because your Windows OS was installed using %%UEFI|uefi%% instead of the traditional BIOS. In this case, recreate the VM using %%OVMF|ovmf%% as the BIOS type rather than %%SeaBIOS|seabios%%. Most modern Windows installations (Windows 8.1, 10, and 11) support %%UEFI|uefi%% and may need %%OVMF|ovmf%% to boot successfully. The rest of the conversion process will remain the same.
:::

---

## Xen to KVM migration

:::info[Historical Context]
Unraid supported %%Xen|xen-hvm%% from early 6.x versions until it was deprecated in 6.2 (September 2016) and later removed entirely. This migration guide is relevant for users upgrading from very old Unraid installations (pre-2017) to modern versions.
:::

A %%Xen|xen-hvm%% hypervisor is a virtualization platform that allows multiple operating systems to run on the same hardware. In Unraid, %%Xen|xen-hvm%% was historically used for %%virtual machines|vm%%, but %%KVM|kvm%% is now the standard. Migrating from %%Xen|xen-hvm%% to %%KVM|kvm%% is essential for utilizing modern Unraid features, enabling hardware passthrough, and ensuring compatibility with current releases.

The process of migrating a %%VM|vm%% from %%Xen|xen-hvm%% to %%KVM|kvm%% varies depending on whether your %%VM|vm%% is set up as a paravirtualized (PV) or hardware-virtualized (%%HVM|hvm%%) guest. This guide focuses specifically on converting Windows VMs that utilize Xen’s GPLPV drivers, as they require special handling.

Always create a backup of your %%Xen|xen-hvm%% virtual disk before starting this process. And test your migration on the backup to prevent data loss.

:::info[Why migrate?]
Unraid no longer supports %%Xen|xen-hvm%% from version 6.2 onward. %%KVM|kvm%% is now mandatory for VM management, hardware passthrough, and ongoing updates. Migrating ensures your VMs remain secure and compatible with new features.
:::

### Windows conversion procedure

To convert a Windows VM from %%Xen|xen-hvm%% to %%KVM|kvm%%, follow these steps. Remember to **remove any PCI device passthrough from your %%Xen|xen-hvm%% domain configuration** before you begin. These devices can be added back after the migration is complete.

<details>
  <summary><strong>步骤 1：确定您的 VM 是否使用 Xen 的 GPLPV 驱动程序</strong> -，点击展开/折叠</summary>

  1. Inside your %%Xen|xen-hvm%% VM, open **Windows Device Manager** (press *Windows key + X*, then select **Device Manager**).
  2. Expand **Network adapters** and check the device name.
     - If the name contains "Xen," you are using GPLPV drivers.
     - If it doesn't, skip to the step about rebooting into %%KVM|kvm%% mode.

  :::提示
  如果您不使用 GPLPV 驱动程序，可以跳过接下来的几个步骤，并从进入 %%KVM|kvm%% 模式部分继续。  :::
</details>

<details>
  <summary><strong>步骤 2：为 GPLPV 驱动程序移除准备 Windows</strong> - 点击展开/折叠</summary>

  1. Open a command prompt as Administrator (**Start menu** → type `cmd` → right-click **Command Prompt** → select **Run as administrator**).
  2. Enter the following command:
     ```
     bcdedit -set loadoptions nogplpv
     ```
  3. Reboot your VM.
</details>

<details>
  <summary><strong>步骤 1：确定您的 VM 是否使用 Xen 的 GPLPV 驱动程序</strong> -，点击展开/折叠</summary>

  重启后，使用 [Xen Project Wiki](https://wiki.xenproject.org/wiki/Xen_Windows_GPLPV) 中的全面手动移除过程从系统中完全清除所有 %%Xen|xen-hvm%% GPLPV 驱动程序。

  :::提示
  如果您不使用 GPLPV 驱动程序，可以跳过接下来的几个步骤，并从进入 %%KVM|kvm%% 模式部分继续。  :::
</details>

<details>
  <summary><strong>步骤 2：为 GPLPV 驱动程序移除准备 Windows</strong> - 点击展开/折叠</summary>

  1. Ensure the **VM manager** is enabled:
     - Go to ***Settings → VM manager***.
     - Set **Enable VMs** to **Yes**.
     - Download the latest **VirtIO drivers ISO** for Windows by selecting it from the dropdown menu and clicking **Download**.

  2. Navigate to the **VMs** tab and click **Add VM**.

  3. Select the Windows version that matches your original %%Xen|xen-hvm%% virtual machine.

  4. Configure the basic settings:
     - **Name**: Assign a descriptive name to your VM.
     - **VirtIO drivers ISO**: Choose the version you just downloaded.

  5. Under **Primary vDisk Location**:
     - Browse and select your existing %%Xen|xen-hvm%% virtual disk.

  6. Add a **temporary secondary vDisk**:
     - Click the green plus sign.
     - Set the size to **1M** (this will enforce IDE bus compatibility during the initial boot).
     - Choose any temporary directory for the location (this will be removed later).

  7. Leave the other settings for graphics and sound at their default values, then click **Create**.

  8. Immediately force-stop the VM:
     - Click the VM icon and choose **Force stop**.

  9. Edit the VM configuration:
     - Click the VM icon and select **Edit**.
     - Switch to **XML view** using the toggle in the top-right corner.

  10. Modify the primary disk XML:
      - Locate the `<disk>` section for your primary virtual disk.
      - Remove the entire `<address>` line.
      - Change `bus='virtio'` to `bus='ide'` in the `<target>` tag.
      - Click **Update**.

  :::提示[为何使用临时磁盘？]
  1MB 的临时磁盘强制 Unraid 将主磁盘分配为 `hda` (IDE) 而不是 `vda` (%%VirtIO|virtio%%)，这使 Windows 可以在没有 %%VirtIO|virtio%% 驱动程序的情况下启动。该临时磁盘将在驱动程序安装后移除。  :::
</details>

<details>
  <summary><strong>步骤 5：安装 VirtIO 驱动程序</strong> - 点击展开/折叠</summary>

  1. Start the VM from the **VMs** tab.
  2. Connect via %%VNC|vnc-session%% by clicking the VM icon and select **Start with console (VNC)**.
  3. During boot:
     - Windows will detect new hardware but might fail to install drivers.
     - Choose **Reboot later** when prompted.
  4. Open **Device Manager** (press Win+X and choose Device Manager):
     - Install drivers for each device listed under **Other devices** (like Ethernet Controller, PCI Device, etc.):
       1. Right-click the device and select **Update driver**.
       2. Choose **Browse my computer for drivers**.
       3. Point to the %%VirtIO|virtio%% ISO drive (for example, `D:\`).
       4. Check **Include subfolders**.
       5. If prompted, accept **Always trust Red Hat**.
  5. Install the %%QEMU|qemu%% %%guest agent|guest-agent%%:
     - Open File Explorer and navigate to `D:\guest-agent\`.
     - Double-click `qemu-ga-x64.msi`.
  6. Shut down the VM.
</details>

<details>
  <summary><strong>步骤 4：创建新 KVM 虚拟机</strong> - 点击展开/折叠</summary>

  1. Edit the VM:
     - Remove the temporary secondary %%vDisk|vdisk%% by clicking the red minus icon.
     - Confirm that the primary %%vDisk|vdisk%% points to your original %%Xen|xen-hvm%% disk.
  2. Update the VM:
     - Click **Update** to save your changes.
  3. Start the VM normally.
  4. Verify in **Device Manager** that:
     - No warning icons appear.
     - All devices utilize %%VirtIO|virtio%% drivers (for example, "Red Hat %%VirtIO|virtio%% Ethernet Adapter").
  5. (Optional) Enable %%VirtIO|virtio%% for better performance:
     - Edit the VM and switch to XML view.
     - Change the primary disk's `bus` from `ide` to `virtio`.
     - Click **Update** and reboot the VM.

  :::提示[为何使用临时磁盘？]
  1MB 的临时磁盘强制 Unraid 将主磁盘分配为 `hda` (IDE) 而不是 `vda` (%%VirtIO|virtio%%)，这使 Windows 可以在没有 %%VirtIO|virtio%% 驱动程序的情况下启动。该临时磁盘将在驱动程序安装后移除。  :::

  1. Reinstall the %%VirtIO|virtio%% drivers from the ISO.
  2. Check for Windows updates, which may provide newer drivers.
  3. 访问 [Red Hat VirtIO Drivers](https://docs.fedoraproject.org/en-US/quick-docs/creating-windows-virtual-machines-using-virtio-drivers/) 页面以获取最新版本。  :::
</details>
