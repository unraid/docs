# 版本 6.12.4 2023-08-31

## 升级说明

### 已知问题

请参阅 [6.12.0 发行说明](6.12.0.md#known-issues) 了解一般已知问题。

### 回滚

在回滚到早期版本之前，务必确保启用桥接：

- _**设置 > 网络设置 > eth0 > 启用桥接**_ = 是

然后启动阵列（连同 Docker 和 VM 服务一起）以更新您的 Docker 容器、虚拟机和 WireGuard 隧道，以便恢复到应在旧版本中可工作的先前设置。

进入旧版本后，确认这些设置对您的设置是正确的：

- _**设置 > Docker > 主机访问自定义网络**_
- _**设置 > Docker > Docker 自定义网络类型**_

若回滚至早于6.12.0版本，请参阅 [6.12.0 发行说明](6.12.0.md#rolling-back)。

## 修复 macvlan 调用跟踪

此次发布的重大消息是，我们已解决与 macvlan 调用跟踪和崩溃相关的问题！

问题的根源在于，当父接口是桥接（如 br0）时，macvlan 用于自定义 Docker 网络不可靠，最好在物理接口（如 eth0）或绑定接口（如 bond0）上使用。我们相信这是一个长期存在的内核问题，并已经发布了[错误报告](https://bugzilla.kernel.org/show_bug.cgi?id=217777)。

如果您遇到与 macvlan 相关的调用跟踪问题，作为第一步，我们建议您导航到_**设置 > Docker**_，切换到高级视图，并将“Docker 自定义网络类型”从 macvlan 更改为 ipvlan。这是 Unraid 自 6.11.5 版本以来的默认配置，应该适用于大多数系统。如果您对这个设置满意，那么您已经完成！您将不再有与 macvlan 相关的调用跟踪，可以跳到[下一节](#system-drivers-page)。

但是，一些用户报告称，在 ipvlan 模式下，某些路由器（Fritzbox）的端口转发和使用高级网络管理工具（Ubiquity）时功能受到限制。

对于这些用户，我们有一种新的方法，通过重新设置网络避免与 macvlan 相关的问题。调整一些设置，您的 Docker 容器，虚拟机和 WireGuard 通道应该会自动调整使用它们：

- _**设置 > 网络设置 > eth0 > 启用绑定**_ = 是或否，任何一种都可以
- _**设置 > 网络设置 > eth0 > 启用桥接**_ = 否（这将自动启用 macvlan）
- _**设置 > Docker > 主机访问自定义网络**_ = 已启用

注意：如果您之前使用过 [2-nic docker 分段方法](https://forums.unraid.net/topic/137048-guide-how-to-solve-macvlan-and-ipvlan-issues-with-containers-on-a-custom-network/)，您也将希望还原：

- _**设置 > Docker > 自定义网络在接口 eth0 或 bond0**_（即确保 eth0/bond0 为自定义网络配置，而不是 eth1/bond1）

当您启动阵列时，主机、虚拟机和 Docker 容器都将能够通信，并且不再有调用跟踪！

### 故障排除

- 如果您的Docker容器使用自定义IP地址无法启动，请编辑它们并将“网络类型”更改为“自定义：eth0”或“自定义：bond0”。我们尝试自动执行此操作，但根据自定义情况，您可能需要手动操作。
- 如果您的虚拟机有网络问题，请编辑它们并将网络源设置为“vhost0”。还要确保分配了 MAC 地址。
- 如果您的 WireGuard 隧道无法启动，请对每个隧道进行虚拟更改并保存。
- 如果您在对Docker容器进行端口转发时遇到问题（尤其是使用Fritzbox路由器），请在路由器中删除并重新创建端口转发。

### 了解更技术的内容…

升级到此版本后，如果在 eth0 上仍启用桥接，那么所有内容将如以前一样工作。您可以尝试通过禁用自定义 Docker 网络、使用 ipvlan 替代 macvlan 或使用 2-nic Docker 分段方法将容器放在 eth1 来解决调用跟踪问题。

从此版本开始，当您禁用 eth0 上的桥接时，我们会创建一个用于 Docker 容器和虚拟机的新 macvtap 网络。它的父级为 eth0 而非 br0，从而避免调用跟踪问题。

一个附带的好处是，据报 macvtap 网络比桥接网络更快，因此在与 Docker 容器和虚拟机通信时，您可能会看到速度提升。

请注意：禁用主接口（eth0）的桥接后，Docker 自定义网络类型将设置为 macvlan 并隐藏，除非您的系统上有其他启用了桥接的接口，在这种情况下，传统 ipvlan 选项是可用的。要使用此处讨论的新修复，您需要保持设置为 macvlan。

## 系统驱动程序页面

导航到 _**工具 > 系统驱动程序**_，以查看您系统上可用或正在使用的驱动程序。插件安装的第三方驱动程序（如 NVIDIA 和 Realtek）带有链接到该驱动程序支持页面的图标。您还可以添加/修改/删除任何驱动程序的 modeprobe.d 配置文件，而无需在您的闪存驱动器上找到该文件。

## 其他错误修复和改进

- 此版本解决了网络、Libvirt、Docker、WireGuard、NTP、NGINX、NFS和RPC的特殊情况，并改进了虚拟机管理器，使其在更新期间保留VNC密码。

- 关闭过程已修改，允许 NUT 插件正确关闭系统。

- 在自动关闭前，通知的显示时间现在是可配置的（请参见 _**设置 > 通知设置**_）。

- 一个小改动是，/boot/extra中的软件包现在被视为插件安装的软件包，且安装记录到syslog而不是控制台。

- 更新操作系统过程将自动更新插件更新助手脚本（如果需要）。

## 与 [6.12.3](6.12.3.md) 的变化

### 基本发行版

- create\_network\_ini:
  - 修复 dhcp 挂钩
  - 改进的 IP 地址收集
- 诊断：
  - 将以前的 Unraid 版本添加到诊断版本 txt 文件中。
  - 添加 ntp.conf、sshd.config 和 servers.conf（匿名化 URL）
  - 匿名化 IP 地址
- docker：
  - 当使用 shim 或 macvtap 网络时添加路由
  - 当“主机访问”已启用时修复路由
  - 从 shim/vhost 接口移除 IPv6（一些路由器不兼容）
- libvirt、nginx、nfs、rpc：更改正在运行的进程检测
- nfsclient：以 v4 开始协商，关闭 atime 修改
- rc.6：关闭期间保留 /usr 和 /lib 挂载
- rc.docker：
  - 为容器和服务创建相同的 IPv6 网络
  - 停止 dockerd 时添加更多记录
- rc.inet1：
  - 不使用桥接的混杂模式
  - 将持久选项添加到 dhcpcd
- rc.library：接口始终以相同顺序列出，修复 show ipv6
- rc.libvirt：如果存在，从 XML 中移除“itco”看门狗
- rc.local：注释自动生成的 /etc/modprobe.d/zfs.conf 文件
- rc.services：
  - 添加日志
  - 将 WireGuard "VPN 隧道访问 Docker" 隧道排除在服务之外
  - 将 WireGuard 隧道排除在 ntp 之外（代码优化）

#### 软件包更新

- btrfs-progs：6.3.3
- curl：版本 8.2.0（CVE-2023-32001）
- firefox：版本 117.0.r20230824132758（AppImage）
- kernel-firmware: 版本 20230724\_59fbffa
- krb5：版本 1.19.2（CVE-2023-36054）
- openssh：版本 9.3p2（CVE-2023-38408）
- openssl：版本 1.1.1v（CVE-2023-3817 CVE-2023-3446）
- samba：版本 4.17.10（CVE-2023-3496 CVE-2022-2127 CVE-2023-34968 CVE-2023-3496 CVE-2023-3347）

### Linux kernel

- 版本 6.1.49（CVE-2023-20593）
- CONFIG\_SCSI\_MPI3MR: Broadcom MPI3 存储控制器设备驱动程序

### WebGUI

- 仪表板：当不使用 ZFS 时隐藏 ZFS 条
- Docker 设置：修复子网大小
- 反馈：重构反馈脚本
- 网络设置：修复 DNS 设置有时消失
- 通知：新增通知选项：自动关闭时间，默认是5秒
- 池：最小空闲空间：仅当阵列停止时启用
- 共享和池：显示“最小可用空间”为绝对数字而不是百分比
- 系统驱动程序：新页面
- 翻译：修剪语言文件中的键和值
- 虚拟机管理器：在更新期间保留 VNC 密码。
- 虚拟机管理器：移除已下载的 '.vv' 文件。
- CSS：设置overflow-x为“auto”
- 更新 monitor\_nchan

## 补丁

安装 [Unraid Patch 插件](https://forums.unraid.net/topic/185560-unraid-patch-plugin/) 后，访问 _**工具 → Unraid Patch**_ 获取以下补丁/紧急修复：

- 一部分安全更新，详情请参阅 [这篇博客文章](https://unraid.net/blog/cvd)。我们建议升级到最新稳定版本以获取其他安全更新。
