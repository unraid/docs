---
sidebar_position: 2
sidebar_label: Unclean shutdowns
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import UncleanShutdownsPower from './partials/unclean-shutdowns/unexpected-power-loss.mdx';
import UncleanShutdownsFlash from './partials/unclean-shutdowns/flash-drive-failure.mdx';
import UncleanShutdownsTerminal from './partials/unclean-shutdowns/open-terminal-sessions.mdx';

# Unclean shutdowns

An unclean shutdown happens when Unraid detects that the %%array|array%% was not properly stopped before the system powered off. This situation can trigger an automatic %%parity check|parity-check%% during the next boot to ensure data integrity.

:::important[Recommendations to prevent unclean shutdowns]

- **Use a UPS:** Keep your server connected to an Uninterruptible Power Supply (UPS) and set it up to initiate a controlled shutdown when battery power runs low.
- **Attempt a graceful shutdown:** If your server is unresponsive, briefly press the power button to trigger a safe shutdown. Do not hold the button down, as this will force a hard power off and lead to an unclean shutdown.
- **Enable persistent logging:** Go to ***Settings → Syslog Server*** to activate logging that persists after a reboot. See [Persistent logs (Syslog server)](../diagnostics/capture-diagnostics-and-logs.mdx#persistent-logs-syslog-server) for more details.
- **附加诊断以获取支持：** 如果发生未经清理的关机，Unraid 将尝试将诊断保存到您的闪存设备的 `/log/diagnostics.zip`。在您寻求帮助的论坛帖子中附加此文件。

:::tip[UPS configuration best practices]

- **Connect the UPS via USB** to your Unraid server.
- **Enable UPS support** in ***Settings → UPS Settings***.
- **Configure shutdown timeouts:** Set the UPS to trigger a controlled shutdown before the battery runs low. Adjust the "Battery runtime left" or "Battery charge level" thresholds to provide enough time for Unraid to [stop the %%array|array%%](../../using-unraid-to/manage-storage/array-configuration.mdx#startstop-the-array) and power down safely.
- **Test your configuration:** Simulate a power loss to ensure the UPS and Unraid respond correctly.

查看[NUT插件](https://unraid.net/community/apps/c/plugins/p4?srsltid=AfmBOop675PrJQW4iqb4JBN3GyPpwDDiSmnZReq78t27XyxkFdMX8inO#:~:text=NUT%20%2D%20Network%20UPS%20Tools)，以便能够更广泛地兼容更多高级的UPS型号或不支持的硬件。
:::

## Events That Cause Unclean Shutdowns

Understanding the main triggers for unclean shutdowns helps you prevent them. Explore the tabs below for details on each scenario.

<Tabs>
  <TabItem value="电源" label="“意外的电源损失”" default>
    <UncleanShutdownsPower />
  </TabItem>

  <TabItem value="闪存" label="“闪存驱动器故障”">
    <UncleanShutdownsFlash />
  </TabItem>

  <TabItem value="terminal" label="打开终端会话">
    <UncleanShutdownsTerminal />
  </TabItem>
</Tabs>

---

## Configuring shutdown timeouts

Properly configuring shutdown timeouts is essential to ensure your Unraid server can stop all services effectively, preventing unclean shutdowns, particularly during power loss or maintenance. Each component of your system - %%VM|vm%%s, Docker containers, and the overall %%array|array%% - has its own timeout setting that can be adjusted.

### Recommended timeout settings

| 设置                            | Default | 推荐最小值                                            | 配置位置                                                 |
| ----------------------------- | ------- | ------------------------------------------------ | ---------------------------------------------------- |
| %%VM\|vm%% 关机超时               | 60秒     | 300秒（5 分钟）                                       | ***Settings → VM Manager → VM Shutdown (Advanced)*** |
| Docker container stop timeout | 10秒     | 30–60秒                                           | ***设置 → Docker（高级）***                                |
| 通用关机超时时间                      | 90秒     | 3 × %%VM\|vm%% timeout + Docker timeout + 15–30s | ***Settings → Disk Settings → Shutdown time-out***   |

### Virtual machines timeout

<details>
  <summary><strong>点击展开/折叠</strong></summary>

  在停止 Docker 容器或 %%array|array%% 自身之前，Unraid 首先关闭所有配置的虚拟机 (%%VMs|vm%%)。 虚拟机关闭超时决定了 Unraid 等待每个 %%VM|vm%% 优雅关闭的时间。

  <h4>设置位置</h4>

  - ***Settings → VM Manager → VM Shutdown*** (enable Advanced view)

  <h4>考虑</h4>

  - Windows %%VMs|vm%% may take longer to shut down, especially if updates are pending or the %%VM|vm%% is in sleep/hibernation.
  - If the timeout is too short, %%VMs|vm%% will be force-stopped, risking data loss or corruption.

  <h4>最佳做法</h4>

  将超时设置为至少 300 秒（5 分钟），用于 Windows %%VMs|vm%%。计划更新在启动时运行，而不是在关闭时运行，以避免延迟。
</details>

### Docker containers timeout

<details>
  <summary><strong>点击展开/折叠</strong></summary>

  在虚拟机之后，Unraid 停止所有正在运行的 Docker 容器。容器停止超时控制 Unraid 等待每个容器干净退出的时间。

  <h4>设置位置</h4>

  - ***Settings → Docker*** (enable Advanced view)

  <h4>考虑</h4>

  - Containers are stopped in parallel.
  - Complex containers, or those with large databases, may need more than the default 10 seconds to shut down safely.
  - If the timer expires, containers are force-stopped.

  <h4>最佳做法</h4>
  如果运行需要额外关闭时间的 Docker 容器，请将超时增加到 30–60 秒。
</details>

### General shutdown timer

<details>
  <summary><strong>点击展开/折叠</strong></summary>

  The overall Shutdown time-out is the maximum time Unraid allows for all shutdown processes - %%VM|vm%%s, Docker, and disk operations - before forcing a shutdown.

  <h4>设置位置</h4>

  - ***Settings → Disk Settings → Shutdown time-out***

  <h4>如何计算</h4>

  加上 %%虚拟机|vm%% 和 Docker 超时时间，然后加上 15–30 秒用于磁盘卸载和其他进程。

  - Example: `3 × ***VM Shutdown timeout*** + ***Docker stop timeout*** + 15–30 seconds`

  <h4>最佳实践</h4>
  设置这个计时器高于您最慢的关机场景，尤其当您有许多驱动器或大型 %%array|array%% 时。
</details>

### UPS battery life

<details>
  <summary><strong>点击展开/折叠</strong></summary>

  您的 UPS 必须提供足够的运行时间，以允许所有关闭计时器在服务器失去电力前到期。

  <h4>设置位置</h4>

  - ***Settings → UPS Settings*** (see **Runtime left** with all disks spun up)

  <h4>考虑</h4>

  - The UPS should trigger a shutdown early enough to allow the full shutdown sequence to complete.
  - If the battery runs out before shutdown completes, you risk an unclean shutdown and possible data loss.

  <h4>最佳做法</h4>

  通过模拟断电来测试您的 UPS，并确认 Unraid 可以在时间充裕的情况下干净关闭。
</details>
