---
sidebar_position: 2
sidebar_label: 非正常关机
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import UncleanShutdownsPower from "./partials/unclean-shutdowns/unexpected-power-loss.mdx";
import UncleanShutdownsFlash from "./partials/unclean-shutdowns/flash-drive-failure.mdx";
import UncleanShutdownsTerminal from "./partials/unclean-shutdowns/open-terminal-sessions.mdx";

# 非正常关机

当 Unraid 检测到 %%array|array%% 没有在系统断电前正确停止时，就会出现不干净关机。这种情况可能会在下次启动时触发自动 %%parity check|parity-check%% 以确保数据完整性。

:::important[Recommendations 防止不洁的关闭]

采取一些主动的步骤可以帮助你避免或识别非正常关机：

- \*\*使用不间断电源（UPS）：\*\*确保服务器连接到UPS并设置在电池电量不足时自动关闭。
- \*\*尝试优雅关闭：\*\*如果您的服务器无响应，短按电源按钮以触发安全关闭。不要长按该按钮，因为这将强制硬关机并导致不洁关机。
- **启用持久性日志：**前往***设置 → Syslog 服务器***以激活在重启后持续的日志。详见[持久日志 (Syslog 服务器)](../diagnostics/capture-diagnostics-and-logs.mdx#persistent-logs-syslog-server)。
- **附加诊断信息以获得支持：** 如果发生非正常关机，Unraid 将尝试将诊断信息保存到您的闪存设备的 `/log/diagnostics.zip` 中。当您寻求帮助时，请将此文件附加到论坛帖子中。

:::

:::tip[UPS 配置最佳实践]

配置良好的 UPS 是防止因掉电导致非正常关机的最佳防卫。

- **通过 USB 连接 UPS 到 Unraid 服务器。**
- 在***设置→ UPS 设置***中**启用 UPS 支持**。
- \*\*配置关机超时时间：\*\*设置UPS以便在电池电量不足之前触发受控关机。调整“剩余电池运行时间”或“电池充电电平”阈值，以提供足够的时间让Unraid [停止%%array|array%%](../../using-unraid-to/manage-storage/array-configuration.mdx#startstop-the-array) 并安全关机。
- **测试配置：** 模拟掉电以确保 UPS 和 Unraid 的正确反应。

了解 [NUT 插件](https://unraid.net/community/apps/c/plugins/p4?srsltid=AfmBOop675PrJQW4iqb4JBN3GyPpwDDiSmnZReq78t27XyxkFdMX8inO#:~:text=NUT%20%2D%20Network%20UPS%20Tools)，它可以更广泛地兼容更多高级 UPS 型号或未支持的硬件。

:::

## 配置关机超时

Properly configuring shutdown timeouts is essential to ensure your Unraid server can stop all services effectively, preventing unclean shutdowns, particularly during power loss or maintenance. Each component of your system - %%VM|vm%%s, Docker containers, and the overall %%array|array%% - has its own timeout setting that can be adjusted.

<Tabs>
  <TabItem value="电源" label="“意外的电源损失”" default>
    <UncleanShutdownsPower />
  </TabItem>

  <TabItem value="闪存" label="“闪存驱动器故障”">
    <UncleanShutdownsFlash />
  </TabItem>

  <TabItem value="终端" label="打开终端会话">
    <UncleanShutdownsTerminal />
  </TabItem>
</Tabs>

---

## 虚拟机超时时间

正确配置停机超时时间对于确保您的 Unraid 服务器能有效地停止所有服务至关重要。这能防止不干净的关机，特别是在断电或者维护期间。最重要的步骤是配置你的虚拟机(%%VMs|vm%%)进入休眠状态，而不是完全关机。这种方式有助于消除许多与超时相关的问题。

### 虚拟机休眠设置

:::tip[Use 虚拟机休眠]

为了获得最可靠和最快速的关机，配置你的虚拟机(%%VMs|vm%%)进入休眠状态而不是关机。虽然这对 Windows 虚拟机(%%VMs|vm%%)尤为重要，但对所有类型的虚拟机(%%VM|vm%%)都有好处。

我们建议使用休眠，因为它：

- **即时保存虚拟机状态** - 无需等待客户操作系统关闭。
- **防止数据丢失** - 无需担心更新被中断或未保存的工作丢失风险。
- **避免超时问题** - 休眠几乎是即时完成的。
- **更快的恢复** - 虚拟机(%%VMs|vm%%)能准确的恢复到上次关闭时的状态。

关机存在的问题在于：

- Windows 可能会显示对话框（"是否保存此文档？"），这会导致关机被无限期中止。
- Windows 更新可能会在关机过程中耗时 10 分钟以上。
- 如果超时过期，Unraid 会强制关闭 %%VM|vm%%，这可能导致正在进行的 Windows 更新被破坏，未保存的文档、应用程序数据和客户端操作系统中的文件系统遭到破坏。

\*\*关键要求：\*\*确保在 %%VM|vm%% 中安装了 %%QEMU|qemu%% %%Guest Agent|guest-agent%% 以使休眠功能正常运行。

:::

要启用虚拟机(%%VM|vm%%)休眠：

<Tabs>
  <TabItem value="windows" label="Windows 虚拟机" default>
    1. **下载 %%QEMU|qemu%% %%Guest Agent|guest-agent%%：**
       - 前往 [VirtIO 驱动程序下载页面](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/)。
       - 下载最新的 `virtio-win.iso` 文件。

    2. **在 Windows 虚拟机(%%VM|vm%%)中安装：**
       - 将 `virtio-win.iso` 挂载到您的 %%VM|vm%%。
       - 从挂载的 ISO 中运行安装程序。
       - 安装 %%VirtIO|virtio%% 驱动程序和 %%QEMU|qemu%% %%Guest Agent|guest-agent%%。
       - 重启虚拟机(%%VM|vm%%)。

    3. **在 Unraid 中配置：**
       - 前往 ***虚拟机*** タブ中的您的虚拟机(%%VM|vm%%)设置。
       - 将 **关机动作** 设置为 **休眠**。
       - 点击 **应用**。
  </TabItem>

  <TabItem value="linux" label="Linux 虚拟机">
    1. **安装 %%QEMU|qemu%% %%Guest Agent|guest-agent%%：**

    ```bash
    # Ubuntu/Debian
    sudo apt install qemu-guest-agent

    # CentOS/RHEL/Fedora
    sudo yum install qemu-guest-agent
    # or
    sudo dnf install qemu-guest-agent
    ```

    2. **启用服务：**
       ```bash
       sudo systemctl enable qemu-guest-agent
       sudo systemctl start qemu-guest-agent
       ```

    3. **在 Unraid 中配置：**
       - 在您的虚拟机(%%VM|vm%%)设置中将 **关机动作** 设置为 **休眠**。
  </TabItem>

  <TabItem value="设备" label="设备虚拟机">
    一些虚拟机(%%VMs|vm%%)，如 Home Assistant，不允许安装额外的软件。对此类虚拟机：

    - 保持 **关机动作** 设定为 **关机**。
    - 使用较长的超时值 (请参见下文的超时建议)。
    - 考虑在更新期间强制关闭这些虚拟机(%%VMs|vm%%)的风险。

    :::note[为何设备虚拟机不同]

    设备虚拟机(%%VMs|vm%%)专为运行特定软件而设计，通常不允许安装额外的软件包，比如 %%QEMU|qemu%% %%Guest Agent|guest-agent%%。这意味着休眠不可用，因此您需要依赖适当的超时配置。

    :::
  </TabItem>
</Tabs>

现在验证您的休眠功能，启动您的虚拟机(%%VM|vm%%)并打开一些应用程序。然后从 Unraid 停止它。当您再次启动它时，它应该恢复到应用程序仍然打开的状态。

:::warning[Guest 代理是关键]

没有安装 %%QEMU|qemu%% %%Guest Agent|guest-agent%% 时，休眠可能无法正常工作。在这种情况下，虚拟机(%%VM|vm%%)将退回到关机模式，耗尽整个超时时间。

:::

### 超时配置

在本节中，我们将介绍如何为不同的系统和过程配置超时信息。这对确保您的虚拟机(%%VMs|vm%%)和 Docker 容器能平滑关闭且无数据丢失至关重要。

| 设置              | 默认值 | 何时增加                            | 配置位置                           |
| --------------- | --- | ------------------------------- | ------------------------------ |
| %%VM\|vm%% 关机超时 | 60秒 | 如果没有使用休眠且虚拟机崩溃则设置为 300s         | ***设置 → 虚拟机管理器 → 虚拟机关机 (高级)*** |
| Docker 容器停止超时时间 | 10秒 | 如果任何容器在停止时崩溃则设置为 30s            | ***设置 → Docker (高级)***         |
| 通用关机超时时间        | 90秒 | 如果出现不干净关机，设置为 180s，与虚拟机一起 300s+ | ***设置 → 磁盘设置 → 关机超时***         |

:::tip[When 增加超时]

如果您遇到不干净关机或容器在关机时崩溃，可以考虑将一般关机超时增加至 **180 秒**（或如果有多个虚拟机则增加至 **300+ 秒**）。这给服务更多时间平滑关闭。
:::

### 停机顺序

关机时，过程按以下顺序发生：

1. **虚拟机(%%VM|vm%%)关闭：** 这涉及三个阶段，每个阶段可耗尽虚拟机关闭超时：

   - 阶段 1：恢复任何暂停的虚拟机(%%VMs|vm%%)
   - 阶段 2：让配置为休眠状态的虚拟机(%%VMs|vm%%)进入休眠
   - 阶段 3：关闭任何剩余的虚拟机(%%VMs|vm%%)

   每个阶段中的所有虚拟机(%%VMs|vm%%)同时进行处理，这意味着总关闭时间可以计算为：虚拟机关闭超时 × 3。

2. **Docker 容器停止：** 所有容器将同时停止（总时间 = Docker 停止超时）。

3. **其他服务：** 这包括 LXC 容器和第三方插件的任务，通常只需几秒钟内完成。

4. **阵列关闭：** 驱动器需要卸载和数据同步；这通常需要 15-30 秒。

:::tip[Calculate 您的总体关机超时]

**公式：** 您的总体关机超时值应大于：

```
(VM timeout × 3) + (Docker timeout) + (Other services) + 15-30 seconds
```

**示例：** 如果我们按照公式进行，结果如下：`(300 × 3) + 30 + 10 + 30 = 970 秒（超过 16 分钟）`。

**建议：** 至少 **180 秒（3 分钟）** 至少，若您有多个虚拟机(%%VMs|vm%%)或复杂的容器则设置为 **300+ 秒（5+ 分钟）**。

:::

若您的地址虚拟机(%%VMs|vm%%)设置为休眠而不是关机，那么虚拟机超时就不显得那么重要，因为休眠状态几乎是即时的。您可以使用较短的虚拟机超时（例如60-120 秒）作为不支持休眠的虚拟机(%%VMs|vm%%)的备份。

### 详细配置指南

本节提供有关不同系统组件的超时配置的深入信息。每个超时设置共同作用以确保您的服务器能平滑关闭且无数据丢失。

<Tabs>
  <TabItem value="虚拟机超时" label="虚拟机关闭超时" default>
    设置位置： ***设置 → 虚拟机管理器 → 虚拟机关机*** (启用高级视图)

    **原理:**

    - 虚拟机(%%VMs|vm%%)经过三个关闭阶段，每个阶段耗尽虚拟机关闭超时
    - 每个阶段中的所有虚拟机(%%VMs|vm%%)同时进行处理
    - 总虚拟机关闭时间 = 虚拟机关闭超时 × 3

    **常见问题：**

    - **Windows 更新中断：** 关机时的更新可能会在超时截止后损坏。
    - **未保存的工作：** 提示用户是否保存文档的对话框可能会导致关机无期限中止。
    - **休眠失败：** 在没有 %%QEMU|qemu%% %%Guest Agent|guest-agent%% 的情况下，虚拟机(%%VMs|vm%%)可能无法休眠并使用完整的超时时间。

    :::tip[虚拟机超时建议]

    - **主要建议：** 配置你的虚拟机(%%VMs|vm%%)为休眠状态而不是关机（需要 %%QEMU|qemu%% %%Guest Agent|guest-agent%%）。
    - **如果虚拟机在关机时崩溃：** 增加超时至 **300 秒（5 分钟）** 针对 Windows 虚拟机(%%VMs|vm%%)。
    - **Windows 更新：** 设定 Windows 在启动时执行更新而不是在关机时。
    - **测试你的设置：** 手动停止您的虚拟机(%%VMs|vm%%)，以确认它们在超时内关闭或休眠。
      :::

    :::warning[没有休眠则无安全超时] 无休眠和 %%QEMU|qemu%% %%Guest Agent|guest-agent%% 的情况，没有真正安全的超时设置供 Windows 虚拟机(%%VMs|vm%%)使用。 对话框或正在进行中的更新安装可能会使任何超时均不足，导致被强制关机并有数据损坏风险。
    :::
  </TabItem>

  <TabItem value="Docker 超时" label="Docker 关机超时">
    设置位置： ***设置 → Docker*** (启用高级视图)

    **原理:**

    - 容器并行停止，因此总时间等于 Docker 停止超时。
    - 大多数容器能在 10 秒内停止，但有些可能需要更长的时间。
    - 拥有大型数据库或正在进行业务操作的复杂容器可能需要额外时间。
    - 如果定时器到期，容器将被强制停止。

    :::tip[Docker 超时建议]

    - **默认 10 秒** 对大多数容器都是足够的。
    - **如果容器在停止时崩溃：** 增加超时至 **30 秒**。
    - 在关机期间监控您的容器，来确定哪些容器经常需要更多时间。
      :::
  </TabItem>

  <TabItem value="通用超时" label="通用关机超时">
    设置位置： ***设置 → 磁盘设置 → 关机超时***

    **UPS 的考虑（最关键因素）：**

    - 您的 UPS 必须提供足够的运行时间以完成完整的关机顺序才能在电池耗尽之前完成。
    - 对于 **手动关机**，您可以设置更长的超时时间，因为您可以控制何时开始关机。
    - 使用 **断电关机**，您的超时受制于 UPS 电池寿命。
    - **测试您的 UPS** 通过模拟停电以确保您的服务器能在电力耗尽前能顺利关机。

    :::tip[通用超时建议]

    - **如果您遇到不干净的关机：** 对于没有虚拟机(%%VMs|vm%%)的系统则增加至 **180 秒（3 分钟）**。
    - **对于使用虚拟机的系统：** 如果不使用休眠则增加至 **300+ 秒（5+ 分钟）**。
    - **如果使用休眠：** **180-300 秒** 通常是足够的。
    - 确保超时不会长过您的 UPS 能在停电期间支持的时间。
      :::
  </TabItem>

  <TabItem value="第三方" label="第三方服务">
    **LXC 容器：** LXC 插件有自己容器停止的超时设置。与 Docker 容器类似，LXC 容器通常停止在几秒之内，但某些可能需要更长的时间。检查 LXC 插件设置中的容器 stop 超时并包含它于您的总体关机超时计算中。

    **其他服务：** 某些插件或自定义服务可能有他们自身的关机程序。参考插件文档以获取特定的超时设置并将它们纳入您的计算。

    **更新的公式与第三方服务：**

    ```
    (VM timeout × 3) + (Docker timeout) + (LXC/other timeouts) + 15-30 seconds
    ```

    **Dynamix 停止 Shell 插件：** 如果您经常使用 SSH 或终端会话，打开的会话可能会防止干净的关机，因为 Unraid 会等它们关闭后再进行。

    [Dynamix 停止 Shell](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository) 插件通过在停止阵列时自动关闭拖延的 bash 或 SSH 会话来帮助确保及时关机。

    您可以从 [社区应用程序（搜索 "Dynamix 停止 Shell"）](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository) 安装插件。

    :::tip[何时使用插件]

    - 如果您经常有终端会话打开。
    - 为了防止遗忘的 SSH 会话拖延关机。
    - 在关机期间自动清理。
      :::

    :::注意

    - 当心如果在终端会话中有脚本或进程运行。
    - 确保在关机前没有关键的写入操作正在进行中。
    - 插件将强制关闭会话，这可能会中断工作。
      :::
  </TabItem>
</Tabs>
