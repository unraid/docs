---
sidebar_position: 2
sidebar_label: 非正常关机
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import UncleanShutdownsPower from './partials/unclean-shutdowns/unexpected-power-loss.mdx';
import UncleanShutdownsFlash from './partials/unclean-shutdowns/flash-drive-failure.mdx';
import UncleanShutdownsTerminal from './partials/unclean-shutdowns/open-terminal-sessions.mdx';

# 非正常关机

当 Unraid 检测到 %%array|array%% 没有在系统断电前正确停止时，就会出现不干净关机。这种情况可能会在下次启动时触发自动 %%parity check|parity-check%% 以确保数据完整性。

:::important[Recommendations 防止不洁的关闭]

采取一些主动的步骤可以帮助你避免或识别非正常关机：

- \*\*使用不间断电源（UPS）：\*\*确保服务器连接到UPS并设置在电池电量不足时自动关闭。
- \*\*尝试优雅关闭：\*\*如果您的服务器无响应，短按电源按钮以触发安全关闭。不要长按该按钮，因为这将强制硬关机并导致不洁关机。
- **启用持久日志记录：**前往***设置 → 系统日志服务器***以激活在重新启动后持久存在的日志记录。详细信息请参阅[持久日志 (系统日志服务器)](../diagnostics/capture-diagnostics-and-logs.mdx#persistent-logs-syslog-server)。
- **附加诊断信息以获得支持：** 如果发生非正常关机，Unraid 将尝试将诊断信息保存到您的闪存设备的 `/log/diagnostics.zip` 中。当您寻求帮助时，请将此文件附加到论坛帖子中。

:::

:::tip[UPS 配置最佳实践]

配置良好的 UPS 是防止因掉电导致非正常关机的最佳防卫。

- **通过 USB 连接 UPS 到 Unraid 服务器。**
- **在设置中启用 UPS 支持。**
- \*\*配置关机超时时间：\*\*设置UPS以便在电池电量不足之前触发受控关机。调整“剩余电池运行时间”或“电池充电电平”阈值，以提供足够的时间让Unraid [停止%%array|array%%](../../using-unraid-to/manage-storage/array-configuration.mdx#startstop-the-array) 并安全关机。
- **测试配置：** 模拟掉电以确保 UPS 和 Unraid 的正确反应。

了解 [NUT 插件](https://unraid.net/community/apps/c/plugins/p4?srsltid=AfmBOop675PrJQW4iqb4JBN3GyPpwDDiSmnZReq78t27XyxkFdMX8inO#:~:text=NUT%20%2D%20Network%20UPS%20Tools)，它可以更广泛地兼容更多高级 UPS 型号或未支持的硬件。

:::

## 配置关机超时

Properly configuring shutdown timeouts is essential to ensure your Unraid server can stop all services effectively, preventing unclean shutdowns, particularly during power loss or maintenance. Each component of your system - %%VM|vm%%s, Docker containers, and the overall %%array|array%% - has its own timeout setting that can be adjusted.

<Tabs>
  <TabItem value="电源" label="“意外的电源损失”" default>
    <UncleanShutdownsPower />
  </TabItem>

  <TabItem value="闪存" label="“闪存驱动器故障”">
    <UncleanShutdownsFlash />
  </TabItem>

  <TabItem value="终端" label="打开终端会话">
    <UncleanShutdownsTerminal />
  </TabItem>
</Tabs>

---

## 虚拟机超时时间

Properly configuring shutdown timeouts is essential to ensure your Unraid server can stop all services effectively, preventing unclean shutdowns, particularly during power loss or maintenance. Each component of your system - %%VM|vm%%s, Docker containers, and the overall %%array|array%% - has its own timeout setting that can be adjusted.

### “Docker 容器超时时间”

| 设置              | 默认值 | 推荐最小值                                  | 配置位置                         |
| --------------- | --- | -------------------------------------- | ---------------------------- |
| %%VM\|vm%% 关机超时 | 60秒 | 300秒（5 分钟）                             | ***设置 → 虚拟机管理 → 虚拟机关机（高级）*** |
| Docker 容器停止超时时间 | 10秒 | 30–60秒                                 | ***设置 → Docker（高级）***        |
| 通用关机超时时间        | 90秒 | 3 × %%VM\|vm%% 超时 + Docker 超时 + 15–30秒 | ***设置 → 磁盘设置 → 关机超时***       |

### 通用关机计时器

<details>
  <summary><strong>点击展开/折叠</strong></summary>

  在停止 Docker 容器或 %%array|array%% 自身之前，Unraid 首先关闭所有配置的虚拟机 (%%VMs|vm%%)。 虚拟机关闭超时决定了 Unraid 等待每个 %%VM|vm%% 优雅关闭的时间。

  <h4>设置位置</h4>

  - ***设置 → 磁盘设置 → 关机超时***

  <h4>考虑</h4>

  - Windows %%虚拟机|vm%% 可能需要更长时间关机，尤其是如果更新待处理或虚拟机处于睡眠/休眠中。
  - 如果超时时间过短，%%虚拟机|vm%% 将被强制停止，有可能导致数据丢失或损坏。

  <h4>最佳做法</h4>

  将超时设置为至少 300 秒（5 分钟），用于 Windows %%VMs|vm%%。计划更新在启动时运行，而不是在关闭时运行，以避免延迟。
</details>

### UPS电池寿命

<details>
  <summary><strong>点击展开/折叠</strong></summary>

  在虚拟机之后，Unraid 停止所有正在运行的 Docker 容器。容器停止超时控制 Unraid 等待每个容器干净退出的时间。

  <h4>设置位置</h4>

  - ***设置 → UPS 设置*** （查看 **剩余运行时间**，所有磁盘旋转起来）

  <h4>考虑</h4>

  - UPS 应该在关机序列完成前触发关闭。
  - 如果电池在关闭完成之前耗尽，您将面临不完全关闭和可能的数据丢失的风险。
  - 如果定时器到期，容器将被强制停止。

  <h4>最佳做法</h4>
</details>

### 通用关机计时器

<details>
  <summary><strong>点击展开/折叠</strong></summary>

  The overall Shutdown time-out is the maximum time Unraid allows for all shutdown processes - %%VM|vm%%s, Docker, and disk operations - before forcing a shutdown.

  <h4>设置位置</h4>

  - ***设置 → 磁盘设置 → 关机超时***

  <h4>如何计算</h4>

  加上 %%虚拟机|vm%% 和 Docker 超时时间，然后加上 15–30 秒用于磁盘卸载和其他进程。

  - 示例：`3 × ***虚拟机关机超时*** + ***Docker 停止超时*** + 15–30 秒`

  <h4>最佳实践</h4>
  设置这个计时器高于您最慢的关机场景，尤其当您有许多驱动器或大型 %%array|array%% 时。
</details>

### UPS电池寿命

<details>
  <summary><strong>点击展开/折叠</strong></summary>

  您的 UPS 必须提供足够的运行时间，以允许所有关闭计时器在服务器失去电力前到期。

  <h4>设置位置</h4>

  - ***设置 → UPS 设置*** （查看 **剩余运行时间**，所有磁盘旋转起来）

  <h4>考虑</h4>

  - UPS 应该在关机序列完成前触发关闭。
  - 如果电池在关闭完成之前耗尽，您将面临不完全关闭和可能的数据丢失的风险。

  <h4>最佳做法</h4>

  通过模拟断电来测试您的 UPS，并确认 Unraid 可以在时间充裕的情况下干净关闭。
</details>
