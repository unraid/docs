---
sidebar_position: 2
sidebar_label: 非正常关机
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# 非正常关机

当 Unraid 检测到 %%array|array%% 没有在系统断电前正确停止时，就会出现不干净关机。这种情况可能会在下次启动时触发自动 %%parity check|parity-check%% 以确保数据完整性。

:::important[Recommendations 防止不洁的关闭]

采取一些主动的步骤可以帮助你避免或识别非正常关机：

- \*\*使用不间断电源（UPS）：\*\*确保服务器连接到UPS并设置在电池电量不足时自动关闭。
- \*\*尝试优雅关闭：\*\*如果您的服务器无响应，短按电源按钮以触发安全关闭。不要长按该按钮，因为这将强制硬关机并导致不洁关机。
- **启用持久日志记录：** 前往 ***设置 → Syslog 服务器*** 以激活在重启后仍然存在的日志记录。查看 [持久日志 (Syslog 服务器)](../diagnostics/capture-diagnostics-and-logs.mdx#persistent-logs-syslog-server) 以了解更多详情。
- **附加诊断信息以获得支持：** 如果发生非正常关机，Unraid 将尝试将诊断信息保存到您的闪存设备的 `/log/diagnostics.zip` 中。当您寻求帮助时，请将此文件附加到论坛帖子中。

:::

:::tip[UPS 配置最佳实践]

配置良好的 UPS 是防止因掉电导致非正常关机的最佳防卫。

- **通过 USB 连接 UPS 到 Unraid 服务器。**
- **在设置中启用 UPS 支持。**
- **Configure shutdown timeouts:** Set the UPS to trigger a controlled shutdown before the battery runs low. Adjust the "Battery runtime left" or "Battery charge level" thresholds to provide enough time for Unraid to [stop the %%array|array%%](../../using-unraid-to/manage-storage/array/overview.mdx#startstop-the-array) and power down safely.
- **测试配置：** 模拟掉电以确保 UPS 和 Unraid 的正确反应。

了解 [NUT 插件](https://unraid.net/community/apps/c/plugins/p4?srsltid=AfmBOop675PrJQW4iqb4JBN3GyPpwDDiSmnZReq78t27XyxkFdMX8inO#:~:text=NUT%20%2D%20Network%20UPS%20Tools)，它可以更广泛地兼容更多高级 UPS 型号或未支持的硬件。

:::

## Events that cause unclean shutdowns

Understanding the main triggers for unclean shutdowns helps you prevent them. The following sections cover the most common scenarios and their solutions.

### “意外的电源损失”

Power interruptions are one of the main reasons for unclean shutdowns. Protect your system with a properly configured UPS that can automatically shut down Unraid before the battery runs out.

:::note

Unraid 支持大多数使用 %%apcupsd 协议|apcupsd%% 协议的 UPS 单元（APC 和 CyberPower 通常兼容）。如果您的 UPS 不受支持，建议使用来自社区应用程序的网络 UPS 工具（NUT）插件。

:::

### “闪存驱动器故障”

"%%array|array%% 状态存储在您的 USB 闪存设备上。如果闪存不可用或进入只读状态，Unraid 无法更新关机状态，即使 %%array|array%% 正确停止。这会导致在下次启动时检测出不干净关机。"

### 打开终端会话

Unraid waits for all open terminal or SSH sessions to close during shutdown. If these sessions remain active and the shutdown timer expires, a forced shutdown occurs.

:::tip

The [Dynamix Stop Shell](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository) plugin can automatically close lingering bash or SSH sessions, helping ensure a graceful shutdown. However, be cautious if there are ongoing write operations to the %%array|array%%.

:::

---

## 虚拟机超时时间

正确配置停机超时时间对于确保您的 Unraid 服务器能有效地停止所有服务至关重要。这能防止不干净的关机，特别是在断电或者维护期间。最重要的步骤是配置你的虚拟机(%%VMs|vm%%)进入休眠状态，而不是完全关机。这种方式有助于消除许多与超时相关的问题。

### 虚拟机休眠设置

:::tip[Use 虚拟机休眠]

为了获得最可靠和最快速的关机，配置你的虚拟机(%%VMs|vm%%)进入休眠状态而不是关机。虽然这对 Windows 虚拟机(%%VMs|vm%%)尤为重要，但对所有类型的虚拟机(%%VM|vm%%)都有好处。

我们建议使用休眠，因为它：

- **即时保存虚拟机状态** - 无需等待客户操作系统关闭。
- **防止数据丢失** - 无需担心更新被中断或未保存的工作丢失风险。
- **避免超时问题** - 休眠几乎是即时完成的。
- **更快的恢复** - 虚拟机(%%VMs|vm%%)能准确的恢复到上次关闭时的状态。

关机存在的问题在于：

- Windows 可能会显示对话框（"是否保存此文档？"），这会导致关机被无限期中止。
- Windows 更新可能会在关机过程中耗时 10 分钟以上。
- 如果超时过期，Unraid 会强制关闭 %%VM|vm%%，这可能导致正在进行的 Windows 更新被破坏，未保存的文档、应用程序数据和客户端操作系统中的文件系统遭到破坏。

\*\*关键要求：\*\*确保在 %%VM|vm%% 中安装了 %%QEMU|qemu%% %%Guest Agent|guest-agent%% 以使休眠功能正常运行。

:::

要启用虚拟机(%%VM|vm%%)休眠：

<Tabs>
  <TabItem value="windows" label="Windows 虚拟机" default>
    1. **下载 %%QEMU|qemu%% %%Guest Agent|guest-agent%%：**
       - 前往 [VirtIO 驱动程序下载页面](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/)。
       - 下载最新的 `virtio-win.iso` 文件。

    2. **在 Windows 虚拟机(%%VM|vm%%)中安装：**
       - 将 `virtio-win.iso` 挂载到您的 %%VM|vm%%。
       - 从挂载的 ISO 中运行安装程序。
       - 安装 %%VirtIO|virtio%% 驱动程序和 %%QEMU|qemu%% %%Guest Agent|guest-agent%%。
       - 重启虚拟机(%%VM|vm%%)。

    3. **在 Unraid 中配置：**
       - 前往 ***虚拟机*** タブ中的您的虚拟机(%%VM|vm%%)设置。
       - 将 **关机动作** 设置为 **休眠**。
       - 点击 **应用**。
  </TabItem>

  <TabItem value="linux" label="Linux 虚拟机">
    1. **安装 %%QEMU|qemu%% %%Guest Agent|guest-agent%%：**

    ```bash
    # Ubuntu/Debian
    sudo apt install qemu-guest-agent

    # CentOS/RHEL/Fedora
    sudo yum install qemu-guest-agent
    # or
    sudo dnf install qemu-guest-agent
    ```

    2. **启用服务：**
       ```bash
       sudo systemctl enable qemu-guest-agent
       sudo systemctl start qemu-guest-agent
       ```

    3. **在 Unraid 中配置：**
       - 在您的虚拟机(%%VM|vm%%)设置中将 **关机动作** 设置为 **休眠**。
  </TabItem>

  <TabItem value="设备" label="设备虚拟机">
    一些虚拟机(%%VMs|vm%%)，如 Home Assistant，不允许安装额外的软件。对此类虚拟机：

    - 保持 **关机动作** 设定为 **关机**。
    - 使用较长的超时值 (请参见下文的超时建议)。
    - 考虑在更新期间强制关闭这些虚拟机(%%VMs|vm%%)的风险。

    :::note[Why appliance VMs are different]
    Appliance %%VMs|vm%% are designed to run specific software and often don't allow the installation of additional packages, such as %%QEMU|qemu%% %%Guest Agent|guest-agent%%. This means hibernation isn't available, so you'll need to rely on proper timeout configuration.
    :::
  </TabItem>
</Tabs>

现在验证您的休眠功能，启动您的虚拟机(%%VM|vm%%)并打开一些应用程序。然后从 Unraid 停止它。当您再次启动它时，它应该恢复到应用程序仍然打开的状态。

:::warning[Guest 代理是关键]

没有安装 %%QEMU|qemu%% %%Guest Agent|guest-agent%% 时，休眠可能无法正常工作。在这种情况下，虚拟机(%%VM|vm%%)将退回到关机模式，耗尽整个超时时间。

:::

---

### 超时配置

在本节中，我们将介绍如何为不同的系统和过程配置超时信息。这对确保您的虚拟机(%%VMs|vm%%)和 Docker 容器能平滑关闭且无数据丢失至关重要。

| 设置              | 默认值 | 何时增加                            | 配置位置                         |
| --------------- | --- | ------------------------------- | ---------------------------- |
| %%VM\|vm%% 关机超时 | 60秒 | 如果没有使用休眠且虚拟机崩溃则设置为 300s         | ***设置 → 虚拟机管理 → 虚拟机关机（高级）*** |
| Docker 容器停止超时时间 | 10秒 | 如果任何容器在停止时崩溃则设置为 30s            | ***设置 → Docker（高级）***        |
| 通用关机超时时间        | 90秒 | 如果出现不干净关机，设置为 180s，与虚拟机一起 300s+ | ***设置 → 磁盘设置 → 关机超时***       |

:::tip[When 增加超时]

如果您遇到不干净的关机或容器在关机时崩溃的情况，请考虑将通用关机超时时间增加到 **180 秒**（如果您有多个 %%VMs|vm%%，则为 **300+ 秒**）。这将为服务提供更多时间来优雅地关闭。

:::

### 停机顺序

关机时，过程按以下顺序发生：

1. **虚拟机(%%VM|vm%%)关闭：** 这涉及三个阶段，每个阶段可耗尽虚拟机关闭超时：

   - 阶段 1：恢复任何暂停的虚拟机(%%VMs|vm%%)
   - 阶段 2：让配置为休眠状态的虚拟机(%%VMs|vm%%)进入休眠
   - 阶段 3：关闭任何剩余的虚拟机(%%VMs|vm%%)

   每个阶段中的所有虚拟机(%%VMs|vm%%)同时进行处理，这意味着总关闭时间可以计算为：虚拟机关闭超时 × 3。

2. Docker containers stop simultaneously (total time = Docker timeout).

3. Other services include tasks like LXC containers and third-party plugins, which usually take a few seconds.

4. Array shutdown: drives need to be unmounted and data synced; this typically takes 15-30 seconds.

:::tip[Calculate 您的总体关机超时]

**公式：** 您的总体关机超时值应大于：

```
(VM timeout × 3) + (Docker timeout) + (Other services) + 15-30 seconds
```

**示例：** 如果我们按照公式进行，结果如下：`(300 × 3) + 30 + 10 + 30 = 970 秒（超过 16 分钟）`。

**建议：** 至少 **180 秒（3 分钟）** 至少，若您有多个虚拟机(%%VMs|vm%%)或复杂的容器则设置为 **300+ 秒（5+ 分钟）**。

:::

If all your %%VMs|vm%% are set to hibernate rather than shutting down, then the VM timeout is less critical since hibernation is nearly immediate. You could use a lower VM timeout (for example, 60-120 seconds) as a backup for any %%VMs|vm%% that don't support hibernation.

---

### 详细配置指南

本节提供有关不同系统组件的超时配置的深入信息。每个超时设置共同作用以确保您的服务器能平滑关闭且无数据丢失。

#### VM timeouts

Configure VM shutdown timeouts in ***Settings → VM Manager → VM Shutdown*** (enable Advanced view).

**原理:**

- 虚拟机(%%VMs|vm%%)经过三个关闭阶段，每个阶段耗尽虚拟机关闭超时
- 每个阶段中的所有虚拟机(%%VMs|vm%%)同时进行处理
- 总虚拟机关闭时间 = 虚拟机关闭超时 × 3

**常见问题：**

- **Windows 更新中断：** 关机时的更新可能会在超时截止后损坏。
- **未保存的工作：** 提示用户是否保存文档的对话框可能会导致关机无期限中止。
- **休眠失败：** 在没有 %%QEMU|qemu%% %%Guest Agent|guest-agent%% 的情况下，虚拟机(%%VMs|vm%%)可能无法休眠并使用完整的超时时间。

:::tip[VM timeout recommendations]

- **主要建议：** 配置你的虚拟机(%%VMs|vm%%)为休眠状态而不是关机（需要 %%QEMU|qemu%% %%Guest Agent|guest-agent%%）。
- **如果虚拟机在关机时崩溃：** 增加超时至 **300 秒（5 分钟）** 针对 Windows 虚拟机(%%VMs|vm%%)。
- **Windows 更新：** 设定 Windows 在启动时执行更新而不是在关机时。
- **Test your setup:** Manually stop your %%VMs|vm%% to confirm they shut down or hibernate within the timeout period.

:::

:::warning[No safe timeout without hibernation]
Without hibernation and %%QEMU|qemu%% %%Guest Agent|guest-agent%%, there isn't a truly safe timeout for Windows %%VMs|vm%%. Dialog boxes or ongoing update installations could render any timeout inadequate, leading to forced shutdowns and data corruption risk.
:::

#### Docker timeouts

Configure Docker container stop timeouts in ***Settings → Docker*** (enable Advanced view).

**原理:**

- 容器并行停止，因此总时间等于 Docker 停止超时。
- 大多数容器能在 10 秒内停止，但有些可能需要更长的时间。
- 拥有大型数据库或正在进行业务操作的复杂容器可能需要额外时间。
- 如果定时器到期，容器将被强制停止。

:::tip[Docker timeout recommendations]

- **默认 10 秒** 对大多数容器都是足够的。
- **如果容器在停止时崩溃：** 增加超时至 **30 秒**。
- Monitor your containers during shutdown to identify any that consistently need more time.

:::

#### General timeouts

Configure the general shutdown timeout in ***Settings → Disk Settings → Shutdown time-out***.

**UPS considerations (most critical factor):**

- Your UPS must provide enough runtime to complete the full shutdown sequence before battery runs out.
- For **manual shutdown**, you can set longer timeouts since you control when shutdown starts.
- With **power outage shutdown**, your timeout is limited by UPS battery life.
- **Test your UPS** by simulating a power outage to ensure your server shuts down cleanly with time to spare.

:::tip[General timeout recommendations]

- **If you get unclean shutdowns:** Increase to **180 seconds (3 minutes)** for systems without %%VMs|vm%%.
- **For systems with %%VMs|vm%%:** Use **300+ seconds (5+ minutes)** if not using hibernation.
- **If using hibernation:** **180-300 seconds** is usually sufficient.
- Ensure timeouts are not longer than what your UPS can support during a power outage.

:::

#### Third-party services

**LXC containers:**
The LXC plugin has its own timeout setting for stopping containers. Like Docker containers, LXC containers typically stop within a few seconds, but some may require more time. Check the LXC plugin settings for the container stop timeout and include this timeout in your general shutdown timeout calculation.

**Other services:**
Some plugins or custom services may have their own shutdown procedures. Refer to the plugin documentation for specific timeout settings and incorporate them into your calculations.

**更新的公式与第三方服务：**

```
(VM timeout × 3) + (Docker timeout) + (LXC/other timeouts) + 15-30 seconds
```

**Dynamix Stop Shell plugin:**
If you frequently use SSH or terminal sessions, open sessions can prevent clean shutdowns because Unraid waits for them to close before proceeding.

[Dynamix 停止 Shell](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository) 插件通过在停止阵列时自动关闭拖延的 bash 或 SSH 会话来帮助确保及时关机。

您可以从 [社区应用程序（搜索 "Dynamix 停止 Shell"）](https://unraid.net/community/apps/c/tools-system/p2?srsltid=AfmBOoqBXyDNfHxRDCL7Fv9Gcfz8-8CdHmiJSX16PRZpZLLzgQtw2mVk#:~:text=the%20given%20interval.-,Dynamix%20Stop%20Shell,-Dynamix%20Repository) 安装插件。

:::tip[When to use the plugin]

- 如果您经常有终端会话打开。
- 为了防止遗忘的 SSH 会话拖延关机。
- For automated cleanup during shutdown.

:::

:::caution

- 当心如果在终端会话中有脚本或进程运行。
- 确保在关机前没有关键的写入操作正在进行中。
- The plugin will forcefully close sessions, which could interrupt work.

:::
